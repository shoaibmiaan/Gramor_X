===== File #1: lib/env.ts =====
// lib/env.ts
import { z } from 'zod';

const envSchema = z.object({
  // Public (client) vars
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  NEXT_PUBLIC_BASE_URL: z.string().url().optional(),
  NEXT_PUBLIC_IDLE_TIMEOUT_MINUTES: z.coerce.number().default(30),
  NEXT_PUBLIC_DEBUG: z.string().optional(),
  NEXT_PUBLIC_SITE_URL: z.string().url().optional(),

  // Feature flags (client)
  NEXT_PUBLIC_FEATURE_TRIAL: z.string().optional(),
  NEXT_PUBLIC_FEATURE_PAYWALL: z.string().optional(),
  NEXT_PUBLIC_FEATURE_REFERRAL: z.string().optional(),
  NEXT_PUBLIC_FEATURE_PARTNER: z.string().optional(),
  NEXT_PUBLIC_FEATURE_PREDICTOR: z.string().optional(),
  NEXT_PUBLIC_FEATURE_CHALLENGE: z.string().optional(),
  NEXT_PUBLIC_FEATURE_AI_COACH: z.string().optional(),
  NEXT_PUBLIC_FEATURE_STUDY_BUDDY: z.string().optional(),
  NEXT_PUBLIC_FEATURE_MISTAKES_BOOK: z.string().optional(),
  NEXT_PUBLIC_FEATURE_WHATSAPP_TASKS: z.string().optional(),
  NEXT_PUBLIC_FEATURE_FLOATING_WIDGET: z.string().optional(),
  NEXT_PUBLIC_FEATURE_COACH: z.string().optional(),
  NEXT_PUBLIC_FEATURE_NOTIFICATIONS: z.string().optional(),
  NEXT_PUBLIC_FEATURE_QUICK_TEN: z.string().optional(),
  NEXT_PUBLIC_FEATURE_AI_ASSIST: z.string().optional(),
  NEXT_PUBLIC_PUSH_PUBLIC_KEY: z.string().optional(),

  // Optional analytics/monitoring
  NEXT_PUBLIC_GA4_ID: z.string().optional(),
  NEXT_PUBLIC_META_PIXEL_ID: z.string().optional(),
  NEXT_PUBLIC_SENTRY_DSN: z.string().optional(),

  // Optional client-side toggles/util
  NEXT_PUBLIC_TWILIO_BYPASS: z.string().optional(),
  NEXT_PUBLIC_PAYMENTS_PROVIDER: z
    .enum(['none', 'stripe', 'easypaisa', 'jazzcash', 'safepay', 'crypto'])
    .optional(),

  // Server-only vars (required in prod)
  SUPABASE_URL: z.string().url(),
  SUPABASE_SERVICE_KEY: z.string().min(1),
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1),

  REVIEW_SHARE_SECRET: z.string().optional(),
  REVIEW_SHARE_TTL_HOURS: z.coerce.number().optional(),

  ADMIN_EMAILS: z.string().optional(),

  GOOGLE_GENERATIVE_AI_API_KEY: z.string().optional(),
  GROQ_API_KEY: z.string().optional(),
  GROQ_MODEL: z.string().optional(),
  OPENAI_API_KEY: z.string().optional(),
  OPENAI_MODEL: z.string().optional(),
  GEMINI_API_KEY: z.string().optional(),
  GEMINI_MODEL: z.string().optional(),
  GX_AI_PROVIDER: z.string().optional(),

  RESEND_API_KEY: z.string().optional(),
  RESEND_FROM_EMAIL: z.string().optional(),

  PREMIUM_MASTER_PIN: z.string().optional(),
  PREMIUM_PIN_HASH: z.string().optional(),
  PREMIUM_PIN_SALT: z.string().optional(),
  PREMIUM_PIN_RATE: z.coerce.number().optional(),
  PREMIUM_PIN_WINDOW_SEC: z.coerce.number().optional(),

  STRIPE_SECRET_KEY: z.string().optional(),
  STRIPE_WEBHOOK_SECRET: z.string().optional(),
  STRIPE_PRICE_STARTER_MONTHLY: z.string().optional(),
  STRIPE_PRICE_STARTER_ANNUAL: z.string().optional(),
  STRIPE_PRICE_BOOSTER_MONTHLY: z.string().optional(),
  STRIPE_PRICE_BOOSTER_ANNUAL: z.string().optional(),
  STRIPE_PRICE_MASTER_MONTHLY: z.string().optional(),
  STRIPE_PRICE_MASTER_ANNUAL: z.string().optional(),

  SPEAKING_DAILY_LIMIT: z.coerce.number().optional(),
  SPEAKING_BUCKET: z.string().optional(),
  LIMIT_FREE_SPEAKING: z.coerce.number().optional(),

  TWILIO_ACCOUNT_SID: z.string().min(1),
  TWILIO_AUTH_TOKEN: z.string().min(1),
  TWILIO_VERIFY_SERVICE_SID: z.string().min(1),
  TWILIO_WHATSAPP_FROM: z.string().min(1),
  TWILIO_BYPASS: z.string().optional(),
  WHATSAPP_TASKS_SIGNING_SECRET: z.string().min(1),

  NEXT_PUBLIC_DEV_PAYMENTS: z.string().optional(),
  EASYPASA_MERCHANT_ID: z.string().optional(),
  EASYPASA_SECRET: z.string().optional(),
  JAZZCASH_MERCHANT_ID: z.string().optional(),
  JAZZCASH_INTEGRITY_SALT: z.string().optional(),
  SAFEPAY_PUBLIC_KEY: z.string().optional(),
  SAFEPAY_SECRET_KEY: z.string().optional(),
  SAFEPAY_ENV: z.enum(['sandbox', 'production']).default('sandbox'),
  SAFEPAY_API_BASE_URL: z.string().url().optional(),
  SAFEPAY_CHECKOUT_BASE_URL: z.string().url().optional(),

  LOCAL_ADMIN_TOKEN: z.string().optional(),
  ADMIN_API_TOKEN: z.string().optional(),
  SITE_URL: z.string().url().optional(),
  PAYMENTS_PROVIDER: z.enum(['none', 'stripe', 'easypaisa', 'jazzcash', 'safepay', 'crypto']).optional(),
  PORT: z.coerce.number().optional(),
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
});

const raw = {
  NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
  NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
  NEXT_PUBLIC_BASE_URL: process.env.NEXT_PUBLIC_BASE_URL,
  NEXT_PUBLIC_IDLE_TIMEOUT_MINUTES: process.env.NEXT_PUBLIC_IDLE_TIMEOUT_MINUTES,
  NEXT_PUBLIC_DEBUG: process.env.NEXT_PUBLIC_DEBUG,
  NEXT_PUBLIC_SITE_URL: process.env.NEXT_PUBLIC_SITE_URL,

  NEXT_PUBLIC_FEATURE_TRIAL: process.env.NEXT_PUBLIC_FEATURE_TRIAL,
  NEXT_PUBLIC_FEATURE_PAYWALL: process.env.NEXT_PUBLIC_FEATURE_PAYWALL,
  NEXT_PUBLIC_FEATURE_REFERRAL: process.env.NEXT_PUBLIC_FEATURE_REFERRAL,
  NEXT_PUBLIC_FEATURE_PARTNER: process.env.NEXT_PUBLIC_FEATURE_PARTNER,
  NEXT_PUBLIC_FEATURE_PREDICTOR: process.env.NEXT_PUBLIC_FEATURE_PREDICTOR,
  NEXT_PUBLIC_FEATURE_CHALLENGE: process.env.NEXT_PUBLIC_FEATURE_CHALLENGE,
  NEXT_PUBLIC_FEATURE_AI_COACH: process.env.NEXT_PUBLIC_FEATURE_AI_COACH,
  NEXT_PUBLIC_FEATURE_STUDY_BUDDY: process.env.NEXT_PUBLIC_FEATURE_STUDY_BUDDY,
  NEXT_PUBLIC_FEATURE_MISTAKES_BOOK: process.env.NEXT_PUBLIC_FEATURE_MISTAKES_BOOK,
  NEXT_PUBLIC_FEATURE_WHATSAPP_TASKS: process.env.NEXT_PUBLIC_FEATURE_WHATSAPP_TASKS,
  NEXT_PUBLIC_FEATURE_FLOATING_WIDGET: process.env.NEXT_PUBLIC_FEATURE_FLOATING_WIDGET,
  NEXT_PUBLIC_FEATURE_COACH: process.env.NEXT_PUBLIC_FEATURE_COACH,
  NEXT_PUBLIC_FEATURE_NOTIFICATIONS: process.env.NEXT_PUBLIC_FEATURE_NOTIFICATIONS,
  NEXT_PUBLIC_FEATURE_QUICK_TEN: process.env.NEXT_PUBLIC_FEATURE_QUICK_TEN,
  NEXT_PUBLIC_FEATURE_AI_ASSIST: process.env.NEXT_PUBLIC_FEATURE_AI_ASSIST,
  NEXT_PUBLIC_PUSH_PUBLIC_KEY: process.env.NEXT_PUBLIC_PUSH_PUBLIC_KEY,

  NEXT_PUBLIC_GA4_ID: process.env.NEXT_PUBLIC_GA4_ID,
  NEXT_PUBLIC_META_PIXEL_ID: process.env.NEXT_PUBLIC_META_PIXEL_ID,
  NEXT_PUBLIC_SENTRY_DSN: process.env.NEXT_PUBLIC_SENTRY_DSN,

  NEXT_PUBLIC_TWILIO_BYPASS: process.env.NEXT_PUBLIC_TWILIO_BYPASS,
  NEXT_PUBLIC_PAYMENTS_PROVIDER: process.env.NEXT_PUBLIC_PAYMENTS_PROVIDER,

  SUPABASE_URL: process.env.SUPABASE_URL,
  SUPABASE_SERVICE_KEY: process.env.SUPABASE_SERVICE_KEY,
  SUPABASE_SERVICE_ROLE_KEY: process.env.SUPABASE_SERVICE_ROLE_KEY,

  REVIEW_SHARE_SECRET: process.env.REVIEW_SHARE_SECRET,
  REVIEW_SHARE_TTL_HOURS: process.env.REVIEW_SHARE_TTL_HOURS,

  ADMIN_EMAILS: process.env.ADMIN_EMAILS,

  GOOGLE_GENERATIVE_AI_API_KEY: process.env.GOOGLE_GENERATIVE_AI_API_KEY,
  GROQ_API_KEY: process.env.GROQ_API_KEY,
  GROQ_MODEL: process.env.GROQ_MODEL,
  OPENAI_API_KEY: process.env.OPENAI_API_KEY,
  OPENAI_MODEL: process.env.OPENAI_MODEL,
  GEMINI_API_KEY: process.env.GEMINI_API_KEY,
  GEMINI_MODEL: process.env.GEMINI_MODEL,
  GX_AI_PROVIDER: process.env.GX_AI_PROVIDER,

  RESEND_API_KEY: process.env.RESEND_API_KEY,
  RESEND_FROM_EMAIL: process.env.RESEND_FROM_EMAIL,

  PREMIUM_MASTER_PIN: process.env.PREMIUM_MASTER_PIN,
  PREMIUM_PIN_HASH: process.env.PREMIUM_PIN_HASH,
  PREMIUM_PIN_SALT: process.env.PREMIUM_PIN_SALT,
  PREMIUM_PIN_RATE: process.env.PREMIUM_PIN_RATE,
  PREMIUM_PIN_WINDOW_SEC: process.env.PREMIUM_PIN_WINDOW_SEC,

  STRIPE_SECRET_KEY: process.env.STRIPE_SECRET_KEY,
  STRIPE_WEBHOOK_SECRET: process.env.STRIPE_WEBHOOK_SECRET,
  STRIPE_PRICE_STARTER_MONTHLY: process.env.STRIPE_PRICE_STARTER_MONTHLY,
  STRIPE_PRICE_STARTER_ANNUAL: process.env.STRIPE_PRICE_STARTER_ANNUAL,
  STRIPE_PRICE_BOOSTER_MONTHLY: process.env.STRIPE_PRICE_BOOSTER_MONTHLY,
  STRIPE_PRICE_BOOSTER_ANNUAL: process.env.STRIPE_PRICE_BOOSTER_ANNUAL,
  STRIPE_PRICE_MASTER_MONTHLY: process.env.STRIPE_PRICE_MASTER_MONTHLY,
  STRIPE_PRICE_MASTER_ANNUAL: process.env.STRIPE_PRICE_MASTER_ANNUAL,

  SPEAKING_DAILY_LIMIT: process.env.SPEAKING_DAILY_LIMIT,
  SPEAKING_BUCKET: process.env.SPEAKING_BUCKET,
  LIMIT_FREE_SPEAKING: process.env.LIMIT_FREE_SPEAKING,

  TWILIO_ACCOUNT_SID: process.env.TWILIO_ACCOUNT_SID,
  TWILIO_AUTH_TOKEN: process.env.TWILIO_AUTH_TOKEN,
  TWILIO_VERIFY_SERVICE_SID: process.env.TWILIO_VERIFY_SERVICE_SID,
  TWILIO_WHATSAPP_FROM: process.env.TWILIO_WHATSAPP_FROM,
  TWILIO_BYPASS: process.env.TWILIO_BYPASS,
  WHATSAPP_TASKS_SIGNING_SECRET: process.env.WHATSAPP_TASKS_SIGNING_SECRET,

  NEXT_PUBLIC_DEV_PAYMENTS: process.env.NEXT_PUBLIC_DEV_PAYMENTS,
  EASYPASA_MERCHANT_ID: process.env.EASYPASA_MERCHANT_ID,
  EASYPASA_SECRET: process.env.EASYPASA_SECRET,
  JAZZCASH_MERCHANT_ID: process.env.JAZZCASH_MERCHANT_ID,
  JAZZCASH_INTEGRITY_SALT: process.env.JAZZCASH_INTEGRITY_SALT,
  SAFEPAY_PUBLIC_KEY: process.env.SAFEPAY_PUBLIC_KEY,
  SAFEPAY_SECRET_KEY: process.env.SAFEPAY_SECRET_KEY,
  SAFEPAY_ENV: process.env.SAFEPAY_ENV,
  SAFEPAY_API_BASE_URL: process.env.SAFEPAY_API_BASE_URL,
  SAFEPAY_CHECKOUT_BASE_URL: process.env.SAFEPAY_CHECKOUT_BASE_URL,

  LOCAL_ADMIN_TOKEN: process.env.LOCAL_ADMIN_TOKEN,
  ADMIN_API_TOKEN: process.env.ADMIN_API_TOKEN,
  SITE_URL: process.env.SITE_URL,
  PAYMENTS_PROVIDER: process.env.PAYMENTS_PROVIDER,
  PORT: process.env.PORT,
  NODE_ENV: process.env.NODE_ENV as any,
};

const skipValidation =
  process.env.SKIP_ENV_VALIDATION === 'true' || raw.NODE_ENV === 'test';

// Vercel sets VERCEL_ENV to 'development' | 'preview' | 'production'
const isProdBuild =
  raw.NODE_ENV === 'production' && process.env.VERCEL_ENV === 'production';

const parsed = envSchema.safeParse(raw);

const globalEnv = globalThis as typeof globalThis & { __envWarnings?: Set<string> };

if (!parsed.success && typeof window === 'undefined') {
  if (skipValidation || !isProdBuild) {
    const warnings = parsed.error.issues
      .map((i) => `${i.path.join('.')}: ${i.message}`)
      .join('\n');

    const message =
      'Skipping strict environment validation (non-prod or SKIP_ENV_VALIDATION=true). Falling back to safe defaults:\n' +
      warnings;

    if (!globalEnv.__envWarnings) {
      globalEnv.__envWarnings = new Set();
    }

    if (!globalEnv.__envWarnings.has(message)) {
      globalEnv.__envWarnings.add(message);
      console.warn(message);
    }
  } else {
    const errors = parsed.error.issues
      .map((i) => `${i.path.join('.')}: ${i.message}`)
      .join('\n');
    console.error('Invalid environment variables:\n' + errors);
    throw new Error('Invalid environment variables');
  }
}

const defaults = {
  NEXT_PUBLIC_SUPABASE_URL: 'http://localhost:54321',
  NEXT_PUBLIC_SUPABASE_ANON_KEY: 'anon_key',
  SUPABASE_URL: 'http://localhost:54321',
  SUPABASE_SERVICE_KEY: 'service_key',
  SUPABASE_SERVICE_ROLE_KEY: 'service_role_key',
  REVIEW_SHARE_SECRET: 'review_share_secret',
  REVIEW_SHARE_TTL_HOURS: 72,
  TWILIO_ACCOUNT_SID: 'ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',
  TWILIO_AUTH_TOKEN: 'auth_token',
  TWILIO_VERIFY_SERVICE_SID: 'VAXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',
  TWILIO_WHATSAPP_FROM: 'whatsapp:+10000000000',
  WHATSAPP_TASKS_SIGNING_SECRET: 'whatsapp_signing_secret',
  PAYMENTS_PROVIDER: 'none',
  NEXT_PUBLIC_PAYMENTS_PROVIDER: 'none',
};

const filteredRaw = Object.fromEntries(
  Object.entries(raw).filter(([, value]) => value !== undefined && value !== null),
);

export const env = parsed.success
  ? parsed.data
  : {
      ...defaults,
      ...filteredRaw,
      NEXT_PUBLIC_IDLE_TIMEOUT_MINUTES: Number(raw.NEXT_PUBLIC_IDLE_TIMEOUT_MINUTES ?? 30),
      REVIEW_SHARE_TTL_HOURS: Number(
        raw.REVIEW_SHARE_TTL_HOURS ?? defaults.REVIEW_SHARE_TTL_HOURS ?? 72,
      ),
    };

export const isBrowser = typeof window !== 'undefined';
export const isServer = !isBrowser;

const hasSupabaseUrlEnv = Boolean(process.env.NEXT_PUBLIC_SUPABASE_URL ?? process.env.SUPABASE_URL);
const hasSupabaseAnonKeyEnv = Boolean(process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY);
const hasSupabaseServiceKeyEnv = Boolean(
  (process.env.SUPABASE_SERVICE_KEY ?? process.env.SUPABASE_SERVICE_ROLE_KEY) ?? '',
);

export const supabaseEnvState = {
  hasUrl: hasSupabaseUrlEnv,
  hasAnonKey: hasSupabaseAnonKeyEnv,
  hasServiceKey: hasSupabaseServiceKeyEnv,
};

export function bool(val?: string, fallback = false) {
  if (val == null) return fallback;
  return ['1', 'true', 'yes', 'on'].includes(String(val).toLowerCase());
}


===== File #2: next.config.mjs =====
// next.config.mjs
import fs from 'node:fs';
import withPWA from 'next-pwa';

// --- Security: CSP ---
const csp = [
  "default-src 'self';",
  "script-src 'self' 'unsafe-inline' 'unsafe-eval' https: https://js.stripe.com https://browser.sentry-cdn.com;",
  "style-src 'self' 'unsafe-inline' https:;",
  "img-src 'self' data: blob: https:;",
  "font-src 'self' data: https:;",
  "connect-src 'self' https: wss:;",
  "frame-src https://js.stripe.com https://*.stripe.com;",
  "object-src 'none';",
  "base-uri 'self';",
  "form-action 'self';",
].join(' ');

// Read Supabase project host if available
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || '';
let supabaseHost = '';
try {
  if (SUPABASE_URL) supabaseHost = new URL(SUPABASE_URL).host;
} catch { /* ignore */ }

const writingBundlePath = new URL('./lib/offline/packages/writing.bundle.json', import.meta.url);
let writingBundleAssets = [];
try {
  const raw = fs.readFileSync(writingBundlePath, 'utf8');
  const parsed = JSON.parse(raw);
  if (Array.isArray(parsed?.assets)) {
    writingBundleAssets = parsed.assets
      .map((asset) => ({ url: asset?.url, revision: asset?.revision }))
      .filter((asset) => typeof asset.url === 'string' && typeof asset.revision === 'string');
  }
} catch {
  writingBundleAssets = [];
}

const baseConfig = {
  experimental: { esmExternals: false },

  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          { key: 'Content-Security-Policy', value: csp },
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
          { key: 'Permissions-Policy', value: 'camera=(), microphone=(), geolocation=()' },
        ],
      },
      {
        source: '/audio/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=86400, s-maxage=604800, stale-while-revalidate=86400',
          },
          { key: 'Accept-Ranges', value: 'bytes' },
          { key: 'Access-Control-Expose-Headers', value: 'Accept-Ranges, Content-Length' },
        ],
      },
      {
        source: '/placement/audio/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=86400, s-maxage=604800, stale-while-revalidate=86400',
          },
          { key: 'Accept-Ranges', value: 'bytes' },
          { key: 'Access-Control-Expose-Headers', value: 'Accept-Ranges, Content-Length' },
        ],
      },
    ];
  },

  async redirects() {
    return [
      {
        source: '/mock-tests',
        destination: '/mock',
        permanent: false,
      },
    ];
  },

  productionBrowserSourceMaps: false,
  eslint: { ignoreDuringBuilds: true },
  typescript: { ignoreBuildErrors: true },

  webpack: (config) => {
    // keep your existing wasm output tweak
    config.output.webassemblyModuleFilename = 'static/wasm/[modulehash].wasm';

    return config;
  },

  // Allow next/image to load from Supabase Storage + common CDNs
  images: {
    remotePatterns: [
      ...new Set(
        [
          '**.supabase.co',
          supabaseHost,
          'lh3.googleusercontent.com',
          'res.cloudinary.com',
          'images.unsplash.com',
        ].filter(Boolean)
      ),
    ].map((hostname) => ({ protocol: 'https', hostname })),
  },
};

export default withPWA({
  dest: 'public',
  disable: process.env.NODE_ENV === 'development',
  register: true,
  skipWaiting: true,
  buildExcludes: [/.*\.map$/, /middleware-manifest\.json$/, /server\/middleware-manifest\.json$/],
  publicExcludes: ['**/*.map'],
  importScripts: ['sw-sync.js', 'sw-patches/push-handler.js'],
})(baseConfig);


===== File #3: pages/api/_middleware/ratelimit.ts =====
import type { NextApiRequest, NextApiResponse } from 'next';

import { applyRateLimit } from '@/lib/limits/rate';

const MATCHERS: Array<{ pattern: RegExp; windowMs: number; max: number }> = [
  { pattern: /^\/api\/ai\/writing\//, windowMs: 60_000, max: 12 },
  { pattern: /^\/api\/ai\/speaking\//, windowMs: 60_000, max: 10 },
  { pattern: /^\/api\/share\//, windowMs: 120_000, max: 8 },
  { pattern: /^\/api\/auth\//, windowMs: 60_000, max: 15 },
];

export async function enforceApiRateLimit(req: NextApiRequest, res: NextApiResponse) {
  const pathname = req.url ?? '';
  const rule = MATCHERS.find((entry) => entry.pattern.test(pathname));
  if (!rule) return true;

  const identifier = `${req.headers['x-forwarded-for'] ?? req.socket.remoteAddress ?? 'unknown'}:${pathname}`;
  const result = await applyRateLimit(
    { route: rule.pattern.source, identifier, userId: (req as any).userId ?? null },
    { windowMs: rule.windowMs, max: rule.max },
  );

  res.setHeader('X-RateLimit-Limit', String(rule.max));
  res.setHeader('X-RateLimit-Remaining', String(Math.max(0, result.remaining)));

  if (result.blocked) {
    if (result.retryAfter) {
      res.setHeader('Retry-After', String(result.retryAfter));
    }
    res.status(429).json({ error: 'Too many requests' });
    return false;
  }

  return true;
}



===== File #4: components/checkout/PaymentOptions.tsx =====
import * as React from 'react';
import { Card } from '@/components/design-system/Card';

export type PaymentMethod = 'jazzcash' | 'easypaisa' | 'safepay' | 'card';

interface Props {
  selected: PaymentMethod;
  onChange: (method: PaymentMethod) => void;
  className?: string;
}

const OPTIONS: Array<{
  value: PaymentMethod;
  label: string;
  sub: string;
  icon: string;
  badge?: 'Local' | 'International';
}> = [
  { value: 'card',      label: 'Card',      sub: 'Visa, MasterCard',           icon: 'fa-credit-card', badge: 'International' },
  { value: 'easypaisa', label: 'Easypaisa', sub: 'Pakistan local payments',    icon: 'fa-mobile',       badge: 'Local' },
  { value: 'jazzcash',  label: 'JazzCash',  sub: 'Pakistan local payments',    icon: 'fa-wallet',       badge: 'Local' },
  { value: 'safepay',   label: 'Safepay',   sub: 'Pakistan local payments',    icon: 'fa-shield-alt',   badge: 'Local' },
];

export const PaymentOptions: React.FC<Props> = ({ selected, onChange, className }) => {
  return (
    <fieldset className={className}>
      <legend className="sr-only">Choose a payment method</legend>

      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
        {OPTIONS.map((opt) => {
          const id = `pay-${opt.value}`;
          const active = selected === opt.value;
          return (
            <label key={opt.value} htmlFor={id} className="group cursor-pointer">
              <input
                id={id}
                type="radio"
                name="payment"
                value={opt.value}
                checked={active}
                onChange={() => onChange(opt.value)}
                className="peer sr-only"
              />
              <Card
                className={[
                  'rounded-xl border bg-card p-4 transition',
                  'hover:border-primary/40',
                  active ? 'ring-2 ring-primary border-primary shadow-sm' : '',
                ].join(' ')}
              >
                <div className="flex items-start gap-3">
                  <div className="w-9 h-9 rounded-full grid place-items-center text-white text-small bg-gradient-to-br from-purpleVibe to-electricBlue">
                    <i className={`fas ${opt.icon}`} aria-hidden="true" />
                  </div>

                  <div className="min-w-0">
                    <div className="text-small font-medium text-foreground flex items-center gap-2">
                      {opt.label}
                      {opt.badge && (
                        <span className={`hidden sm:inline-block rounded-full px-2 py-0.5 text-[10px] border ${
                          opt.badge === 'International'
                            ? 'border-primary/30 text-primary'
                            : 'border-border/60 text-muted-foreground'
                        }`}>
                          {opt.badge}
                        </span>
                      )}
                    </div>
                    <div className="text-caption text-muted-foreground truncate">{opt.sub}</div>
                  </div>
                </div>
              </Card>
            </label>
          );
        })}
      </div>
    </fieldset>
  );
};

export default PaymentOptions;


===== File #5: pages/checkout/index.tsx =====
// pages/checkout/index.tsx
import * as React from 'react';
import Head from 'next/head';
import Link from 'next/link';
import { useRouter } from 'next/router';
import type { NextPage } from 'next';

// ✅ Correct import statements for named exports
import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import { Badge } from '@/components/design-system/Badge';

// Other components
import PlanPicker, { type PlanPickerProps } from '@/components/payments/PlanPicker';
import CheckoutForm from '@/components/payments/CheckoutForm';
import RedeemBox, { type RedeemSuccessPayload } from '@/components/referrals/RedeemBox';
import PromoCodeBox, { type PromoCodeApplyPayload } from '@/components/payments/PromoCodeBox';
import SocialProofStrip from '@/components/marketing/SocialProofStrip';
import {
  PLAN_LABEL,
  PLANS as CANONICAL_PLANS,
  getPlanBillingAmount,
  getPlanDisplayPrice,
  type Cycle,
  type PlanKey,
} from '@/lib/pricing';
import {
  checkPromoEligibility,
  computePromoDiscount,
  findPromoByCode,
  normalizePromoCode,
  type PromoCodeRule,
} from '@/lib/promotions/codes';
import { fetchPromoByCode } from '@/lib/promotions/client';

const toUsdCents = (amount: number) => Math.round(amount * 100);

type PlanRow = {
  key: PlanKey;
  title: string;
  priceMonthly: number;
  priceAnnual: number;
  icon: string;
  mostPopular?: boolean;
  badge?: string;
};

const PLAN_KEYS: readonly PlanKey[] = ['starter', 'booster', 'master'];
const PLAN_ALIAS: Record<string, PlanKey> = {
  starter: 'starter',
  booster: 'booster',
  master: 'master',
  seedling: 'starter',
  rocket: 'booster',
  owl: 'master',
};

const createPlanRow = (key: PlanKey): PlanRow => {
  const plan = CANONICAL_PLANS[key];

  return {
    key,
    title: plan.title,
    priceMonthly: toUsdCents(getPlanDisplayPrice(key, 'monthly')),
    priceAnnual: toUsdCents(getPlanDisplayPrice(key, 'annual')),
    icon: plan.icon,
    mostPopular: plan.mostPopular,
    badge: plan.badge,
  };
};

const PLANS: Record<PlanKey, PlanRow> = {
  starter: createPlanRow('starter'),
  booster: createPlanRow('booster'),
  master: createPlanRow('master'),
};

const fmtUsd = (cents: number) => `$${(cents / 100).toFixed(2)}`;

const CheckoutPage: NextPage = () => {
  const router = useRouter();
  const planParamRaw = router.query.plan;
  const planParam = Array.isArray(planParamRaw) ? planParamRaw[0] : planParamRaw;
  const codeParam = router.query.code ? String(router.query.code) : undefined;
  const promoParam = router.query.promo ? String(router.query.promo) : undefined;
  const cycleQuery = router.query.billingCycle ?? router.query.cycle ?? 'monthly';
  const cycleValue = Array.isArray(cycleQuery) ? cycleQuery[0] : cycleQuery;

  const normalizedPlanParam = planParam ? planParam.toLowerCase() : '';
  const plan = PLAN_ALIAS[normalizedPlanParam];

  const cycleParam = React.useMemo<Cycle>(() => {
    const normalized = (cycleValue ?? '').toString().toLowerCase();
    if (normalized === 'annual' || normalized === 'yearly') {
      return 'annual';
    }
    return 'monthly';
  }, [cycleValue]);

  const selectedPlanData = plan ? PLANS[plan] : undefined;

  const [activeCode, setActiveCode] = React.useState<string | undefined>(codeParam);
  const [activePromo, setActivePromo] = React.useState<PromoCodeRule | null>(null);

  React.useEffect(() => {
    setActiveCode(codeParam);
  }, [codeParam]);

  React.useEffect(() => {
    let aborted = false;
    if (!promoParam) {
      setActivePromo(null);
      return () => {
        aborted = true;
      };
    }
    const normalized = normalizePromoCode(promoParam);
    if (!normalized) {
      setActivePromo(null);
      return () => {
        aborted = true;
      };
    }

    const resolvePromo = async () => {
      const localRule = findPromoByCode(normalized);
      const rule = localRule ?? (await fetchPromoByCode(normalized));
      if (aborted) return;
      if (!rule) {
        setActivePromo(null);
        return;
      }
      const eligibility = checkPromoEligibility(rule, { plan, cycle: cycleParam });
      if (!eligibility.ok) {
        setActivePromo(null);
        return;
      }
      setActivePromo(rule);
    };

    void resolvePromo();

    return () => {
      aborted = true;
    };
  }, [promoParam, plan, cycleParam]);

  const buildQuery = React.useCallback(
    (overrides: Partial<{ plan: PlanKey | null; cycle: Cycle; referral: string | null; promo: string | null }> = {}) => {
      const nextQuery: Record<string, string | string[]> = { ...router.query };
      const nextPlan = overrides.plan === undefined ? plan : overrides.plan;
      const nextCycle = overrides.cycle ?? cycleParam;
      if (nextPlan) {
        nextQuery.plan = nextPlan;
        nextQuery.billingCycle = nextCycle;
      } else {
        delete nextQuery.plan;
        delete nextQuery.billingCycle;
      }
      const nextReferral = overrides.referral === undefined ? activeCode : overrides.referral;
      if (nextReferral) {
        nextQuery.code = nextReferral;
      } else {
        delete nextQuery.code;
      }
      const nextPromo = overrides.promo === undefined ? activePromo?.code : overrides.promo;
      if (nextPromo) {
        nextQuery.promo = nextPromo;
      } else {
        delete nextQuery.promo;
      }
      return nextQuery;
    },
    [router.query, plan, cycleParam, activeCode, activePromo?.code],
  );

  const handleSelect: NonNullable<PlanPickerProps['onSelect']> = (p, c) => {
    const nextQuery = buildQuery({ plan: p, cycle: c });
    void router.push({ pathname: '/checkout', query: nextQuery });
  };

  const handleRedeemSuccess = React.useCallback(
    ({ code }: RedeemSuccessPayload) => {
      setActiveCode(code);
      void router.replace({ pathname: '/checkout', query: buildQuery({ referral: code }) }, undefined, { shallow: true });
    },
    [buildQuery, router],
  );

  const handlePromoApply = React.useCallback(
    ({ rule }: PromoCodeApplyPayload) => {
      const normalized = normalizePromoCode(rule.code);
      setActivePromo(rule);
      void router.replace({ pathname: '/checkout', query: buildQuery({ promo: normalized }) }, undefined, { shallow: true });
    },
    [buildQuery, router],
  );

  const handlePromoClear = React.useCallback(() => {
    setActivePromo(null);
    void router.replace({ pathname: '/checkout', query: buildQuery({ promo: null }) }, undefined, { shallow: true });
  }, [buildQuery, router]);

  const monthlyCents = selectedPlanData
    ? cycleParam === 'monthly'
      ? selectedPlanData.priceMonthly
      : selectedPlanData.priceAnnual
    : 0;
  const billedAnnualTotalCents =
    selectedPlanData && cycleParam === 'annual'
      ? toUsdCents(getPlanBillingAmount(selectedPlanData.key, 'annual'))
      : 0;

  const subtotalCents = selectedPlanData
    ? cycleParam === 'annual'
      ? billedAnnualTotalCents
      : monthlyCents
    : 0;

  const promoDiscountCents = activePromo ? computePromoDiscount(activePromo, subtotalCents) : 0;
  const finalTotalCents = Math.max(subtotalCents - promoDiscountCents, 0);

  return (
    <>
      <Head>
        <title>Checkout — GramorX</title>
      </Head>

      <main className="min-h-screen bg-lightBg text-foreground antialiased dark:bg-gradient-to-br dark:from-dark/80 dark:to-darker/90">
        <div className="py-16">
          <Container className="space-y-10">
            <header className="text-center max-w-3xl mx-auto mb-6">
              <p className="inline-flex items-center gap-2 rounded-full border border-border/60 px-3 py-1 text-caption text-muted-foreground bg-card/60 backdrop-blur supports-[backdrop-filter]:bg-card/40">
                <i className="fas fa-sync-alt text-caption" aria-hidden="true"></i>
                Flexible plans • Cancel anytime
              </p>

              <h1 className="mt-3 text-balance text-h1">
                <span className="text-gradient-primary">{plan ? 'Complete your purchase' : 'Choose your plan'}</span>
              </h1>

              <p className="mt-2 text-body text-muted-foreground">
                {plan
                  ? 'Pay securely to unlock full IELTS modules, AI feedback, and analytics.'
                  : 'Pick a plan below — switch billing cycle and proceed to checkout.'}
              </p>
            </header>

            <div className="mx-auto mb-6">
              <SocialProofStrip />
            </div>

            <div className="mb-6 flex items-center justify-between gap-4">
              <div />
              <Link
                href="/pricing"
                className="rounded-ds border border-border px-3 py-2 text-body hover:bg-muted transition flex items-center gap-2"
              >
                <i className="fas fa-arrow-left text-caption" aria-hidden="true"></i>
                Back to pricing
              </Link>
            </div>

            {!plan ? (
              <>
                <Card className="card-surface rounded-ds-2xl p-8">
                  <PlanPicker
                    onSelect={handleSelect}
                    defaultCycle={cycleParam}
                    className="mt-0"
                    promoCode={activePromo?.code}
                  />
                </Card>

                <div className="mt-8 text-center">
                  <div className="inline-flex flex-col sm:flex-row items-center justify-center gap-4 p-4 bg-muted/50 rounded-ds-xl">
                    <div className="flex items-center gap-2">
                      <i className="fas fa-shield-alt text-accent" aria-hidden="true"></i>
                      <span className="text-caption">Secure payment</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <i className="fas fa-lock text-accent" aria-hidden="true"></i>
                      <span className="text-caption">SSL encryption</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <i className="fas fa-sync-alt text-accent" aria-hidden="true"></i>
                      <span className="text-caption">Cancel anytime</span>
                    </div>
                  </div>
                </div>

                <div className="mt-6">
                  <SocialProofStrip />
                </div>
              </>
            ) : (
              <>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  <div className="lg:col-span-2">
                    <Card className="card-surface rounded-ds-2xl p-8">
                      <div className="flex items-start gap-6">
                        <div className="flex-none">
                          <div className="w-16 h-16 rounded-full flex items-center justify-center text-white text-h2 bg-gradient-to-br from-primary to-electricBlue">
                            <i className={`fas ${selectedPlanData?.icon ?? 'fa-star'}`} aria-hidden="true" />
                          </div>
                        </div>

                        <div className="flex-1">
                          <div className="flex items-center gap-3">
                            <h2 className="text-h3 mb-1">
                              {selectedPlanData?.title ?? PLAN_LABEL[plan]}
                            </h2>
                            {selectedPlanData?.mostPopular && (
                              <Badge variant="info" size="md" className="inline-flex">
                                {selectedPlanData.badge ?? 'MOST POPULAR'}
                              </Badge>
                            )}
                          </div>

                          <p className="text-body text-muted-foreground mb-4">
                            {selectedPlanData
                              ? `${PLAN_LABEL[plan]} — ${cycleParam === 'monthly' ? 'Monthly billing' : 'Annual billing (discounted)'}`
                              : ''}
                          </p>

                          <CheckoutForm
                            plan={plan}
                            billingCycle={cycleParam}
                            referralCode={activeCode}
                            promoCode={activePromo?.code}
                            className=""
                          />
                        </div>
                      </div>
                    </Card>

                    <div className="mt-6 grid gap-4 md:grid-cols-2">
                      <RedeemBox onSuccess={handleRedeemSuccess} initialCode={activeCode} />
                      <PromoCodeBox
                        plan={plan}
                        cycle={cycleParam}
                        amountCents={subtotalCents}
                        onApply={handlePromoApply}
                        onClear={handlePromoClear}
                        applied={activePromo}
                        initialCode={promoParam}
                      />
                    </div>
                  </div>

                  <aside className="w-full">
                    <Card className="card-surface rounded-ds-2xl p-8 sticky top-6">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-h4">Order summary</h3>
                        <span className="text-caption text-muted-foreground">Review</span>
                      </div>

                      <div className="space-y-4 text-body text-muted-foreground">
                        <div className="flex justify-between items-center">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full flex items-center justify-center text-white bg-gradient-to-br from-primary to-electricBlue">
                              <i className={`fas ${selectedPlanData?.icon ?? 'fa-star'}`} aria-hidden="true" />
                            </div>
                            <div>
                              <div className="font-medium text-foreground">{selectedPlanData?.title ?? (plan ? PLAN_LABEL[plan] : 'Select a plan')}</div>
                              <div className="text-caption text-muted-foreground">{cycleParam === 'monthly' ? 'Billed monthly' : 'Billed annually'}</div>
                            </div>
                          </div>

                          {selectedPlanData?.mostPopular && (
                            <div>
                              <Badge variant="info" size="sm" className="inline-flex">
                                {selectedPlanData.badge ?? 'MOST POPULAR'}
                              </Badge>
                            </div>
                          )}
                        </div>

                        <div className="flex justify-between">
                          <span>Price ({cycleParam === 'monthly' ? 'per month' : 'per month, billed annually'})</span>
                          <span className="font-medium text-foreground">{fmtUsd(monthlyCents)}</span>
                        </div>

                        {cycleParam === 'annual' && (
                          <>
                            <div className="flex justify-between">
                              <span>Annual total (12 months)</span>
                              <span className="font-medium text-foreground">{fmtUsd(billedAnnualTotalCents)}</span>
                            </div>
                            <div className="p-3 bg-accent/10 rounded-ds border border-accent/20">
                              <div className="flex items-center gap-2 text-accent">
                                <i className="fas fa-piggy-bank" aria-hidden="true"></i>
                                <span className="text-caption font-medium">You save {fmtUsd((selectedPlanData.priceMonthly * 12) - billedAnnualTotalCents)} compared to monthly billing</span>
                              </div>
                            </div>
                          </>
                        )}

                        {activeCode && (
                          <div className="flex justify-between items-center py-2 border-y border-border/30">
                            <span>Referral code applied</span>
                            <span className="font-mono text-caption bg-muted px-2 py-1 rounded-ds">{activeCode}</span>
                          </div>
                        )}

                        {promoDiscountCents > 0 && activePromo && (
                          <div className="flex justify-between items-center py-2 border-b border-border/30 text-success">
                            <span>Promo discount ({activePromo.code})</span>
                            <span className="font-medium">-{fmtUsd(promoDiscountCents)}</span>
                          </div>
                        )}

                        <div className="pt-3 border-t border-border/50">
                          <div className="flex justify-between text-body mb-1">
                            <span className="text-muted-foreground">Subtotal</span>
                            <span className="font-medium text-foreground">{fmtUsd(subtotalCents)}</span>
                          </div>
                          <div className="flex justify-between text-body">
                            <span className="text-muted-foreground">Taxes (calculated at checkout)</span>
                            <span className="font-medium text-foreground">—</span>
                          </div>
                        </div>

                        <div className="pt-4 border-t border-border/50">
                          <div className="flex justify-between items-center">
                            <span className="text-body font-semibold">Total</span>
                            <span className="text-h4 text-gradient-primary">
                              {fmtUsd(finalTotalCents)}
                            </span>
                          </div>
                          <p className="mt-2 text-caption text-muted-foreground">Final price shown at checkout.</p>
                        </div>
                      </div>

                      <div className="mt-6">
                        <Button
                          variant="secondary"
                          onClick={() => {
                            const nextQuery = buildQuery({ plan: null });
                            void router.push({ pathname: '/checkout', query: nextQuery });
                          }}
                          className="w-full"
                        >
                          <i className="fas fa-arrow-left text-caption mr-2" aria-hidden="true"></i>
                          Change plan
                        </Button>
                      </div>
                    </Card>
                  </aside>
                </div>

                <div className="mt-8 grid grid-cols-1 gap-4 md:grid-cols-3">
                  {[
                    {
                      icon: 'fa-rocket',
                      iconClass: 'text-primary',
                      title: 'Instant access',
                      copy: 'Start immediately after payment',
                    },
                    {
                      icon: 'fa-shield-alt',
                      iconClass: 'text-accent',
                      title: 'Secure payment',
                      copy: '256-bit SSL encryption',
                    },
                    {
                      icon: 'fa-sync-alt',
                      iconClass: 'text-primary',
                      title: 'Cancel anytime',
                      copy: 'No long-term commitment',
                    },
                  ].map(({ icon, iconClass, title, copy }) => (
                    <Card key={title} padding="md" insetBorder className="text-center">
                      <i className={`fas ${icon} mb-2 ${iconClass}`} aria-hidden="true"></i>
                      <h4 className="font-medium text-caption">{title}</h4>
                      <p className="text-caption text-muted-foreground">{copy}</p>
                    </Card>
                  ))}
                </div>

                <div className="mt-6 flex flex-wrap items-center justify-center gap-3 text-caption text-muted-foreground">
                  <Link href="/account/referrals" className="underline-offset-4 hover:underline flex items-center gap-1">
                    <i className="fas fa-ticket-alt text-caption" aria-hidden="true"></i>
                    Don&apos;t have a code? Generate yours
                  </Link>
                  <span>•</span>
                  <Link href="/promotions" className="underline-offset-4 hover:underline flex items-center gap-1">
                    <i className="fas fa-gift text-caption" aria-hidden="true"></i>
                    View active promo codes
                  </Link>
                  <span>•</span>
                  <Link href="/partners" className="underline-offset-4 hover:underline flex items-center gap-1">
                    <i className="fas fa-handshake text-caption" aria-hidden="true"></i>
                    Become a partner
                  </Link>
                  <span>•</span>
                  <Link href="/help" className="underline-offset-4 hover:underline flex items-center gap-1">
                    <i className="fas fa-question-circle text-caption" aria-hidden="true"></i>
                    Need help?
                  </Link>
                </div>
              </>
            )}
          </Container>
        </div>
      </main>
    </>
  );
};

export default CheckoutPage;


===== File #6: lib/payments/index.ts =====
// lib/payments/index.ts
import type { CreateCheckoutBody, CreateCheckoutResponse, PaymentMethod, PlanKey } from '@/types/payments';

export const PLAN_LABEL: Record<PlanKey, string> = {
  starter: 'Seedling',
  booster: 'Rocket',
  master: 'Owl',
};

export async function startCheckout(
  method: PaymentMethod,
  body: CreateCheckoutBody,
): Promise<CreateCheckoutResponse> {
  const payload = {
    plan: body.plan,
    referralCode: body.referralCode,
    cycle: body.billingCycle,
    billingCycle: body.billingCycle,
    provider: method,
    promoCode: body.promoCode,
  };
  const res = await fetch('/api/payments/create-intent', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });
  return (await res.json()) as CreateCheckoutResponse;
}


===== File #7: lib/payments/gateway.ts =====
// lib/payments/gateway.ts
import { env } from '@/lib/env';
import { getPlanBillingAmount, type Cycle, type PlanKey } from '@/lib/pricing';
import { initiateEasypaisa } from '@/lib/payments/easypaisa';
import { initiateJazzCash } from '@/lib/payments/jazzcash';
import { initiateSafepay } from '@/lib/payments/safepay';

const CRYPTO_CHECKOUT_PATH = '/checkout/crypto';

export type PaymentProvider = 'stripe' | 'easypaisa' | 'jazzcash' | 'safepay' | 'crypto';

export type GatewayIntent = Readonly<{
  provider: PaymentProvider;
  url: string;
  sessionId?: string | null;
}>;

export type CreateGatewayIntentInput = Readonly<{
  provider: PaymentProvider;
  plan: PlanKey;
  cycle: Cycle;
  origin: string;
  userId: string;
  referralCode?: string;
  promoCode?: string;
  amountCents: number;
  intentId: string;
  currency: 'USD' | 'PKR';
}>;

export function amountInCents(plan: PlanKey, cycle: Cycle): number {
  const major = getPlanBillingAmount(plan, cycle);
  return Math.round(major * 100);
}

const stripePriceMap: Record<PlanKey, Record<Cycle, string | undefined>> = {
  starter: {
    monthly: env.STRIPE_PRICE_STARTER_MONTHLY,
    annual: env.STRIPE_PRICE_STARTER_ANNUAL,
  },
  booster: {
    monthly: env.STRIPE_PRICE_BOOSTER_MONTHLY,
    annual: env.STRIPE_PRICE_BOOSTER_ANNUAL,
  },
  master: {
    monthly: env.STRIPE_PRICE_MASTER_MONTHLY,
    annual: env.STRIPE_PRICE_MASTER_ANNUAL,
  },
};

async function createStripeCheckout(input: CreateGatewayIntentInput): Promise<GatewayIntent> {
  const priceId = stripePriceMap[input.plan][input.cycle];
  if (!env.STRIPE_SECRET_KEY || !priceId) {
    throw new Error('Stripe not configured');
  }

  // @ts-expect-error dependency may not be installed in all environments
  const Stripe = (await import('stripe')).default ?? (await import('stripe'));
  const stripe = new Stripe(env.STRIPE_SECRET_KEY, { apiVersion: '2024-06-20' });

  const successUrl = `${input.origin}/account/billing?success=1&plan=${input.plan}`;
  const cancelUrl = `${input.origin}/pricing?canceled=1&plan=${input.plan}${
    input.referralCode ? `&code=${encodeURIComponent(input.referralCode)}` : ''
  }${input.promoCode ? `&promo=${encodeURIComponent(input.promoCode)}` : ''}`;

  const session = await stripe.checkout.sessions.create(
    {
      mode: 'subscription',
      success_url: successUrl,
      cancel_url: cancelUrl,
      line_items: [{ price: priceId, quantity: 1 }],
      allow_promotion_codes: true,
      client_reference_id: input.userId,
      metadata: {
        plan: input.plan,
        billingCycle: input.cycle,
        referralCode: input.referralCode || '',
        userId: input.userId,
        promoCode: input.promoCode || '',
      },
      subscription_data: {
        metadata: {
          plan: input.plan,
          billingCycle: input.cycle,
          referralCode: input.referralCode || '',
          userId: input.userId,
          promoCode: input.promoCode || '',
        },
      },
    },
    {
      idempotencyKey: `${input.userId}:${input.plan}:${input.cycle}:${input.referralCode ?? ''}`,
    },
  );

  return { provider: 'stripe', url: session.url ?? successUrl, sessionId: session.id };
}

async function createLocalSession(input: CreateGatewayIntentInput): Promise<GatewayIntent> {
  if (input.provider === 'easypaisa') {
    const session = await initiateEasypaisa(input.origin, input.plan, input.cycle);
    return { provider: 'easypaisa', url: session.url, sessionId: session.sessionId };
  }
  if (input.provider === 'jazzcash') {
    const session = await initiateJazzCash(input.origin, input.plan, input.cycle);
    return { provider: 'jazzcash', url: session.url, sessionId: session.sessionId };
  }
  const session = await initiateSafepay({
    origin: input.origin,
    plan: input.plan,
    cycle: input.cycle,
    amountCents: input.amountCents,
    currency: input.currency,
    intentId: input.intentId,
  });
  return { provider: 'safepay', url: session.url, sessionId: session.sessionId };
}

function createCryptoCheckout(input: CreateGatewayIntentInput): GatewayIntent {
  const params = new URLSearchParams({
    intent: input.intentId,
    plan: input.plan,
    cycle: input.cycle,
    amount: String(input.amountCents),
  });
  if (input.referralCode) {
    params.set('code', input.referralCode);
  }
  if (input.promoCode) {
    params.set('promo', input.promoCode);
  }
  const url = `${input.origin}${CRYPTO_CHECKOUT_PATH}?${params.toString()}`;
  return { provider: 'crypto', url, sessionId: input.intentId };
}

export async function createGatewayIntent(input: CreateGatewayIntentInput): Promise<GatewayIntent> {
  if (input.provider === 'stripe') {
    return createStripeCheckout(input);
  }
  if (input.provider === 'crypto') {
    return createCryptoCheckout(input);
  }
  return createLocalSession(input);
}


===== File #8: types/payments.ts =====
// types/payments.ts
export type PlanKey = 'starter' | 'booster' | 'master';
export type Cycle = 'monthly' | 'annual';
export type PaymentMethod = 'stripe' | 'easypaisa' | 'jazzcash' | 'safepay' | 'crypto';

export type CreateCheckoutBody = Readonly<{
  plan: PlanKey;
  referralCode?: string;
  billingCycle?: Cycle;
  promoCode?: string;
}>;

export type CreateCheckoutResponse =
  | Readonly<{ ok: true; provider: PaymentMethod; url: string; sessionId?: string | null }>
  | Readonly<{ ok: true; manual: true; message: string }>
  | Readonly<{ ok: false; error: string }>;

export type Invoice = Readonly<{
  id: string;
  amount: number; // minor units
  currency: string;
  createdAt: string; // ISO
  hostedInvoiceUrl?: string;
  status: 'paid' | 'open' | 'void' | 'uncollectible';
}>;

export type SubscriptionSummary = Readonly<{
  plan: 'starter' | 'booster' | 'master' | 'free';
  status: 'active' | 'trialing' | 'canceled' | 'incomplete' | 'past_due';
  renewsAt?: string;
  trialEndsAt?: string;
}>;


===== File #9: lib/safepay.ts =====
// lib/safepay.ts
const isProd = (process.env.SAFEPAY_ENV || 'sandbox') === 'production';

export const SAFEPAY = {
  baseUrl: isProd ? 'https://api.getsafepay.com' : 'https://sandbox.api.getsafepay.com',
  publicKey: process.env.SAFEPAY_PUBLIC_KEY || '',
  secretKey: process.env.SAFEPAY_SECRET_KEY || '',
  webhookSecret: process.env.SAFEPAY_WEBHOOK_SECRET || '',
};

export type OrderActionResponse = {
  data?: any; // SafePay returns { data: { tracker, action, ... } }
  status?: { errors: unknown[]; message: string };
};

// Standard headers:
// - Some endpoints accept Bearer (OAuth-style shopper/merchant tokens)
// - Merchant endpoints accept `X-SFPY-MERCHANT-SECRET: <secret>`
// We’ll expose both patterns.
export function authHeaders(opts?: { bearer?: string; useMerchantSecret?: boolean }) {
  const headers: Record<string, string> = { 'Content-Type': 'application/json' };

  if (opts?.bearer) headers.Authorization = `Bearer ${opts.bearer}`;
  if (opts?.useMerchantSecret) headers['X-SFPY-MERCHANT-SECRET'] = SAFEPAY.secretKey;

  return headers;
}

// Helpful: forward location/user-agent hints if available
export function telemetryHeaders(req: import('next').NextApiRequest) {
  const h: Record<string, string> = {};
  const ip =
    (req.headers['x-forwarded-for'] as string)?.split(',')[0]?.trim() ||
    (req.socket?.remoteAddress ?? '');
  const ua = (req.headers['user-agent'] as string) || '';
  if (ip) h['X-SFPY-IP-ADDRESS'] = ip;
  if (ua) h['X-SFPY-USER-AGENT'] = ua;
  return h;
}


===== File #10: lib/payments/safepay.ts =====
import crypto from 'node:crypto';

import { env } from '@/lib/env';
import type { Cycle, PlanKey } from './index';

export type SafepaySession = Readonly<{ url: string; sessionId: string }>;

type InitiateSafepayInput = Readonly<{
  origin: string;
  plan: PlanKey;
  cycle: Cycle;
  amountCents: number;
  currency: 'PKR' | 'USD';
  intentId: string;
}>;

const DEFAULTS = {
  sandbox: {
    apiBase: 'https://sandbox.api.getsafepay.com',
    checkoutBase: 'https://sandbox.api.getsafepay.com/components',
  },
  production: {
    apiBase: 'https://api.getsafepay.com',
    checkoutBase: 'https://getsafepay.com/components',
  },
} as const;

const SAFEPAY_ENV = env.SAFEPAY_ENV === 'production' ? 'production' : 'sandbox';

function getApiBase(): string {
  return env.SAFEPAY_API_BASE_URL || DEFAULTS[SAFEPAY_ENV].apiBase;
}

function getCheckoutBase(): string {
  return env.SAFEPAY_CHECKOUT_BASE_URL || DEFAULTS[SAFEPAY_ENV].checkoutBase;
}

function roundCentsToMajor(cents: number): number {
  return Math.round((cents / 100) * 100) / 100;
}

export function isSafepayConfigured(): boolean {
  return Boolean(env.SAFEPAY_PUBLIC_KEY && env.SAFEPAY_SECRET_KEY);
}

export function devSafepaySession(origin: string, plan: PlanKey, _cycle: Cycle): SafepaySession {
  const sid = `sp_dev_${Date.now()}`;
  return { url: `${origin}/checkout/success?session_id=${sid}&plan=${plan}`, sessionId: sid };
}

function buildCheckoutUrl(sessionId: string, params: { orderId: string; redirectUrl: string; cancelUrl: string }): string {
  const search = new URLSearchParams({
    env: SAFEPAY_ENV,
    beacon: sessionId,
    order_id: params.orderId,
    source: 'custom',
    redirect_url: params.redirectUrl,
    cancel_url: params.cancelUrl,
  });
  return `${getCheckoutBase()}?${search.toString()}`;
}

/** Initiate a Safepay payment session */
export async function initiateSafepay(input: InitiateSafepayInput): Promise<SafepaySession> {
  if (!isSafepayConfigured() || env.NEXT_PUBLIC_DEV_PAYMENTS) {
    return devSafepaySession(input.origin, input.plan, input.cycle);
  }

  const amount = roundCentsToMajor(input.amountCents);
  const response = await fetch(`${getApiBase()}/order/v1/init`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      environment: SAFEPAY_ENV,
      client: env.SAFEPAY_PUBLIC_KEY,
      amount,
      currency: input.currency,
    }),
  });

  if (!response.ok) {
    throw new Error(`Safepay order init failed (${response.status})`);
  }

  const payload = (await response.json()) as { data?: { token?: string; tracker?: string } };
  const sessionId = String(payload?.data?.token || payload?.data?.tracker || '').trim();
  if (!sessionId) {
    throw new Error('Safepay response missing session token');
  }

  const redirectUrl = `${input.origin}/api/payments/webhooks/safepay?plan=${encodeURIComponent(
    input.plan,
  )}&cycle=${encodeURIComponent(input.cycle)}`;
  const cancelUrl = `${input.origin}/pricing?canceled=1&plan=${encodeURIComponent(
    input.plan,
  )}&provider=safepay`;

  return {
    sessionId,
    url: buildCheckoutUrl(sessionId, { orderId: `gx_${input.intentId}`, redirectUrl, cancelUrl }),
  };
}

/** Verify Safepay payment notification/webhook */
export async function verifySafepay(payload: unknown): Promise<boolean> {
  if (!isSafepayConfigured() || env.NEXT_PUBLIC_DEV_PAYMENTS) {
    return true;
  }

  const data = payload as Record<string, unknown> | null;
  const tracker = String((data?.tracker ?? data?.beacon ?? data?.token ?? '') || '').trim();
  const signature = String((data?.sig ?? data?.signature ?? data?.order_signature ?? '') || '').trim();
  if (!tracker || !signature) {
    return false;
  }

  const expected = crypto.createHmac('sha256', env.SAFEPAY_SECRET_KEY as string).update(tracker).digest('hex');
  return expected === signature;
}


===== File #11: pages/api/payments/webhooks/safepay.ts =====
import type { NextApiHandler } from 'next';

import { finalizeLocalPayment } from '@/lib/payments/localWebhook';
import { verifySafepay } from '@/lib/payments/safepay';

export const config = { api: { bodyParser: false } };

async function readBody(req: Parameters<NextApiHandler>[0]): Promise<string> {
  const chunks: Buffer[] = [];
  for await (const chunk of req) {
    chunks.push(typeof chunk === 'string' ? Buffer.from(chunk) : chunk);
  }
  return Buffer.concat(chunks).toString('utf8');
}

const handler: NextApiHandler = async (req, res) => {
  if (req.method !== 'POST') {
    return res.status(405).json({ ok: false, error: 'Method Not Allowed' });
  }

  const raw = await readBody(req);
  const contentType = req.headers['content-type'] ?? '';
  let payload: Record<string, unknown> = {};

  try {
    if (contentType.includes('application/json')) {
      payload = raw ? (JSON.parse(raw) as Record<string, unknown>) : {};
    } else {
      const params = new URLSearchParams(raw);
      payload = Object.fromEntries(params.entries());
    }
  } catch (error) {
    return res.status(400).json({ ok: false, error: 'invalid_body' });
  }

  let verified = false;
  try {
    verified = await verifySafepay(payload);
  } catch (error) {
    return res.status(400).json({ ok: false, error: 'verification_failed' });
  }

  if (!verified) {
    return res.status(400).json({ ok: false, error: 'invalid_signature' });
  }

  const sessionId = String(
    (payload.tracker ?? payload.beacon ?? payload.token ?? payload.orderId ?? payload.order_id ?? '') || '',
  ).trim();
  if (!sessionId) {
    return res.status(400).json({ ok: false, error: 'missing_session' });
  }

  const result = await finalizeLocalPayment('safepay', sessionId);
  if (!result.ok) {
    return res.status(result.status).json({ ok: false, error: result.error });
  }

  const planParam = Array.isArray(req.query.plan) ? req.query.plan[0] : req.query.plan;
  const plan = typeof planParam === 'string' && planParam ? planParam : result.intent.plan_id;
  const successPath = `/checkout/success?session_id=${encodeURIComponent(sessionId)}&plan=${encodeURIComponent(plan)}`;

  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.status(200).send(
    `<!DOCTYPE html><html lang="en"><head><meta http-equiv="refresh" content="0;url=${successPath}" /></head><body><p>Payment confirmed. <a href="${successPath}">Continue to GramorX</a>.</p><script>window.location.href='${successPath}';</script></body></html>`,
  );
};

export default handler;


===== File #12: pages/api/payments/webhook.ts =====
import type { NextApiRequest, NextApiResponse } from 'next';
import { verifyJazzCash } from '@/lib/payments/jazzcash';
import { verifyEasypaisa } from '@/lib/payments/easypaisa';
import { verifyCard } from '@/lib/payments/card';
import { verifySafepay } from '@/lib/payments/safepay';
import { supabaseService } from '@/lib/supabaseService';

type Provider = 'jazzcash' | 'easypaisa' | 'card' | 'safepay';

export default async function webhook(req: NextApiRequest, res: NextApiResponse) {
  if (req.method !== 'POST') return res.status(405).end();

  const provider = (req.query.provider as Provider) || (req.body.provider as Provider);
  let valid = false;
  switch (provider) {
    case 'jazzcash':
      valid = verifyJazzCash(req.body);
      break;
    case 'easypaisa':
      valid = verifyEasypaisa(req.body);
      break;
    case 'card':
      valid = verifyCard(req.body);
      break;
    case 'safepay':
      valid = await verifySafepay(req.body);
      break;
    default:
      return res.status(400).json({ error: 'Unknown provider' });
  }
  if (!valid) return res.status(400).json({ error: 'Invalid signature' });

  const { paymentId, subscriptionId, userId } = req.body;
  if (paymentId) {
    await supabaseService
      .from('payments')
      .update({ status: 'paid', provider, provider_payment_id: paymentId })
      .eq('id', paymentId);
  }
  if (subscriptionId && userId) {
    await supabaseService
      .from('subscriptions')
      .update({ status: 'active' })
      .eq('id', subscriptionId)
      .eq('user_id', userId);
  }
  return res.json({ ok: true });
}


===== File #13: pages/checkout/success.tsx =====
import * as React from 'react';
import Head from 'next/head';
import Link from 'next/link';
import { useRouter } from 'next/router';
import type { NextPage } from 'next';
import { track } from '@/lib/analytics/track';
import { Section } from '@/components/design-system/Section';
import { Container } from '@/components/design-system/Container';

const SuccessPage: NextPage = () => {
  const router = useRouter();
  const sessionId = String(router.query.session_id ?? '');
  const plan = String(router.query.plan ?? 'booster');

  React.useEffect(() => {
    if (sessionId) {
      track('plan_purchased', { providerSessionId: sessionId, plan });
    }
  }, [sessionId, plan]);

  return (
    <>
      <Head><title>Payment Successful</title></Head>
      <main className="min-h-screen bg-background text-foreground">
        <Section>
          <Container className="max-w-3xl text-center">
            <h1 className="mb-2 text-h1 font-semibold">You’re upgraded! 🎉</h1>
            <p className="text-muted-foreground">
              Your subscription is active. You can now access full IELTS modules, AI feedback, and analytics.
            </p>

            <div className="mt-8 grid gap-3 md:grid-cols-3">
              <Link
                href="/dashboard"
                className="rounded-lg bg-primary px-4 py-2 text-center text-primary-foreground hover:opacity-90"
              >
                Go to Dashboard
              </Link>
              <Link
                href="/account/billing"
                className="rounded-lg border border-border px-4 py-2 text-center hover:bg-muted"
              >
                View invoices
              </Link>
              <Link
                href="/account/referrals"
                className="rounded-lg border border-border px-4 py-2 text-center hover:bg-muted"
              >
                Invite a friend (get rewards)
              </Link>
            </div>

            <p className="mt-6 text-small text-muted-foreground">
              If you closed the window accidentally, your receipt will also be emailed.
            </p>
          </Container>
        </Section>
      </main>
    </>
  );
};

export default SuccessPage;


===== File #14: pages/checkout/cancel.tsx =====
import * as React from 'react';
import Head from 'next/head';
import Link from 'next/link';
import { useRouter } from 'next/router';
import type { NextPage } from 'next';
import { Section } from '@/components/design-system/Section';
import { Container } from '@/components/design-system/Container';

const CancelPage: NextPage = () => {
  const router = useRouter();
  const plan = String(router.query.plan ?? 'booster');
  const code = router.query.code ? String(router.query.code) : undefined;

  const retryHref = React.useMemo(() => {
    const params = new URLSearchParams();
    params.set('plan', plan);
    if (code) params.set('code', code);
    return `/checkout?${params.toString()}`;
  }, [plan, code]);

  return (
    <>
      <Head><title>Checkout Canceled</title></Head>
      <main className="min-h-screen bg-background text-foreground">
        <Section>
          <Container className="max-w-3xl text-center">
            <h1 className="mb-2 text-h1 font-semibold">Checkout canceled</h1>
            <p className="text-muted-foreground">
              No worries — your card hasn’t been charged.
            </p>

            <div className="mt-8 inline-flex flex-wrap items-center justify-center gap-3">
              <Link href={retryHref} className="rounded-lg bg-primary px-4 py-2 text-primary-foreground hover:opacity-90">
                Try again
              </Link>
              <Link href="/pricing" className="rounded-lg border border-border px-4 py-2 hover:bg-muted">
                Back to pricing
              </Link>
            </div>
          </Container>
        </Section>
      </main>
    </>
  );
};

export default CancelPage;


