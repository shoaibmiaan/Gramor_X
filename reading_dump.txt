===== File #1: pages/mock/reading/index.tsx =====
// pages/mock/reading/index.tsx
import * as React from 'react';
import Head from 'next/head';
import Link from 'next/link';
import type { GetServerSideProps, NextPage } from 'next';

import { getServerClient } from '@/lib/supabaseServer';
import type { Database } from '@/lib/database.types';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import { Icon } from '@/components/design-system/Icon';

import { ReadingFilterBar } from '@/components/reading/ReadingFilterBar';
import { ReadingForecastPanel } from '@/components/reading/ReadingForecastPanel';
import { AISummaryCard } from '@/components/reading/AISummaryCard';
import { DailyChallengeBanner } from '@/components/reading/daily/DailyChallengeBanner';
import { BandPredictorCard } from '@/components/reading/analytics/BandPredictorCard';
import type { ReadingAttemptSummary } from '@/lib/reading/bandPredictor';
import { computeDailyStreak } from '@/lib/reading/streak';

type ReadingMockListItem = {
  id: string;
  slug: string;
  title: string;
  description: string | null;
  examType: string;
  difficulty: string | null;
  totalQuestions: number;
  totalPassages: number;
  durationSeconds: number;
  tags: string[];
};

type PageProps = {
  tests: ReadingMockListItem[];
  attemptSummaries: ReadingAttemptSummary[];
  streakCurrent: number;
  error?: string;
};

const ReadingMockIndexPage: NextPage<PageProps> = ({
  tests,
  attemptSummaries,
  streakCurrent,
  error,
}) => {
  if (error) {
    return (
      <>
        <Head>
          <title>Error · Reading Mocks · GramorX</title>
        </Head>
        <section className="py-10 bg-background">
          <Container className="max-w-5xl space-y-6">
            <Card className="p-6 text-center space-y-4">
              <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-destructive/10">
                <Icon name="alert-triangle" className="h-6 w-6 text-destructive" />
              </div>
              <h2 className="text-lg font-semibold">Unable to load Reading mocks</h2>
              <p className="text-sm text-muted-foreground">{error}</p>
              <Button asChild>
                <Link href="/">
                  <Icon name="home" className="h-4 w-4 mr-2" />
                  Go Home
                </Link>
              </Button>
            </Card>
          </Container>
        </section>
      </>
    );
  }

  return (
    <>
      <Head>
        <title>Reading Mocks · GramorX</title>
      </Head>
      <Container className="py-8 space-y-8">
        {/* Hero + right rail (design from file 2) */}
        <div className="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1.2fr)]">
          <div className="space-y-4">
            <div className="space-y-2">
              <Badge size="xs" variant="outline">
                Reading Module
              </Badge>
              <h1 className="text-2xl font-semibold tracking-tight">
                Strict IELTS Reading Mock Room
              </h1>
              <p className="text-sm text-muted-foreground max-w-2xl">
                Full-length, exam-style reading tests with proper band scoring, timing
                and analytics. Three full passages, 40 questions, exam-room strict –
                plus AI explanations, daily drills and analytics that actually move your band.
              </p>
            </div>

            <div className="flex flex-wrap items-center gap-3 text-xs">
              <Button asChild size="sm">
                <Link href="/mock/reading/daily">
                  <Icon name="play-circle" className="h-4 w-4 mr-1" />
                  Start daily challenge
                </Link>
              </Button>
              <Badge variant="subtle" className="rounded-ds-xl">
                <Icon name="Sparkles" className="mr-1 h-3 w-3" />
                AI feedback ready
              </Badge>
              <Badge variant="outline" className="rounded-ds-xl">
                Tracks band from each attempt
              </Badge>
              <Badge variant="outline" className="rounded-ds-xl">
                DB-backed · enterprise-safe
              </Badge>
            </div>
          </div>

          <div className="space-y-4">
            <ReadingForecastPanel />
            <AISummaryCard />
          </div>
        </div>

        {/* Daily challenge strip (from file 1) */}
        <DailyChallengeBanner streakCurrent={streakCurrent} />

        {/* Filter bar (from file 2) */}
        <div className="flex items-center justify-between gap-3">
          <div>
            <h2 className="text-sm font-semibold">Available Reading Mocks</h2>
            <p className="text-xs text-muted-foreground">
              Each card maps directly to a row in <code>reading_tests</code>.
            </p>
          </div>
          <ReadingFilterBar className="justify-end" />
        </div>

        {/* Main grid: test cards + right-side power tools / band predictor */}
        <div className="grid gap-4 lg:grid-cols-[minmax(0,2.1fr)_minmax(0,1.4fr)]">
          {/* Tests grid – design from file 2 */}
          <div className="space-y-3">
            {tests.length === 0 ? (
              <Card className="p-6 text-center text-sm text-muted-foreground">
                No reading mocks are active yet. Seed some rows into{' '}
                <code>public.reading_tests</code> and refresh.
              </Card>
            ) : (
              <div className="grid gap-4 md:grid-cols-2">
                {tests.map((t) => (
                  <Card key={t.id} className="flex flex-col p-4 justify-between">
                    <div className="space-y-2">
                      <div className="flex items-center justify-between gap-2">
                        <Badge variant="soft" className="uppercase rounded-ds text-[10px]">
                          {t.examType === 'gt' ? 'General Training' : 'Academic'}
                        </Badge>
                        {t.difficulty && (
                          <Badge variant="subtle" className="rounded-ds text-[10px]">
                            {t.difficulty}
                          </Badge>
                        )}
                      </div>
                      <h3 className="text-sm font-semibold line-clamp-2">{t.title}</h3>
                      {t.description && (
                        <p className="text-xs text-muted-foreground line-clamp-3">
                          {t.description}
                        </p>
                      )}
                      <p className="text-[11px] text-muted-foreground mt-1">
                        {t.totalQuestions} questions · {t.totalPassages} passages ·{' '}
                        {Math.round(t.durationSeconds / 60)} minutes
                      </p>
                      {t.tags?.length > 0 && (
                        <div className="mt-1 flex flex-wrap gap-1">
                          {t.tags.slice(0, 4).map((tag) => (
                            <Badge
                              key={tag}
                              variant="outline"
                              className="rounded-ds text-[10px] px-1.5 py-0.5"
                            >
                              #{tag}
                            </Badge>
                          ))}
                        </div>
                      )}
                    </div>

                    <div className="mt-4 flex items-center justify-between gap-3">
                      <Link href={`/mock/reading/${t.slug}`} className="flex-1">
                        <Button
                          variant="primary"
                          className="w-full rounded-ds-xl text-xs font-semibold"
                        >
                          Enter full mock
                        </Button>
                      </Link>
                      <Button
                        asChild
                        variant="secondary"
                        size="icon"
                        className="rounded-ds"
                        aria-label="View attempts for this test"
                      >
                        <Link
                          href={`/mock/reading/history?test=${encodeURIComponent(t.slug)}`}
                        >
                          <Icon name="History" className="h-4 w-4" />
                        </Link>
                      </Button>
                    </div>
                  </Card>
                ))}
              </div>
            )}
          </div>

          {/* Right side: Band predictor + Power tools (from file 1) */}
          <div className="space-y-3">
            <BandPredictorCard attempts={attemptSummaries} />

            <Card className="p-3 space-y-2 text-xs">
              <p className="text-[11px] font-medium text-muted-foreground uppercase tracking-wide">
                Power tools
              </p>
              <div className="space-y-1.5">
                <Link
                  href="/mock/reading/drill/question-type?type=TFNG"
                  className="flex items-center justify-between rounded-md border px-2 py-1.5 hover:bg-muted/60 transition-colors"
                >
                  <span>Question-type drills</span>
                  <Icon name="target" className="h-3.5 w-3.5" />
                </Link>
                <Link
                  href="/mock/reading/drill/passage?test=any&p=1"
                  className="flex items-center justify-between rounded-md border px-2 py-1.5 hover:bg-muted/60 transition-colors"
                >
                  <span>Single-passage practice</span>
                  <Icon name="file-text" className="h-3.5 w-3.5" />
                </Link>
                <Link
                  href="/mock/reading/drill/speed"
                  className="flex items-center justify-between rounded-md border px-2 py-1.5 hover:bg-muted/60 transition-colors"
                >
                  <span>Speed training modes</span>
                  <Icon name="zap" className="h-3.5 w-3.5" />
                </Link>
                <Link
                  href="/mock/reading/techniques"
                  className="flex items-center justify-between rounded-md border px-2 py-1.5 hover:bg-muted/60 transition-colors"
                >
                  <span>Techniques trainer</span>
                  <Icon name="book-open" className="h-3.5 w-3.5" />
                </Link>
                <Link
                  href="/mock/reading/analytics"
                  className="flex items-center justify-between rounded-md border px-2 py-1.5 hover:bg-muted/60 transition-colors"
                >
                  <span>Analytics & weaknesses</span>
                  <Icon name="activity" className="h-3.5 w-3.5" />
                </Link>
              </div>
            </Card>
          </div>
        </div>
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  try {
    const supabase = getServerClient<Database>(ctx);

    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError) {
      // eslint-disable-next-line no-console
      console.error('reading index auth error', authError);
    }

    // Tests from reading_tests (schema from your latest dump)
    const { data: testsRows, error: testsError } = await supabase
      .from('reading_tests')
      .select(
        'id, slug, title, description, exam_type, difficulty, total_questions, total_passages, duration_seconds, tags, created_at',
      )
      .eq('is_active', true)
      .order('created_at', { ascending: false });

    if (testsError) {
      throw new Error(`Failed to load tests: ${testsError.message}`);
    }

    // Attempts for current user from reading_attempts
    let attemptSummaries: ReadingAttemptSummary[] = [];
    let streakCurrent = 0;

    if (user) {
      const { data: attemptsRows, error: attemptsError } = await supabase
        .from('reading_attempts')
        .select(
          'id, test_id, raw_score, band_score, created_at, reading_tests(total_questions)',
        )
        .eq('user_id', user.id)
        .order('created_at', { ascending: false })
        .limit(50);

      if (attemptsError) {
        throw new Error(`Failed to load attempts: ${attemptsError.message}`);
      }

      const attempts =
        (attemptsRows ?? []) as {
          id: string;
          test_id: string;
          raw_score: number | null;
          band_score: number | null;
          created_at: string;
          reading_tests: { total_questions: number | null } | null;
        }[];

      attemptSummaries = attempts.map((a) => ({
        rawScore: a.raw_score ?? 0,
        totalQuestions: a.reading_tests?.total_questions ?? 40,
        bandScore: a.band_score ?? null,
        createdAt: a.created_at,
      }));

      const { currentStreak } = computeDailyStreak(
        attempts.map((a) => ({ date: a.created_at })),
      );
      streakCurrent = currentStreak;
    }

    const tests: ReadingMockListItem[] =
      testsRows?.map((row) => ({
        id: row.id,
        slug: row.slug,
        title: row.title,
        description: row.description ?? null,
        examType: row.exam_type,
        difficulty: row.difficulty ?? null,
        totalQuestions: row.total_questions ?? 40,
        totalPassages: row.total_passages ?? 3,
        durationSeconds: row.duration_seconds ?? 3600,
        tags: row.tags ?? [],
      })) ?? [];

    return {
      props: {
        tests,
        attemptSummaries,
        streakCurrent,
      },
    };
  } catch (err) {
    // eslint-disable-next-line no-console
    console.error('[reading index] error:', err);
    return {
      props: {
        tests: [],
        attemptSummaries: [],
        streakCurrent: 0,
        error:
          err instanceof Error ? err.message : 'Failed to load Reading mocks',
      },
    };
  }
};

export default ReadingMockIndexPage;

===== File #2: pages/mock/reading/drill/speed.tsx =====
// pages/mock/reading/drill/speed.tsx
import * as React from 'react';
import type { GetServerSideProps, NextPage } from 'next';
import Head from 'next/head';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import Icon from '@/components/design-system/Icon';

import { getServerClient } from '@/lib/supabaseServer';
import type { ReadingPassage, ReadingQuestion, ReadingTest } from '@/lib/reading/types';
import { ReadingExamShell } from '@/components/reading/ReadingExamShell';
import { speedTrainingLevels as rawSpeedLevels } from '@/data/reading/speedTrainingConfigs';

type SpeedLevel = {
  id: string;
  label: string;
  durationMinutes: number;
};

type PageProps = {
  test: ReadingTest | null;
  passages: ReadingPassage[];
  questions: ReadingQuestion[];
  levelId: string;
};

// Normalize / fallback so we never crash if config is missing or empty
const normalizeLevels = (): SpeedLevel[] => {
  if (Array.isArray(rawSpeedLevels) && rawSpeedLevels.length > 0) {
    return rawSpeedLevels as SpeedLevel[];
  }

  // Fallback defaults if your config file is empty / broken
  return [
    { id: 'light', label: 'Light sprint (20 min)', durationMinutes: 20 },
    { id: 'normal', label: 'Exam pace (40 min)', durationMinutes: 40 },
    { id: 'hard', label: 'Pressure cooker (30 min)', durationMinutes: 30 },
  ];
};

const levels = normalizeLevels();

const SpeedTrainingPage: NextPage<PageProps> = ({
  test,
  passages,
  questions,
  levelId,
}) => {
  const level =
    levels.find((l) => l.id === levelId) ??
    levels.find((l) => l.id === 'normal') ??
    levels[0];

  if (!test || !level) {
    return (
      <>
        <Head>
          <title>Reading Speed Training · GramorX</title>
        </Head>
        <section className="py-16">
          <Container className="max-w-3xl">
            <Card className="p-6 text-sm text-muted-foreground">
              No Reading test / speed level found for speed training.
            </Card>
          </Container>
        </section>
      </>
    );
  }

  const speedTest: ReadingTest = {
    ...test,
    durationSeconds: level.durationMinutes * 60,
  };

  return (
    <>
      <Head>
        <title>Speed Training – {level.label} · GramorX</title>
      </Head>

      <section className="py-6 bg-background">
        <Container className="max-w-4xl space-y-3">
          <Card className="p-3 flex items-center justify-between text-xs">
            <div className="flex items-center gap-2">
              <Badge size="xs" variant="outline">
                Speed Training
              </Badge>
              <span className="font-medium">{level.label}</span>
            </div>
            <div className="flex items-center gap-2 text-muted-foreground">
              <Icon name="clock" className="h-3.5 w-3.5" />
              <span>{level.durationMinutes} minutes</span>
            </div>
          </Card>

          <ReadingExamShell test={speedTest} passages={passages} questions={questions} />
        </Container>
      </section>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  const supabase = getServerClient(ctx.req, ctx.res);

  const levelIdRaw = ctx.query.level;

  const defaultLevel =
    levels.find((l) => l.id === 'normal') ?? levels[0];

  const levelId =
    typeof levelIdRaw === 'string'
      ? levelIdRaw
      : defaultLevel.id;

  // pick any reading test for now (later: choose by difficulty)
  const { data: testsRows } = await supabase
    .from('reading_tests')
    .select('*')
    .order('created_at', { ascending: true })
    .limit(1);

  if (!testsRows || !testsRows.length) {
    return {
      props: {
        test: null,
        passages: [],
        questions: [],
        levelId,
      },
    };
  }

  const testRow = testsRows[0];

  const { data: passageRows } = await supabase
    .from('reading_passages')
    .select('*')
    .eq('test_id', testRow.id)
    .order('passage_order', { ascending: true });

  const { data: questionRows } = await supabase
    .from('reading_questions')
    .select('*')
    .eq('test_id', testRow.id)
    .order('question_order', { ascending: true });

  const test: ReadingTest = {
    id: testRow.id,
    slug: testRow.slug,
    title: testRow.title,
    description: testRow.description,
    examType: testRow.exam_type,
    durationSeconds: testRow.duration_seconds ?? 3600,
    createdAt: testRow.created_at,
    updatedAt: testRow.updated_at,
  };

  const passages: ReadingPassage[] =
    (passageRows ?? []).map((row: any) => ({
      id: row.id,
      testId: row.test_id,
      passageOrder: row.passage_order,
      title: row.title,
      subtitle: row.subtitle,
      content: row.content,
      wordCount: row.word_count,
      createdAt: row.created_at,
      updatedAt: row.updated_at,
    })) ?? [];

  const questions: ReadingQuestion[] =
    (questionRows ?? []).map((row: any) => ({
      id: row.id,
      testId: row.test_id,
      passageId: row.passage_id,
      questionOrder: row.question_order,
      questionTypeId: row.question_type_id as any,
      prompt: row.prompt,
      instruction: row.instruction,
      correctAnswer: row.correct_answer as any,
      constraintsJson: (row.constraints_json ?? {}) as Record<string, unknown>,
      tags: row.tags ?? [],
      createdAt: row.created_at,
      updatedAt: row.updated_at,
    })) ?? [];

  return {
    props: {
      test,
      passages,
      questions,
      levelId,
    },
  };
};

export default SpeedTrainingPage;

===== File #3: pages/mock/reading/drill/question-type.tsx =====
// pages/mock/reading/drill/question-type.tsx
import * as React from 'react';
import type { GetServerSideProps, NextPage } from 'next';
import Head from 'next/head';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import Icon from '@/components/design-system/Icon';

import { getServerClient } from '@/lib/supabaseServer';
import type { ReadingQuestion } from '@/lib/reading/types';
import { ReadingQuestionItem } from '@/components/reading/ReadingQuestionItem';

type PageProps = {
  questionTypeId: string;
  questions: ReadingQuestion[];
};

const QuestionTypeDrillPage: NextPage<PageProps> = ({ questionTypeId, questions }) => {
  const [answers, setAnswers] = React.useState<Record<string, string | string[] | null>>({});

  const handleChange = (questionId: string, val: string | string[] | null) => {
    setAnswers((prev) => ({ ...prev, [questionId]: val }));
  };

  return (
    <>
      <Head>
        <title>Question Type Drill – {questionTypeId} · GramorX</title>
      </Head>

      <section className="py-8 bg-background">
        <Container className="max-w-3xl space-y-4">
          <Card className="p-4 flex items-center justify-between gap-3">
            <div className="space-y-1">
              <Badge variant="outline" size="xs">
                Question-type drill
              </Badge>
              <h1 className="text-lg font-semibold tracking-tight">
                {questionTypeId.toUpperCase()} questions
              </h1>
              <p className="text-xs text-muted-foreground">
                Practice only this question type. Try to move quickly but accurately.
              </p>
            </div>
            <Button asChild variant="outline" size="sm">
              <a href="/mock/reading">
                <Icon name="arrow-left" className="h-4 w-4 mr-1" />
                Back to Reading
              </a>
            </Button>
          </Card>

          <div className="space-y-2">
            {questions.map((q) => (
              <ReadingQuestionItem
                key={q.id}
                question={q}
                value={answers[q.id] ?? null}
                onChange={(val) => handleChange(q.id, val)}
              />
            ))}
            {!questions.length && (
              <Card className="p-4 text-xs text-muted-foreground">
                No questions found for this type yet.
              </Card>
            )}
          </div>
        </Container>
      </section>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  const supabase = getServerClient(ctx.req, ctx.res);

  const qt = ctx.query.type;
  const questionTypeId =
    typeof qt === 'string' ? qt : 'TFNG';

  // Just sample 20 questions of this type
  const { data, error } = await supabase
    .from('reading_questions')
    .select('*')
    .eq('question_type_id', questionTypeId)
    .limit(20);

  if (error) {
    // eslint-disable-next-line no-console
    console.error('question-type drill error', error);
  }

  const questions: ReadingQuestion[] =
    (data ?? []).map((row: any) => ({
      id: row.id,
      testId: row.test_id,
      passageId: row.passage_id,
      questionOrder: row.question_order,
      questionTypeId: row.question_type_id as any,
      prompt: row.prompt,
      instruction: row.instruction,
      correctAnswer: row.correct_answer as any,
      constraintsJson: (row.constraints_json ?? {}) as Record<string, unknown>,
      tags: row.tags ?? [],
      createdAt: row.created_at,
      updatedAt: row.updated_at,
    })) ?? [];

  return {
    props: {
      questionTypeId,
      questions,
    },
  };
};

export default QuestionTypeDrillPage;

===== File #4: pages/mock/reading/drill/passage.tsx =====
// pages/mock/reading/drill/passage.tsx
import * as React from 'react';
import type { GetServerSideProps, NextPage } from 'next';
import Head from 'next/head';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import Icon from '@/components/design-system/Icon';

import { getServerClient } from '@/lib/supabaseServer';
import type { ReadingPassage, ReadingQuestion } from '@/lib/reading/types';
import { ReadingPassagePane } from '@/components/reading/ReadingPassagePane';
import { ReadingQuestionItem } from '@/components/reading/ReadingQuestionItem';

type PageProps = {
  passage: ReadingPassage | null;
  questions: ReadingQuestion[];
};

const PassageDrillPage: NextPage<PageProps> = ({ passage, questions }) => {
  const [answers, setAnswers] = React.useState<Record<string, string | string[] | null>>({});

  if (!passage) {
    return (
      <>
        <Head>
          <title>Passage Drill · GramorX</title>
        </Head>
        <section className="py-16">
          <Container className="max-w-3xl">
            <Card className="p-6 text-sm text-muted-foreground">
              No passage found for this drill.
            </Card>
          </Container>
        </section>
      </>
    );
  }

  const handleChange = (questionId: string, val: string | string[] | null) => {
    setAnswers((prev) => ({ ...prev, [questionId]: val }));
  };

  return (
    <>
      <Head>
        <title>Passage Drill – Passage {passage.passageOrder} · GramorX</title>
      </Head>

      <section className="py-8 bg-background">
        <Container className="max-w-4xl space-y-4">
          <Card className="p-4 flex items-center justify-between gap-3">
            <div className="space-y-1">
              <span className="inline-flex items-center gap-2 text-xs text-muted-foreground">
                <Icon name="book-open" className="h-4 w-4" />
                Passage drill
              </span>
              <h1 className="text-lg font-semibold tracking-tight">
                Passage {passage.passageOrder}
                {passage.title ? `: ${passage.title}` : ''}
              </h1>
            </div>
            <Button asChild variant="outline" size="sm">
              <a href="/mock/reading">
                <Icon name="arrow-left" className="h-4 w-4 mr-1" />
                Back to Reading
              </a>
            </Button>
          </Card>

          <div className="grid gap-4 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
            <ReadingPassagePane passage={passage} totalPassages={1} />
            <div className="space-y-2">
              {questions.map((q) => (
                <ReadingQuestionItem
                  key={q.id}
                  question={q}
                  value={answers[q.id] ?? null}
                  onChange={(val) => handleChange(q.id, val)}
                />
              ))}
              {!questions.length && (
                <Card className="p-4 text-xs text-muted-foreground">
                  No questions found for this passage yet.
                </Card>
              )}
            </div>
          </div>
        </Container>
      </section>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  const supabase = getServerClient(ctx.req, ctx.res);

  const testSlug = ctx.query.test;
  const passageOrderRaw = ctx.query.p;
  if (!testSlug || typeof testSlug !== 'string') {
    return { props: { passage: null, questions: [] } };
  }

  const passageOrder = Number(passageOrderRaw ?? 1);

  const { data: testRow } = await supabase
    .from('reading_tests')
    .select('*')
    .eq('slug', testSlug)
    .maybeSingle();

  if (!testRow) {
    return { props: { passage: null, questions: [] } };
  }

  const { data: passageRow } = await supabase
    .from('reading_passages')
    .select('*')
    .eq('test_id', testRow.id)
    .eq('passage_order', passageOrder)
    .maybeSingle();

  if (!passageRow) {
    return { props: { passage: null, questions: [] } };
  }

  const { data: questionRows } = await supabase
    .from('reading_questions')
    .select('*')
    .eq('test_id', testRow.id)
    .eq('passage_id', passageRow.id)
    .order('question_order', { ascending: true });

  const passage: ReadingPassage = {
    id: passageRow.id,
    testId: passageRow.test_id,
    passageOrder: passageRow.passage_order,
    title: passageRow.title,
    subtitle: passageRow.subtitle,
    content: passageRow.content,
    wordCount: passageRow.word_count,
    createdAt: passageRow.created_at,
    updatedAt: passageRow.updated_at,
  };

  const questions: ReadingQuestion[] =
    (questionRows ?? []).map((row: any) => ({
      id: row.id,
      testId: row.test_id,
      passageId: row.passage_id,
      questionOrder: row.question_order,
      questionTypeId: row.question_type_id as any,
      prompt: row.prompt,
      instruction: row.instruction,
      correctAnswer: row.correct_answer as any,
      constraintsJson: (row.constraints_json ?? {}) as Record<string, unknown>,
      tags: row.tags ?? [],
      createdAt: row.created_at,
      updatedAt: row.updated_at,
    })) ?? [];

  return {
    props: {
      passage,
      questions,
    },
  };
};

export default PassageDrillPage;

===== File #5: pages/mock/reading/result/[attemptId].tsx =====
// pages/mock/reading/result/[attemptId].tsx
import * as React from 'react';
import Head from 'next/head';
import type { GetServerSideProps, NextPage } from 'next';
import Link from 'next/link';

import { getServerClient } from '@/lib/supabaseServer';
import type { Database } from '@/lib/database.types';
import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import { Badge } from '@/components/design-system/Badge';
import { Icon } from '@/components/design-system/Icon';
import { ReadingResultSummary } from '@/components/reading/ReadingResultSummary';

type AttemptSummary = {
  id: string;
  rawScore: number | null;
  bandScore: number | null;
  questionCount: number | null;
  durationSeconds: number | null;
  createdAt: string;
};

type TestSummary = {
  id: string;
  slug: string;
  title: string;
  examType: string;
  totalQuestions: number | null;
  durationSeconds: number | null;
};

type PageProps = {
  attempt: AttemptSummary | null;
  test: TestSummary | null;
  isLoggedIn: boolean;
};

const ReadingResultPage: NextPage<PageProps> = ({ attempt, test, isLoggedIn }) => {
  const notFound = !attempt || !test;

  if (notFound) {
    return (
      <>
        <Head>
          <title>Reading result · GramorX</title>
        </Head>
        <Container className="py-10">
          <Card className="mx-auto max-w-xl p-8 space-y-4 text-center">
            <div className="mx-auto flex h-10 w-10 items-center justify-center rounded-full bg-surface-elevated">
              <Icon name="alert-triangle" className="h-5 w-5 text-destructive" />
            </div>

            <p className="text-sm text-foreground">
              {isLoggedIn
                ? "We couldn’t find your attempt. Please try the test again."
                : 'You need to be logged in to view this result.'}
            </p>

            <div className="flex flex-wrap items-center justify-center gap-3 pt-1">
              {!isLoggedIn && (
                <Button asChild size="sm">
                  <Link href="/login?role=student">
                    <Icon name="log-in" className="h-4 w-4 mr-1" />
                    Log in
                  </Link>
                </Button>
              )}
              <Button asChild size="sm" variant="outline">
                <Link href="/mock/reading">
                  <Icon name="arrow-left" className="h-4 w-4 mr-1" />
                  Back to Reading mocks
                </Link>
              </Button>
            </div>
          </Card>
        </Container>
      </>
    );
  }

  return (
    <>
      <Head>
        <title>
          Result – {test.title} · Reading Mock · GramorX
        </title>
      </Head>
      <Container className="py-10 max-w-4xl space-y-6">
        <div className="flex items-center justify-between gap-3">
          <div>
            <p className="text-xs uppercase tracking-[0.16em] text-muted-foreground">
              Reading mock result
            </p>
            <h1 className="mt-1 text-xl font-semibold tracking-tight">
              {test.title}
            </h1>
            <p className="mt-1 text-xs text-muted-foreground">
              {test.examType === 'gt' ? 'General Training' : 'Academic'} ·{' '}
              {test.totalQuestions ?? attempt.questionCount ?? 40} questions ·{' '}
              {Math.round((test.durationSeconds ?? attempt.durationSeconds ?? 3600) / 60)} minutes
            </p>
          </div>
          <div className="flex flex-col items-end gap-2">
            <Badge variant="soft" className="text-[11px]">
              Attempted on {new Date(attempt.createdAt).toLocaleString()}
            </Badge>
            <div className="flex gap-2">
              <Button asChild size="sm" variant="outline">
                <Link href={`/mock/reading/review/${attempt.id}`}>
                  <Icon name="eye" className="h-4 w-4 mr-1" />
                  Review answers
                </Link>
              </Button>
              <Button asChild size="sm" variant="ghost">
                <Link href="/mock/reading/history">
                  <Icon name="history" className="h-4 w-4 mr-1" />
                  View history
                </Link>
              </Button>
            </div>
          </div>
        </div>

        <ReadingResultSummary attempt={attempt} test={test} />

        <Card className="p-4 text-xs text-muted-foreground space-y-2">
          <p>
            This result is based on IELTS-style band mapping for Reading. Actual exam bands may vary
            slightly, but this gives you a realistic snapshot of where you stand right now.
          </p>
          <p>
            For detailed question-by-question feedback, go to{' '}
            <span className="font-medium">Review answers</span>.
          </p>
        </Card>
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  const attemptIdParam = ctx.params?.attemptId;

  const supabase = getServerClient(ctx.req, ctx.res);

  const {
    data: { user },
  } = await supabase.auth.getUser();

  const isLoggedIn = !!user;

  if (!attemptIdParam || typeof attemptIdParam !== 'string') {
    return {
      props: {
        attempt: null,
        test: null,
        isLoggedIn,
      },
    };
  }

  type AttemptRow = Database['public']['Tables']['reading_attempts']['Row'];
  type TestRow = Database['public']['Tables']['reading_tests']['Row'];

  // 1) get attempt
  const { data: attemptRow, error: attemptError } = await supabase
    .from('reading_attempts')
    .select('*')
    .eq('id', attemptIdParam)
    .maybeSingle<AttemptRow>();

  if (attemptError || !attemptRow) {
    // eslint-disable-next-line no-console
    console.error('reading_result: attempt error', attemptError);
    return {
      props: {
        attempt: null,
        test: null,
        isLoggedIn,
      },
    };
  }

  // extra safety: prevent viewing someone else’s attempt (in case RLS is loose)
  if (user && attemptRow.user_id !== user.id) {
    return {
      props: {
        attempt: null,
        test: null,
        isLoggedIn,
      },
    };
  }

  // 2) get test
  const { data: testRow, error: testError } = await supabase
    .from('reading_tests')
    .select('*')
    .eq('id', attemptRow.test_id)
    .maybeSingle<TestRow>();

  if (testError || !testRow) {
    // eslint-disable-next-line no-console
    console.error('reading_result: test error', testError);
    return {
      props: {
        attempt: null,
        test: null,
        isLoggedIn,
      },
    };
  }

  const attempt: AttemptSummary = {
    id: attemptRow.id,
    rawScore: attemptRow.raw_score,
    bandScore: attemptRow.band_score,
    // table doesn’t have question_count, pull from section_stats if present
    questionCount: (attemptRow.section_stats as any)?.totalQuestions ?? null,
    durationSeconds: attemptRow.duration_seconds,
    createdAt: attemptRow.started_at ?? attemptRow.created_at,
  };

  const test: TestSummary = {
    id: testRow.id,
    slug: testRow.slug,
    title: testRow.title,
    examType: testRow.exam_type,
    totalQuestions: testRow.total_questions,
    durationSeconds: testRow.duration_seconds,
  };

  return {
    props: {
      attempt,
      test,
      isLoggedIn,
    },
  };
};

export default ReadingResultPage;

===== File #6: pages/mock/reading/challenges/index.tsx =====
// pages/mock/reading/challenges/index.tsx
import * as React from 'react';
import type { GetServerSideProps, NextPage } from 'next';
import Head from 'next/head';
import Link from 'next/link';

import { getServerClient } from '@/lib/supabaseServer';
import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import { Icon } from '@/components/design-system/Icon';
import { computeDailyStreak } from '@/lib/reading/streak';

type ChallengeHubProps = {
  streakCurrent: number;
};

const ReadingChallengeHubPage: NextPage<ChallengeHubProps> = ({ streakCurrent }) => {
  return (
    <>
      <Head>
        <title>Reading Challenge Hub · GramorX</title>
      </Head>

      <Container className="py-8 space-y-8">
        {/* Header / Hero */}
        <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div className="space-y-2">
            <Badge size="xs" variant="outline">
              Reading · Challenges
            </Badge>
            <h1 className="text-2xl font-semibold tracking-tight">
              Reading Challenge Hub
            </h1>
            <p className="text-sm text-muted-foreground max-w-2xl">
              Not just full mocks. Mix in speed runs, accuracy drills, question-type
              practice and weekly boss fights so Reading never feels boring.
            </p>

            <div className="flex flex-wrap items-center gap-2 text-xs">
              <Badge variant="subtle" className="rounded-ds-xl">
                <Icon name="zap" className="mr-1 h-3 w-3" />
                Game-style practice
              </Badge>
              <Badge variant="outline" className="rounded-ds-xl">
                Uses your existing Reading engine
              </Badge>
              {streakCurrent > 0 && (
                <Badge
                  variant="subtle"
                  className="rounded-ds-xl flex items-center gap-1"
                >
                  <Icon name="flame" className="h-3 w-3" />
                  {streakCurrent}-day streak in Reading
                </Badge>
              )}
            </div>
          </div>

          <div className="flex flex-wrap gap-2 justify-start md:justify-end">
            <Button asChild size="sm" variant="outline">
              <Link href="/mock/reading">
                <Icon name="book-open" className="mr-2 h-4 w-4" />
                Back to Reading mocks
              </Link>
            </Button>
            <Button asChild size="sm">
              <Link href="/mock/reading/daily">
                <Icon name="play-circle" className="mr-2 h-4 w-4" />
                Jump to today&apos;s challenge
              </Link>
            </Button>
          </div>
        </div>

        {/* Challenges Grid */}
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {/* 1. Daily Challenge */}
          <Card className="flex flex-col p-4 justify-between">
            <div className="space-y-2">
              <div className="flex items-center justify-between gap-2">
                <Badge variant="outline" className="rounded-ds text-[10px] uppercase">
                  Live now
                </Badge>
                <Badge variant="subtle" className="rounded-ds text-[10px]">
                  40 Q · Full test
                </Badge>
              </div>
              <h2 className="text-sm font-semibold">Daily Reading Challenge</h2>
              <p className="text-xs text-muted-foreground">
                One seed-based Reading test per day. Strict timer, band tracking,
                perfect for anchoring your daily routine.
              </p>
            </div>
            <div className="mt-4 flex items-center justify-between gap-3">
              <Button asChild size="sm" className="flex-1 rounded-ds-xl text-xs">
                <Link href="/mock/reading/daily">
                  <Icon name="play" className="mr-2 h-4 w-4" />
                  Start today&apos;s challenge
                </Link>
              </Button>
              <Button
                asChild
                variant="secondary"
                size="icon"
                className="rounded-ds"
                aria-label="View daily challenge history"
              >
                <Link href="/mock/reading/history?mode=daily">
                  <Icon name="history" className="h-4 w-4" />
                </Link>
              </Button>
            </div>
          </Card>

          {/* 2. Speed Challenge */}
          <Card className="flex flex-col p-4 justify-between">
            <div className="space-y-2">
              <div className="flex items-center justify-between gap-2">
                <Badge variant="outline" className="rounded-ds text-[10px] uppercase">
                  New
                </Badge>
                <Badge variant="subtle" className="rounded-ds text-[10px]">
                  3 min · 5 Q
                </Badge>
              </div>
              <h2 className="text-sm font-semibold">Speed Challenge</h2>
              <p className="text-xs text-muted-foreground">
                3-minute micro tests to train quick scanning and skimming. Perfect
                when you&apos;ve only got a few minutes.
              </p>
            </div>
            <div className="mt-4 flex items-center justify-between gap-3">
              <Button
                asChild
                size="sm"
                className="flex-1 rounded-ds-xl text-xs"
              >
                <Link href="/mock/reading/challenges/speed">
                  <Icon name="zap" className="mr-2 h-4 w-4" />
                  Start speed run
                </Link>
              </Button>
              <Badge variant="outline" className="text-[10px] rounded-ds">
                Arcade mode
              </Badge>
            </div>
          </Card>

          {/* 3. Accuracy Drill */}
          <Card className="flex flex-col p-4 justify-between">
            <div className="space-y-2">
              <div className="flex items-center justify-between gap-2">
                <Badge variant="outline" className="rounded-ds text-[10px] uppercase">
                  Focus
                </Badge>
                <Badge variant="subtle" className="rounded-ds text-[10px]">
                  10 Q · 90% target
                </Badge>
              </div>
              <h2 className="text-sm font-semibold">Accuracy Drill (90% Mode)</h2>
              <p className="text-xs text-muted-foreground">
                Short, high-focus sets. Hit 90%+ to clear the drill. Designed to
                punish guess work and reward careful reading.
              </p>
            </div>
            <div className="mt-4 flex items-center justify-between gap-3">
              <Button
                asChild
                size="sm"
                className="flex-1 rounded-ds-xl text-xs"
              >
                <Link href="/mock/reading/challenges/accuracy">
                  <Icon name="target" className="mr-2 h-4 w-4" />
                  Start accuracy drill
                </Link>
              </Button>
              <Badge variant="outline" className="text-[10px] rounded-ds">
                High stakes
              </Badge>
            </div>
          </Card>

          {/* 4. Question-Type Mastery */}
          <Card className="flex flex-col p-4 justify-between">
            <div className="space-y-2">
              <div className="flex items-center justify-between gap-2">
                <Badge variant="outline" className="rounded-ds text-[10px] uppercase">
                  Mastery
                </Badge>
                <Badge variant="subtle" className="rounded-ds text-[10px]">
                  Type-based
                </Badge>
              </div>
              <h2 className="text-sm font-semibold">Question-Type Mastery</h2>
              <p className="text-xs text-muted-foreground">
                Pick a question type – TF/NG, headings, matching, summary completion –
                and grind only that until it feels easy.
              </p>
            </div>
            <div className="mt-4 flex items-center justify-between gap-3">
              <Button
                asChild
                size="sm"
                className="flex-1 rounded-ds-xl text-xs"
              >
                <Link href="/mock/reading/challenges/mastery">
                  <Icon name="layers" className="mr-2 h-4 w-4" />
                  Choose question type
                </Link>
              </Button>
              <Badge variant="outline" className="text-[10px] rounded-ds">
                Weakness killer
              </Badge>
            </div>
          </Card>

          {/* 5. Weekly Boss Challenge */}
          <Card className="flex flex-col p-4 justify-between">
            <div className="space-y-2">
              <div className="flex items-center justify-between gap-2">
                <Badge variant="outline" className="rounded-ds text-[10px] uppercase">
                  Weekly
                </Badge>
                <Badge variant="subtle" className="rounded-ds text-[10px]">
                  20 Q · Event
                </Badge>
              </div>
              <h2 className="text-sm font-semibold">Weekly Boss Challenge</h2>
              <p className="text-xs text-muted-foreground">
                Once-per-week curated challenge to test everything you&apos;ve been
                grinding. Ideal for tracking real improvement.
              </p>
            </div>
            <div className="mt-4 flex items-center justify-between gap-3">
              <Button
                asChild
                size="sm"
                className="flex-1 rounded-ds-xl text-xs"
              >
                <Link href="/mock/reading/challenges/weekly">
                  <Icon name="calendar" className="mr-2 h-4 w-4" />
                  Enter this week&apos;s boss
                </Link>
              </Button>
              <Badge variant="outline" className="text-[10px] rounded-ds">
                Leaderboard-friendly
              </Badge>
            </div>
          </Card>

          {/* 6. History & Analytics */}
          <Card className="flex flex-col p-4 justify-between">
            <div className="space-y-2">
              <div className="flex items-center justify-between gap-2">
                <Badge variant="outline" className="rounded-ds text-[10px] uppercase">
                  Insights
                </Badge>
                <Badge variant="subtle" className="rounded-ds text-[10px]">
                  All modes
                </Badge>
              </div>
              <h2 className="text-sm font-semibold">Challenge History & Analytics</h2>
              <p className="text-xs text-muted-foreground">
                Review all your challenge attempts, see band deltas and spot which
                modes actually push your Reading score up.
              </p>
            </div>
            <div className="mt-4 flex items-center justify-between gap-3">
              <Button
                asChild
                size="sm"
                className="flex-1 rounded-ds-xl text-xs"
              >
                <Link href="/mock/reading/analytics">
                  <Icon name="activity" className="mr-2 h-4 w-4" />
                  Open Reading analytics
                </Link>
              </Button>
              <Button
                asChild
                variant="secondary"
                size="sm"
                className="rounded-ds-xl text-[11px]"
              >
                <Link href="/mock/reading/history">
                  <Icon name="clock" className="mr-1 h-3 w-3" />
                  View all attempts
                </Link>
              </Button>
            </div>
          </Card>
        </div>
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<ChallengeHubProps> = async (
  ctx,
) => {
  try {
    const supabase = getServerClient(ctx.req, ctx.res);

    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return {
        redirect: {
          destination:
            '/login?redirect=' +
            encodeURIComponent(ctx.resolvedUrl ?? '/mock/reading/challenges'),
          permanent: false,
        },
      };
    }

    let streakCurrent = 0;

    const { data: attemptsRows, error: attemptsError } = await supabase
      .from('reading_attempts')
      .select('created_at')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false })
      .limit(90);

    if (!attemptsError && attemptsRows) {
      const { currentStreak } = computeDailyStreak(
        attemptsRows.map((a) => ({ date: a.created_at as string })),
      );
      streakCurrent = currentStreak;
    }

    return {
      props: {
        streakCurrent,
      },
    };
  } catch (err) {
    // fallback: still show hub, just no streak
    // eslint-disable-next-line no-console
    console.error('[reading challenge hub] error:', err);
    return {
      props: {
        streakCurrent: 0,
      },
    };
  }
};

export default ReadingChallengeHubPage;

===== File #7: pages/mock/reading/challenges/weekly.tsx =====
// pages/mock/reading/challenges/weekly.tsx
import * as React from 'react';
import type { NextPage, GetServerSideProps } from 'next';
import Head from 'next/head';
import Link from 'next/link';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import { Badge } from '@/components/design-system/Badge';
import Icon from '@/components/design-system/Icon';

import { getServerClient } from '@/lib/supabaseServer';

type Props = {
  slug: string | null;
  error?: string;
};

const WeeklyReadingChallengePage: NextPage<Props> = ({ slug, error }) => {
  return (
    <>
      <Head>
        <title>Weekly Challenge · Reading · GramorX</title>
      </Head>

      <Container className="py-10 max-w-3xl">
        {error && (
          <Card className="p-6 text-center space-y-4">
            <Icon name="alert-triangle" className="h-8 w-8 text-destructive mx-auto" />
            <p className="text-sm text-muted-foreground">{error}</p>
            <Button asChild>
              <Link href="/mock/reading">
                <Icon name="arrow-left" className="mr-2 h-4 w-4" />
                Back to Reading
              </Link>
            </Button>
          </Card>
        )}

        {!error && slug && (
          <Card className="p-6 space-y-4">
            <Badge size="xs" variant="outline">Weekly Challenge</Badge>

            <h1 className="text-xl font-semibold">Weekly Boss Challenge</h1>
            <p className="text-sm text-muted-foreground">
              A 20-question curated challenge designed to measure your weekly improvement.
            </p>

            <Button asChild size="sm" className="rounded-ds-xl">
              <Link href={`/mock/reading/${slug}?mode=weekly`}>
                <Icon name="calendar" className="mr-2 h-4 w-4" />
                Start Weekly Challenge
              </Link>
            </Button>
          </Card>
        )}
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<Props> = async (ctx) => {
  try {
    const supabase = getServerClient(ctx.req, ctx.res);

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      return {
        redirect: {
          destination: '/login?redirect=' + encodeURIComponent(ctx.resolvedUrl),
          permanent: false
        }
      };
    }

    // This expects weekly_challenges table (optional)
    const thisWeek = new Date();
    const weekNumber = Number(
      new Date(thisWeek.getFullYear(), 0, 1)
        .toISOString()
        .slice(0, 4)
    );

    // For now: fallback = pick any active test
    const { data: row } = await supabase
      .from('reading_tests')
      .select('slug')
      .eq('is_active', true)
      .order('created_at', { ascending: false })
      .limit(1)
      .single();

    if (!row) {
      return {
        props: { slug: null, error: 'No test available for weekly challenge.' }
      };
    }

    return { props: { slug: row.slug } };
  } catch {
    return {
      props: {
        slug: null,
        error: 'Failed to load weekly challenge.'
      }
    };
  }
};

export default WeeklyReadingChallengePage;

===== File #8: pages/mock/reading/challenges/mastery.tsx =====
// pages/mock/reading/challenges/mastery.tsx
import * as React from 'react';
import type { NextPage, GetServerSideProps } from 'next';
import Head from 'next/head';
import Link from 'next/link';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import { Badge } from '@/components/design-system/Badge';
import Icon from '@/components/design-system/Icon';

import { getServerClient } from '@/lib/supabaseServer';

type Props = {
  isAuthed: boolean;
};

const QUESTION_TYPES = [
  { id: 'tfng', label: 'True / False / Not Given' },
  { id: 'heading', label: 'Match the Headings' },
  { id: 'mcq', label: 'Multiple Choice' },
  { id: 'match', label: 'Matching Information' }
];

const MasteryChallengePage: NextPage<Props> = () => {
  return (
    <>
      <Head>
        <title>Mastery Challenge · Reading · GramorX</title>
      </Head>

      <Container className="py-10 max-w-3xl space-y-6">
        <Card className="p-6 space-y-2">
          <Badge size="xs" variant="outline">Mastery Challenge</Badge>
          <h1 className="text-xl font-semibold">Train One Question Type at a Time</h1>
          <p className="text-sm text-muted-foreground">
            Choose a question type. You’ll get 8–12 handpicked questions of ONLY that type.
          </p>
        </Card>

        <div className="grid gap-4 sm:grid-cols-2">
          {QUESTION_TYPES.map((t) => (
            <Card key={t.id} className="p-4 flex flex-col justify-between">
              <div className="space-y-2">
                <h2 className="text-sm font-semibold">{t.label}</h2>
                <p className="text-xs text-muted-foreground">Master {t.label} with focused drills.</p>
              </div>
              <Button asChild size="sm" className="mt-4 rounded-ds-xl">
                <Link href={`/mock/reading/drill/question-type?type=${t.id}`}>
                  <Icon name="layers" className="mr-2 h-4 w-4" />
                  Start {t.label}
                </Link>
              </Button>
            </Card>
          ))}
        </div>
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<Props> = async (ctx) => {
  const supabase = getServerClient(ctx.req, ctx.res);
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return {
      redirect: {
        destination: '/login?redirect=' + encodeURIComponent(ctx.resolvedUrl),
        permanent: false
      }
    };
  }

  return { props: { isAuthed: true } };
};

export default MasteryChallengePage;

===== File #9: pages/mock/reading/challenges/accuracy.tsx =====
// pages/mock/reading/challenges/accuracy.tsx
import * as React from 'react';
import type { NextPage, GetServerSideProps } from 'next';
import Head from 'next/head';
import Link from 'next/link';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import { Badge } from '@/components/design-system/Badge';
import Icon from '@/components/design-system/Icon';

import { getServerClient } from '@/lib/supabaseServer';

type Props = {
  slug: string | null;
  error?: string;
};

const AccuracyChallengePage: NextPage<Props> = ({ slug, error }) => {
  return (
    <>
      <Head>
        <title>Accuracy Drill · Reading · GramorX</title>
      </Head>

      <Container className="py-10 max-w-3xl">
        {error && (
          <Card className="p-6 text-center space-y-3">
            <Icon name="alert-triangle" className="h-8 w-8 text-destructive mx-auto" />
            <p className="text-sm text-muted-foreground">{error}</p>
            <Button asChild>
              <Link href="/mock/reading">
                <Icon name="arrow-left" className="h-4 w-4 mr-2" />
                Back to Reading
              </Link>
            </Button>
          </Card>
        )}

        {!error && slug && (
          <Card className="p-6 space-y-4">
            <Badge size="xs" variant="outline">Accuracy Drill</Badge>

            <h1 className="text-xl font-semibold">90% Accuracy Reading Drill</h1>
            <p className="text-sm text-muted-foreground">
              10 targeted questions. Score 90%+ to clear the drill. Designed to eliminate careless mistakes.
            </p>

            <Button asChild size="sm" className="rounded-ds-xl">
              <Link href={`/mock/reading/${slug}?mode=accuracy`}>
                <Icon name="target" className="mr-2 h-4 w-4" />
                Start Accuracy Drill
              </Link>
            </Button>
          </Card>
        )}
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<Props> = async (ctx) => {
  try {
    const supabase = getServerClient(ctx.req, ctx.res);

    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (!user || authError) {
      return {
        redirect: {
          destination: '/login?redirect=' + encodeURIComponent(ctx.resolvedUrl),
          permanent: false
        }
      };
    }

    const { data: row, error: randomErr } = await supabase
      .from('reading_tests')
      .select('slug')
      .eq('is_active', true)
      .order('created_at', { ascending: false })
      .limit(1)
      .single();

    if (!row || randomErr) {
      return {
        props: {
          slug: null,
          error: 'No test available for accuracy drill.'
        }
      };
    }

    return {
      props: { slug: row.slug }
    };
  } catch {
    return {
      props: {
        slug: null,
        error: 'Failed to load accuracy drill.'
      }
    };
  }
};

export default AccuracyChallengePage;

===== File #10: pages/mock/reading/challenges/speed.tsx =====
// pages/mock/reading/challenges/speed.tsx
import * as React from 'react';
import type { GetServerSideProps, NextPage } from 'next';
import Head from 'next/head';
import Link from 'next/link';
import { useRouter } from 'next/router';

import { getServerClient } from '@/lib/supabaseServer';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import { Icon } from '@/components/design-system/Icon';

type SpeedQuestion = {
  id: string;
  prompt: string;
  instruction: string | null;
  // assuming options is an array of strings; if null, we’ll show a text input
  options: string[] | null;
  correctAnswer: string | null;
};

type PageProps = {
  testTitle: string | null;
  testSlug: string | null;
  questions: SpeedQuestion[];
  error?: string;
};

const DURATION_SECONDS = 180; // 3 minutes

const SpeedChallengePage: NextPage<PageProps> = ({
  testTitle,
  testSlug,
  questions,
  error,
}) => {
  const router = useRouter();
  const [timeLeft, setTimeLeft] = React.useState(DURATION_SECONDS);
  const [started, setStarted] = React.useState(false);
  const [finished, setFinished] = React.useState(false);
  const [answers, setAnswers] = React.useState<Record<string, string>>({});
  const [score, setScore] = React.useState<{
    correct: number;
    total: number;
    attempted: number;
  } | null>(null);

  // Timer
  React.useEffect(() => {
    if (!started || finished) return;
    if (timeLeft <= 0) {
      handleFinish();
      return;
    }

    const timer = setInterval(() => {
      setTimeLeft((prev) => (prev > 0 ? prev - 1 : 0));
    }, 1000);

    return () => clearInterval(timer);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [started, finished, timeLeft]);

  const formatTime = (sec: number) => {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    const mm = m.toString().padStart(2, '0');
    const ss = s.toString().padStart(2, '0');
    return `${mm}:${ss}`;
  };

  const handleAnswerChange = (questionId: string, value: string) => {
    setAnswers((prev) => ({
      ...prev,
      [questionId]: value,
    }));
  };

  const handleStart = () => {
    if (!questions.length) return;
    setStarted(true);
  };

  const handleFinish = () => {
    if (finished) return;

    const total = questions.length;
    let correct = 0;
    let attempted = 0;

    for (const q of questions) {
      const userAns = answers[q.id];
      if (userAns && userAns.trim() !== '') {
        attempted += 1;
      }
      if (
        q.correctAnswer != null &&
        userAns != null &&
        String(userAns).trim().toLowerCase() ===
          String(q.correctAnswer).trim().toLowerCase()
      ) {
        correct += 1;
      }
    }

    setScore({ correct, total, attempted });
    setFinished(true);
    setStarted(false);
  };

  if (error) {
    return (
      <>
        <Head>
          <title>Speed Challenge · Reading · GramorX</title>
        </Head>
        <section className="py-10 bg-background">
          <Container className="max-w-3xl space-y-6">
            <Card className="p-6 text-center space-y-4">
              <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-destructive/10">
                <Icon name="alert-triangle" className="h-6 w-6 text-destructive" />
              </div>
              <h2 className="text-lg font-semibold">Unable to load Speed Challenge</h2>
              <p className="text-sm text-muted-foreground">{error}</p>
              <div className="flex gap-3 justify-center pt-2">
                <Button asChild>
                  <Link href="/mock/reading">
                    <Icon name="arrow-left" className="h-4 w-4 mr-2" />
                    Back to Reading
                  </Link>
                </Button>
              </div>
            </Card>
          </Container>
        </section>
      </>
    );
  }

  const showQuestions = started || finished;

  return (
    <>
      <Head>
        <title>Speed Challenge · Reading Mocks · GramorX</title>
      </Head>
      <Container className="py-8 space-y-8">
        {/* Header */}
        <div className="flex items-center justify-between gap-4">
          <div className="space-y-1">
            <div className="flex items-center gap-2">
              <Button asChild variant="ghost" size="sm" className="h-8 w-8 p-0">
                <Link href="/mock/reading">
                  <Icon name="arrow-left" className="h-4 w-4" />
                </Link>
              </Button>
              <h1 className="text-2xl font-semibold tracking-tight">
                3-Minute Speed Challenge
              </h1>
            </div>
            <p className="text-sm text-muted-foreground">
              Answer as many questions as you can in 3 minutes. Fast, focused Reading practice.
            </p>
          </div>

          <div className="flex items-center gap-3">
            <Card className="px-4 py-2 flex items-center gap-2">
              <Icon
                name={started && !finished ? 'timer' : 'clock'}
                className="h-4 w-4 text-primary"
              />
              <span className="font-mono text-sm font-semibold">
                {formatTime(timeLeft)}
              </span>
            </Card>
          </div>
        </div>

        {/* Info / Summary Card */}
        <Card className="p-4 flex flex-col sm:flex-row items-center justify-between gap-4">
          <div className="space-y-1">
            <Badge size="xs" variant="outline">
              Speed Mode
            </Badge>
            <h2 className="text-sm font-semibold">
              {testTitle || 'Reading question pool'}
            </h2>
            <p className="text-xs text-muted-foreground max-w-md">
              You&apos;ll see up to {questions.length} questions from our Reading pool. Focus on
              accuracy under time pressure. Your score is calculated instantly.
            </p>
          </div>
          <div className="flex flex-col items-end gap-2 text-xs text-muted-foreground">
            <span className="inline-flex items-center gap-1">
              <Icon name="zap" className="h-3 w-3" />
              3 minutes total
            </span>
            <span className="inline-flex items-center gap-1">
              <Icon name="target" className="h-3 w-3" />
              Try to hit 80%+
            </span>
          </div>
        </Card>

        {/* Results */}
        {finished && score && (
          <Card className="p-4 flex flex-col sm:flex-row items-center justify-between gap-4 border-primary/30">
            <div className="space-y-1">
              <div className="flex items-center gap-2">
                <Icon name="trophy" className="h-5 w-5 text-primary" />
                <h3 className="text-sm font-semibold">Your Speed Challenge Result</h3>
              </div>
              <p className="text-xs text-muted-foreground">
                You answered {score.attempted} out of {score.total} questions and got{' '}
                <span className="font-semibold">{score.correct}</span> correct.
              </p>
            </div>
            <div className="flex items-center gap-6 text-xs">
              <div className="text-center">
                <div className="text-lg font-semibold">
                  {score.total > 0
                    ? Math.round((score.correct / score.total) * 100)
                    : 0}
                  %
                </div>
                <div className="text-muted-foreground">Accuracy</div>
              </div>
              <Button
                size="sm"
                variant="outline"
                onClick={() => {
                  // quick restart: hard reload page
                  router.replace(router.asPath);
                }}
              >
                <Icon name="rotate-ccw" className="h-4 w-4 mr-1" />
                Try Another Round
              </Button>
            </div>
          </Card>
        )}

        {/* Questions List */}
        {showQuestions ? (
          <Card className="p-4 space-y-4">
            <div className="flex items-center justify-between">
              <span className="text-sm font-semibold">
                Questions ({questions.length})
              </span>
              {!finished && (
                <Button
                  size="sm"
                  variant="outline"
                  onClick={handleFinish}
                  disabled={finished}
                >
                  <Icon name="flag" className="h-4 w-4 mr-1" />
                  Finish Now
                </Button>
              )}
            </div>

            <div className="space-y-4">
              {questions.map((q, index) => (
                <div
                  key={q.id}
                  className="rounded-ds border p-3 space-y-2 bg-card/40"
                >
                  <div className="flex items-start gap-2">
                    <span className="text-xs font-semibold text-muted-foreground">
                      {index + 1}.
                    </span>
                    <div className="space-y-1">
                      {q.instruction && (
                        <p className="text-[11px] uppercase tracking-wide text-muted-foreground">
                          {q.instruction}
                        </p>
                      )}
                      <p className="text-sm">{q.prompt}</p>
                    </div>
                  </div>

                  {/* Options / Answer Input */}
                  {q.options && q.options.length > 0 ? (
                    <div className="space-y-1 pl-5">
                      {q.options.map((opt, optIndex) => {
                        const value = String.fromCharCode(65 + optIndex); // A, B, C...
                        const selected = answers[q.id] === value;
                        return (
                          <button
                            key={optIndex}
                            type="button"
                            onClick={() => {
                              if (finished) return;
                              handleAnswerChange(q.id, value);
                            }}
                            className={[
                              'w-full text-left text-xs px-3 py-2 rounded-ds border transition',
                              selected
                                ? 'border-primary bg-primary/10'
                                : 'border-border bg-background hover:bg-muted',
                            ].join(' ')}
                          >
                            <span className="font-mono mr-2 text-[11px]">
                              {value}.
                            </span>
                            {opt}
                          </button>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="pl-5">
                      <input
                        type="text"
                        className="w-full text-sm rounded-ds border bg-background px-3 py-2"
                        placeholder="Type your answer..."
                        value={answers[q.id] ?? ''}
                        onChange={(e) =>
                          !finished &&
                          handleAnswerChange(q.id, e.target.value || '')
                        }
                      />
                    </div>
                  )}
                </div>
              ))}
            </div>
          </Card>
        ) : (
          <Card className="p-6 flex flex-col sm:flex-row items-center justify-between gap-4">
            <div className="space-y-1">
              <h3 className="text-sm font-semibold">Ready to go fast?</h3>
              <p className="text-xs text-muted-foreground">
                You&apos;ll get a short burst of Reading questions. Once you hit start, the 3-minute timer begins.
              </p>
            </div>
            <Button size="lg" onClick={handleStart} disabled={!questions.length}>
              <Icon name="play-circle" className="h-5 w-5 mr-2" />
              Start Speed Challenge
            </Button>
          </Card>
        )}
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  try {
    const supabase = getServerClient(ctx.req, ctx.res);

    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return {
        redirect: {
          destination:
            '/login?redirect=' + encodeURIComponent(ctx.resolvedUrl ?? '/mock/reading/challenges/speed'),
          permanent: false,
        },
      };
    }

    // Get one active Reading test to use as the pool source
    const { data: testRow, error: testError } = await supabase
      .from('reading_tests')
      .select('id, slug, title')
      .eq('is_active', true)
      .order('created_at', { ascending: true })
      .limit(1)
      .maybeSingle();

    if (testError || !testRow) {
      return {
        props: {
          testTitle: null,
          testSlug: null,
          questions: [],
          error: 'No active Reading tests available for Speed Challenge.',
        },
      };
    }

    const { data: questionRows, error: questionsError } = await supabase
      .from('reading_questions')
      .select('id, prompt, instruction, options, correct_answer')
      .eq('test_id', testRow.id)
      .order('question_order', { ascending: true })
      .limit(10);

    if (questionsError || !questionRows || questionRows.length === 0) {
      return {
        props: {
          testTitle: testRow.title,
          testSlug: testRow.slug,
          questions: [],
          error: 'No questions found for Speed Challenge.',
        },
      };
    }

    const questions: SpeedQuestion[] = questionRows.map((row: any) => ({
      id: row.id,
      prompt: row.prompt ?? '',
      instruction: row.instruction ?? null,
      options: Array.isArray(row.options) ? (row.options as string[]) : null,
      correctAnswer:
        row.correct_answer != null ? String(row.correct_answer) : null,
    }));

    return {
      props: {
        testTitle: testRow.title,
        testSlug: testRow.slug,
        questions,
      },
    };
  } catch (err) {
    console.error('[speed challenge] error:', err);
    return {
      props: {
        testTitle: null,
        testSlug: null,
        questions: [],
        error:
          err instanceof Error ? err.message : 'Failed to load Speed Challenge.',
      },
    };
  }
};

export default SpeedChallengePage;

===== File #11: pages/mock/reading/daily.tsx =====
// pages/mock/reading/daily/index.tsx
import * as React from 'react';
import Head from 'next/head';
import Link from 'next/link';
import type { GetServerSideProps, NextPage } from 'next';
import { useRouter } from 'next/router';

import { getServerClient } from '@/lib/supabaseServer';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import { Icon } from '@/components/design-system/Icon';

type DailyChallengeTest = {
  id: string;
  slug: string;
  title: string;
  description: string | null;
  examType: string;
  difficulty: string | null;
  totalQuestions: number;
  totalPassages: number;
  durationSeconds: number;
  tags: string[];
  isDailyChallenge: boolean;
  challengeDate: string;
};

type PageProps = {
  dailyTest: DailyChallengeTest | null;
  hasAttemptedToday: boolean;
  streakCurrent: number;
  error?: string;
};

const DailyChallengePage: NextPage<PageProps> = ({
  dailyTest,
  hasAttemptedToday,
  streakCurrent,
  error,
}) => {
  const router = useRouter();

  if (error) {
    return (
      <>
        <Head>
          <title>Error · Daily Challenge · GramorX</title>
        </Head>
        <section className="py-10 bg-background">
          <Container className="max-w-5xl space-y-6">
            <Card className="p-6 text-center space-y-4">
              <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-destructive/10">
                <Icon name="alert-triangle" className="h-6 w-6 text-destructive" />
              </div>
              <h2 className="text-lg font-semibold">Unable to load daily challenge</h2>
              <p className="text-sm text-muted-foreground">{error}</p>
              <div className="flex gap-3 justify-center pt-2">
                <Button asChild>
                  <Link href="/mock/reading">
                    <Icon name="arrow-left" className="h-4 w-4 mr-2" />
                    Back to Reading
                  </Link>
                </Button>
                <Button asChild variant="outline">
                  <Link href="/">
                    <Icon name="home" className="h-4 w-4 mr-2" />
                    Go Home
                  </Link>
                </Button>
              </div>
            </Card>
          </Container>
        </section>
      </>
    );
  }

  const handleStartChallenge = () => {
    if (!dailyTest) return;

    if (hasAttemptedToday) {
      router.push(`/mock/reading/${dailyTest.slug}/review`);
    } else {
      router.push(`/mock/reading/${dailyTest.slug}?daily=true`);
    }
  };

  const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  };

  return (
    <>
      <Head>
        <title>Daily Challenge · Reading Mocks · GramorX</title>
      </Head>
      <Container className="py-8 space-y-8">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div className="space-y-1">
            <div className="flex items-center gap-2">
              <Button asChild variant="ghost" size="sm" className="h-8 w-8 p-0">
                <Link href="/mock/reading">
                  <Icon name="arrow-left" className="h-4 w-4" />
                </Link>
              </Button>
              <h1 className="text-2xl font-semibold tracking-tight">
                Daily Reading Challenge
              </h1>
            </div>
            <p className="text-sm text-muted-foreground">
              Complete today&apos;s special reading passage to maintain your streak
            </p>
          </div>

          <div className="flex items-center gap-3">
            {streakCurrent > 0 && (
              <Badge variant="subtle" className="rounded-ds-xl">
                <Icon name="flame" className="mr-1 h-3 w-3" />
                {streakCurrent} day streak
              </Badge>
            )}
            <Badge variant="outline" className="rounded-ds-xl">
              <Icon name="calendar" className="mr-1 h-3 w-3" />
              {formatDate(new Date().toISOString().split('T')[0])}
            </Badge>
          </div>
        </div>

        {/* Main Content */}
        {dailyTest ? (
          <div className="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1.2fr)]">
            {/* Challenge Card */}
            <Card className="p-6">
              <div className="space-y-6">
                <div className="space-y-3">
                  <div className="flex items-center justify-between gap-2">
                    <Badge variant="outline" className="uppercase rounded-ds text-xs">
                      {dailyTest.examType === 'gt' ? 'General Training' : 'Academic'}
                    </Badge>
                    <div className="flex items-center gap-2">
                      <Badge
                        variant="subtle"
                        className="rounded-ds text-xs bg-primary/10 text-primary"
                      >
                        <Icon name="zap" className="mr-1 h-3 w-3" />
                        Daily Challenge
                      </Badge>
                      {dailyTest.difficulty && (
                        <Badge variant="outline" className="rounded-ds text-xs">
                          {dailyTest.difficulty}
                        </Badge>
                      )}
                    </div>
                  </div>

                  <div className="space-y-2">
                    <h2 className="text-xl font-semibold">{dailyTest.title}</h2>
                    {dailyTest.description && (
                      <p className="text-sm text-muted-foreground">
                        {dailyTest.description}
                      </p>
                    )}
                  </div>

                  <div className="grid grid-cols-3 gap-4 py-4 border-y">
                    <div className="text-center">
                      <div className="text-lg font-semibold">{dailyTest.totalQuestions}</div>
                      <div className="text-xs text-muted-foreground">Questions</div>
                    </div>
                    <div className="text-center">
                      <div className="text-lg font-semibold">{dailyTest.totalPassages}</div>
                      <div className="text-xs text-muted-foreground">Passages</div>
                    </div>
                    <div className="text-center">
                      <div className="text-lg font-semibold">
                        {Math.round(dailyTest.durationSeconds / 60)}
                      </div>
                      <div className="text-xs text-muted-foreground">Minutes</div>
                    </div>
                  </div>

                  {dailyTest.tags?.length > 0 && (
                    <div className="flex flex-wrap gap-2">
                      {dailyTest.tags.map((tag) => (
                        <Badge
                          key={tag}
                          variant="outline"
                          className="rounded-ds text-xs px-2 py-1"
                        >
                          #{tag}
                        </Badge>
                      ))}
                    </div>
                  )}
                </div>

                <div className="pt-4">
                  {hasAttemptedToday ? (
                    <div className="space-y-4">
                      <div className="flex items-center gap-2 text-sm text-muted-foreground">
                        <Icon name="check-circle" className="h-4 w-4 text-green-600" />
                        <span>You&apos;ve already completed today&apos;s challenge!</span>
                      </div>
                      <div className="flex gap-3">
                        <Button
                          onClick={handleStartChallenge}
                          variant="secondary"
                          className="flex-1"
                        >
                          <Icon name="eye" className="h-4 w-4 mr-2" />
                          Review Your Attempt
                        </Button>
                        <Button asChild variant="outline">
                          <Link href="/mock/reading">
                            <Icon name="book-open" className="h-4 w-4 mr-2" />
                            Try Another Mock
                          </Link>
                        </Button>
                      </div>
                    </div>
                  ) : (
                    <Button onClick={handleStartChallenge} size="lg" className="w-full">
                      <Icon name="play-circle" className="h-5 w-5 mr-2" />
                      Start Today&apos;s Challenge
                    </Button>
                  )}
                </div>
              </div>
            </Card>

            {/* Side Panel */}
            <div className="space-y-4">
              <Card className="p-4">
                <h3 className="text-sm font-semibold mb-3">Daily Challenge Rules</h3>
                <ul className="space-y-2 text-sm text-muted-foreground">
                  <li className="flex items-start gap-2">
                    <Icon name="check" className="h-4 w-4 text-green-600 mt-0.5" />
                    <span>One challenge per day resets at midnight UTC</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <Icon name="check" className="h-4 w-4 text-green-600 mt-0.5" />
                    <span>Complete to maintain your streak</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <Icon name="check" className="h-4 w-4 text-green-600 mt-0.5" />
                    <span>AI feedback available after completion</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <Icon name="check" className="h-4 w-4 text-green-600 mt-0.5" />
                    <span>Special bonus for 7+ day streaks</span>
                  </li>
                </ul>
              </Card>

              <Card className="p-4">
                <h3 className="text-sm font-semibold mb-3">Your Progress</h3>
                <div className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm">Current Streak</span>
                    <Badge variant="subtle">{streakCurrent} days</Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm">Today&apos;s Status</span>
                    {hasAttemptedToday ? (
                      <Badge
                        variant="subtle"
                        className="bg-green-500/10 text-green-700"
                      >
                        Completed
                      </Badge>
                    ) : (
                      <Badge
                        variant="subtle"
                        className="bg-amber-500/10 text-amber-700"
                      >
                        Pending
                      </Badge>
                    )}
                  </div>
                  <div className="pt-2">
                    <Button asChild variant="outline" size="sm" className="w-full">
                      <Link href="/mock/reading/history">
                        <Icon name="history" className="h-4 w-4 mr-2" />
                        View Challenge History
                      </Link>
                    </Button>
                  </div>
                </div>
              </Card>
            </div>
          </div>
        ) : (
          <Card className="p-8 text-center">
            <div className="mx-auto w-16 h-16 flex items-center justify-center rounded-full bg-muted mb-4">
              <Icon name="calendar-off" className="h-8 w-8 text-muted-foreground" />
            </div>
            <h3 className="text-lg font-semibold mb-2">No Daily Challenge Available</h3>
            <p className="text-sm text-muted-foreground mb-6 max-w-md mx-auto">
              There&apos;s no daily challenge scheduled for today. Check back tomorrow or try a
              regular reading mock.
            </p>
            <Button asChild>
              <Link href="/mock/reading">
                <Icon name="book-open" className="h-4 w-4 mr-2" />
                Browse Reading Mocks
              </Link>
            </Button>
          </Card>
        )}
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  try {
    const supabase = getServerClient(ctx.req, ctx.res);

    // Get user
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return {
        redirect: {
          destination:
            '/login?redirect=' + encodeURIComponent(ctx.resolvedUrl ?? '/mock/reading/daily'),
          permanent: false,
        },
      };
    }

    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

    // Get today's daily challenge from reading_daily_challenges table (must exist in DB)
    const { data: dailyChallengeRow } = await supabase
      .from('reading_daily_challenges')
      .select(
        `
        id,
        challenge_date,
        test_id,
        reading_tests (
          id,
          slug,
          title,
          description,
          exam_type,
          difficulty,
          total_questions,
          total_passages,
          duration_seconds,
          tags
        )
      `,
      )
      .eq('challenge_date', today)
      .maybeSingle();

    let dailyTest: DailyChallengeTest | null = null;
    let hasAttemptedToday = false;
    let streakCurrent = 0;

    if (dailyChallengeRow && (dailyChallengeRow as any).reading_tests) {
      const test = (dailyChallengeRow as any).reading_tests;
      dailyTest = {
        id: test.id,
        slug: test.slug,
        title: test.title,
        description: test.description,
        examType: test.exam_type,
        difficulty: test.difficulty,
        totalQuestions: test.total_questions ?? 40,
        totalPassages: test.total_passages ?? 3,
        durationSeconds: test.duration_seconds ?? 3600,
        tags: test.tags ?? [],
        isDailyChallenge: true,
        challengeDate: dailyChallengeRow.challenge_date,
      };
    } else {
      // Fallback: get any active test for today
      const { data: randomTest } = await supabase
        .from('reading_tests')
        .select('*')
        .eq('is_active', true)
        .limit(1)
        .maybeSingle();

      if (randomTest) {
        dailyTest = {
          id: randomTest.id,
          slug: randomTest.slug,
          title: randomTest.title,
          description: randomTest.description,
          examType: randomTest.exam_type,
          difficulty: randomTest.difficulty,
          totalQuestions: randomTest.total_questions ?? 40,
          totalPassages: randomTest.total_passages ?? 3,
          durationSeconds: randomTest.duration_seconds ?? 3600,
          tags: randomTest.tags ?? [],
          isDailyChallenge: false,
          challengeDate: today,
        };
      }
    }

    // Check if user has attempted today's challenge
    if (dailyTest) {
      const { data: todayAttempt } = await supabase
        .from('reading_attempts')
        .select('id, created_at')
        .eq('user_id', user.id)
        .eq('test_id', dailyTest.id)
        .gte('created_at', `${today}T00:00:00`)
        .lte('created_at', `${today}T23:59:59`)
        .limit(1);

      hasAttemptedToday = !!(todayAttempt && todayAttempt.length > 0);
    }

    // Very simple streak calculation (can be replaced with your dedicated streak logic)
    const { data: attemptsRows } = await supabase
      .from('reading_attempts')
      .select('created_at')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });

    const uniqueDays = new Set(
      (attemptsRows || []).map((a) =>
        new Date(a.created_at as string).toISOString().split('T')[0],
      ),
    ).size;

    streakCurrent = Math.min(uniqueDays, 30);

    return {
      props: {
        dailyTest,
        hasAttemptedToday,
        streakCurrent,
      },
    };
  } catch (err) {
    console.error('[daily challenge] error:', err);
    return {
      props: {
        dailyTest: null,
        hasAttemptedToday: false,
        streakCurrent: 0,
        error:
          err instanceof Error ? err.message : 'Failed to load daily challenge',
      },
    };
  }
};

export default DailyChallengePage;

===== File #12: pages/mock/reading/feedback/[attemptId].tsx =====
// pages/mock/reading/feedback/[attemptId].tsx
import * as React from 'react';
import Head from 'next/head';
import type { GetServerSideProps, NextPage } from 'next';
import { useRouter } from 'next/router';

import { getServerClient } from '@/lib/supabaseServer';
import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import { Textarea } from '@/components/design-system/Textarea';
import Icon from '@/components/design-system/Icon';

import { supabase } from '@/lib/supabaseClient';

type PageProps = {
  attemptId: string | null;
  allowed: boolean;
};

const ReadingFeedbackPage: NextPage<PageProps> = ({ attemptId, allowed }) => {
  const router = useRouter();
  const [note, setNote] = React.useState('');
  const [submitting, setSubmitting] = React.useState(false);

  if (!allowed || !attemptId) {
    return (
      <>
        <Head>
          <title>Reading Feedback · GramorX</title>
        </Head>
        <Container className="py-10">
          <Card className="mx-auto max-w-xl p-6 text-center space-y-3">
            <div className="mx-auto flex h-10 w-10 items-center justify-center rounded-full bg-surface-elevated">
              <Icon name="lock" className="h-5 w-5 text-muted-foreground" />
            </div>
            <p className="text-sm font-semibold">Feedback not available</p>
            <p className="text-xs text-muted-foreground">
              Either this attempt does not exist, or you are not allowed to attach feedback to it.
            </p>
          </Card>
        </Container>
      </>
    );
  }

  const handleSubmit = async () => {
    if (!note.trim()) {
      alert('Please enter some feedback before submitting.');
      return;
    }
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) {
      alert('Please log in to submit feedback.');
      return;
    }
    setSubmitting(true);
    const { error } = await supabase.from('reading_notes').insert({
      user_id: user.id,
      attempt_id: attemptId,
      note,
    });
    setSubmitting(false);
    if (error) {
      // eslint-disable-next-line no-console
      console.error('note insert error', error);
      alert('Could not save feedback. Please try again.');
      return;
    }
    setNote('');
    alert('Feedback saved. Your coach can see this on your Reading report.');
    router.push(`/mock/reading/result/${attemptId}`);
  };

  return (
    <>
      <Head>
        <title>Attach feedback · Reading · GramorX</title>
      </Head>
      <Container className="py-10 max-w-xl">
        <Card className="p-6 space-y-4">
          <div className="flex items-center justify-between gap-3">
            <div>
              <p className="text-xs uppercase tracking-[0.16em] text-muted-foreground">
                Reading feedback
              </p>
              <h1 className="mt-1 text-lg font-semibold tracking-tight">
                Add a note for this attempt
              </h1>
              <p className="mt-1 text-xs text-muted-foreground">
                This is for you and your coach. Summarise what felt hard, what mistakes you keep
                repeating, and anything you want to remember for next time.
              </p>
            </div>
            <Icon name="message-circle" className="h-6 w-6 text-muted-foreground" />
          </div>

          <div className="space-y-2">
            <label className="text-xs font-medium text-muted-foreground">
              Your feedback
            </label>
            <Textarea
              value={note}
              onChange={(e) => setNote(e.target.value)}
              rows={6}
              placeholder="Example: I kept misreading the TF/NG questions on Passage 2. I also guessed on 3 matching headings..."
            />
            <p className="text-[11px] text-muted-foreground">
              Your note is private to your account and your assigned coach/teacher (if any).
            </p>
          </div>

          <div className="flex justify-end gap-2 pt-1">
            <Button variant="outline" type="button" onClick={() => router.back()}>
              Cancel
            </Button>
            <Button type="button" onClick={handleSubmit} disabled={submitting}>
              {submitting ? 'Saving…' : 'Save feedback'}
            </Button>
          </div>
        </Card>
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  const supabase = getServerClient(ctx.req, ctx.res);
  const attemptIdParam = ctx.params?.attemptId;
  if (typeof attemptIdParam !== 'string') {
    return { notFound: true };
  }
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) {
    return {
      redirect: { destination: '/login?role=student', permanent: false },
    };
  }
  // Fetch attempt, ensure belongs to user
  const { data: attemptRow } = await supabase
    .from('attempts_reading')
    .select('id, user_id')
    .eq('id', attemptIdParam)
    .maybeSingle();

  if (!attemptRow || attemptRow.user_id !== user.id) {
    return {
      props: {
        attemptId: null,
        allowed: false,
      },
    };
  }

  return {
    props: {
      attemptId: attemptRow.id,
      allowed: true,
    },
  };
};

export default ReadingFeedbackPage;

===== File #13: pages/mock/reading/analytics.tsx =====
// pages/mock/reading/analytics.tsx
import * as React from 'react';
import type { GetServerSideProps, NextPage } from 'next';
import Head from 'next/head';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import Icon from '@/components/design-system/Icon';

import { getServerClient } from '@/lib/supabaseServer';

import {
  computeAccuracyByQuestionType,
  computeAttemptsTimeline,
  computeTimePerQuestionStats,
} from '@/lib/reading/analytics';

type AttemptsRow = {
  id: string;
  test_id: string;
  created_at: string;
  raw_score: number | null;
  question_count: number | null;
  duration_seconds: number | null;
  section_stats: any;
};

type QuestionTypeAccuracy = {
  questionTypeId: string;
  questionTypeLabel: string;
  attempts: number;
  accuracy: number;
};

type TimelinePoint = {
  attemptId: string;
  createdAt: string;
  rawScore: number | null;
  questionCount: number | null;
  bandScore: number | null;
};

type TimePerQuestionStat = {
  questionTypeId: string;
  avgSeconds: number | null;
};

type PageProps = {
  hasData: boolean;
  accuracyByType: QuestionTypeAccuracy[];
  timeline: TimelinePoint[];
  timeStats: TimePerQuestionStat[];
};

const ReadingAnalyticsPage: NextPage<PageProps> = ({
  hasData,
  accuracyByType,
  timeline,
  timeStats,
}) => {
  return (
    <>
      <Head>
        <title>Reading Analytics · GramorX</title>
      </Head>
      <section className="py-10 bg-background">
        <Container className="max-w-4xl space-y-6">
          <div className="flex items-center justify-between gap-3">
            <div className="space-y-1">
              <Badge size="xs" variant="outline">
                Analytics
              </Badge>
              <h1 className="text-xl font-semibold tracking-tight">
                Reading analytics & weak spots
              </h1>
              <p className="text-xs text-muted-foreground max-w-xl">
                See which question types are destroying your score, how consistent you are, and
                where to drill next.
              </p>
            </div>
            <Button asChild size="sm" variant="outline">
              <a href="/mock/reading">
                <Icon name="arrow-left" className="h-4 w-4 mr-1" />
                Back to Reading mocks
              </a>
            </Button>
          </div>

          {!hasData && (
            <Card className="p-4 text-sm text-muted-foreground space-y-2">
              <p>You haven’t completed any Reading mock attempts yet.</p>
              <p className="text-xs">
                Do at least one full mock so we can analyse your strengths and weaknesses.
              </p>
            </Card>
          )}

          {hasData && (
            <div className="grid gap-4 md:grid-cols-2">
              <Card className="p-4 space-y-3">
                <div className="flex items-center justify-between">
                  <h2 className="text-sm font-semibold">Accuracy by question type</h2>
                  <Icon name="target" className="h-4 w-4 text-muted-foreground" />
                </div>
                <p className="text-xs text-muted-foreground">
                  This is based on your last few Reading attempts. Focus first on types with many
                  questions and low accuracy.
                </p>
                <div className="mt-2 space-y-2">
                  {accuracyByType.map((row) => (
                    <div key={row.questionTypeId} className="flex items-center justify-between">
                      <div className="flex flex-col">
                        <span className="text-xs font-medium">
                          {row.questionTypeLabel || row.questionTypeId}
                        </span>
                        <span className="text-[11px] text-muted-foreground">
                          {row.attempts} questions
                        </span>
                      </div>
                      <span className="text-xs font-semibold">
                        {row.accuracy.toFixed(0)}%
                      </span>
                    </div>
                  ))}
                  {!accuracyByType.length && (
                    <p className="text-xs text-muted-foreground">
                      Not enough data yet. Do a few more strict mocks.
                    </p>
                  )}
                </div>
              </Card>

              <Card className="p-4 space-y-3">
                <div className="flex items-center justify-between">
                  <h2 className="text-sm font-semibold">Time per question</h2>
                  <Icon name="clock" className="h-4 w-4 text-muted-foreground" />
                </div>
                <p className="text-xs text-muted-foreground">
                  Slower than 90 seconds on a question type? You might be over-reading. Faster than
                  30 seconds with low accuracy? You&apos;re probably rushing.
                </p>
                <div className="mt-2 space-y-2">
                  {timeStats.map((row) => (
                    <div key={row.questionTypeId} className="flex items-center justify-between">
                      <span className="text-xs font-medium">
                        {row.questionTypeId.toUpperCase()}
                      </span>
                      <span className="text-xs text-muted-foreground">
                        {row.avgSeconds != null ? `${row.avgSeconds.toFixed(1)}s / question` : '—'}
                      </span>
                    </div>
                  ))}
                  {!timeStats.length && (
                    <p className="text-xs text-muted-foreground">
                      Not enough timing data yet.
                    </p>
                  )}
                </div>
              </Card>

              <Card className="p-4 space-y-3 md:col-span-2">
                <div className="flex items-center justify-between">
                  <h2 className="text-sm font-semibold">Recent Reading attempts</h2>
                  <Icon name="line-chart" className="h-4 w-4 text-muted-foreground" />
                </div>
                <p className="text-xs text-muted-foreground">
                  Track how your raw score and band are moving over time. Use this to see if your
                  practice is actually working.
                </p>
                <div className="mt-3 space-y-1 text-xs">
                  {timeline.map((t) => (
                    <div
                      key={t.attemptId}
                      className="flex items-center justify-between border-b border-border/60 py-1 last:border-b-0"
                    >
                      <span className="text-[11px] text-muted-foreground">
                        {new Date(t.createdAt).toLocaleString()}
                      </span>
                      <span className="font-medium">
                        {t.rawScore ?? '—'}
                        {t.questionCount ? `/${t.questionCount}` : null}{' '}
                        {t.bandScore != null ? `· Band ${t.bandScore.toFixed(1)}` : ''}
                      </span>
                    </div>
                  ))}
                  {!timeline.length && (
                    <p className="text-xs text-muted-foreground">
                      No attempts in the window we looked at.
                    </p>
                  )}
                </div>
              </Card>
            </div>
          )}
        </Container>
      </section>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  const supabase = getServerClient(ctx.req, ctx.res);

  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) {
    return {
      redirect: { destination: '/login', permanent: false },
    };
  }

  // Get last N attempts for this user
  const { data: attemptsRows } = await supabase
    .from('attempts_reading')
    .select('id, test_id, created_at, raw_score, question_count, duration_seconds, section_stats')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false })
    .limit(30);

  const attempts: AttemptsRow[] = (attemptsRows ?? []) as any[];
  const hasData = attempts.length > 0;

  if (!hasData) {
    return {
      props: {
        hasData: false,
        accuracyByType: [],
        timeline: [],
        timeStats: [],
      },
    };
  }

  const accuracyByType = computeAccuracyByQuestionType(attempts) as QuestionTypeAccuracy[];
  const timeline = computeAttemptsTimeline(attempts) as TimelinePoint[];
  const timeStats = computeTimePerQuestionStats(attempts) as TimePerQuestionStat[];

  return {
    props: {
      hasData: true,
      accuracyByType,
      timeline,
      timeStats,
    },
  };
};

export default ReadingAnalyticsPage;

===== File #14: pages/mock/reading/review/[attemptId].tsx =====
// pages/mock/reading/review/[attemptId].tsx
import * as React from 'react';
import Head from 'next/head';
import type { GetServerSideProps, NextPage } from 'next';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';

import { getServerClient } from '@/lib/supabaseServer';
import type { Database } from '@/lib/database.types';
import type { ReadingTest, ReadingPassage, ReadingQuestion } from '@/lib/reading/types';
import { ReadingReviewShell } from '@/components/reading/review/ReadingReviewShell';

type ReviewAnswer = {
  questionId: string;
  isCorrect: boolean;
  selectedAnswer: string | string[] | null;
};

type AttemptForReview = {
  id: string;
  rawScore: number | null;
  bandScore: number | null;
  questionCount: number | null;
  createdAt: string;
  durationSeconds: number | null;
};

type PageProps = {
  test: ReadingTest | null;
  passages: ReadingPassage[];
  questions: ReadingQuestion[];
  attempt: AttemptForReview | null;
  answers: ReviewAnswer[];
};

const ReadingReviewPage: NextPage<PageProps> = ({
  test,
  passages,
  questions,
  attempt,
  answers,
}) => {
  const notFound = !test || !attempt;

  if (notFound) {
    return (
      <>
        <Head>
          <title>Reading review · GramorX</title>
        </Head>
        <Container className="py-10">
          <Card className="mx-auto max-w-xl p-8 text-center space-y-3">
            <p className="text-sm font-semibold">Review not available</p>
            <p className="text-xs text-muted-foreground">
              We could not find this attempt or it is not accessible with your account.
            </p>
          </Card>
        </Container>
      </>
    );
  }

  return (
    <>
      <Head>
        <title>Review – {test.title} · Reading Mock · GramorX</title>
      </Head>
      <Container className="py-8 max-w-5xl">
        <ReadingReviewShell
          test={test}
          passages={passages}
          questions={questions}
          attempt={attempt}
          answers={answers}
        />
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  const attemptIdParam = ctx.params?.attemptId;
  if (!attemptIdParam || typeof attemptIdParam !== 'string') {
    return {
      props: {
        test: null,
        passages: [],
        questions: [],
        attempt: null,
        answers: [],
      },
    };
  }

  const supabase = getServerClient(ctx.req, ctx.res);

  type AttemptRow = Database['public']['Tables']['reading_attempts']['Row'];
  type TestRow = Database['public']['Tables']['reading_tests']['Row'];
  type PassageRow = Database['public']['Tables']['reading_passages']['Row'];
  type QuestionRow = Database['public']['Tables']['reading_questions']['Row'];

  const {
    data: { user },
  } = await supabase.auth.getUser();

  // force login for review
  if (!user) {
    return {
      redirect: {
        destination: '/login?role=student',
        permanent: false,
      },
    };
  }

  // 1) load attempt (no join)
  const { data: attemptRow, error: attemptError } = await supabase
    .from('reading_attempts')
    .select('*')
    .eq('id', attemptIdParam)
    .maybeSingle<AttemptRow>();

  if (attemptError || !attemptRow) {
    // eslint-disable-next-line no-console
    console.error('reading_review: attempt error', attemptError);
    return {
      props: {
        test: null,
        passages: [],
        questions: [],
        attempt: null,
        answers: [],
      },
    };
  }

  // safety: user must own this attempt
  if (attemptRow.user_id !== user.id) {
    return {
      props: {
        test: null,
        passages: [],
        questions: [],
        attempt: null,
        answers: [],
      },
    };
  }

  // 2) load test
  const { data: testRow, error: testError } = await supabase
    .from('reading_tests')
    .select('*')
    .eq('id', attemptRow.test_id)
    .maybeSingle<TestRow>();

  if (testError || !testRow) {
    // eslint-disable-next-line no-console
    console.error('reading_review: test error', testError);
    return {
      props: {
        test: null,
        passages: [],
        questions: [],
        attempt: null,
        answers: [],
      },
    };
  }

  const test: ReadingTest = {
    id: testRow.id,
    slug: testRow.slug,
    title: testRow.title,
    description: testRow.description,
    examType: testRow.exam_type,
    durationSeconds: testRow.duration_seconds ?? 3600,
    createdAt: testRow.created_at,
    updatedAt: testRow.updated_at,
  };

  // 3) load passages + questions for that test
  const [{ data: passageRows, error: pErr }, { data: questionRows, error: qErr }] =
    await Promise.all([
      supabase
        .from('reading_passages')
        .select('*')
        .eq('test_id', testRow.id)
        .order('passage_order', { ascending: true }),
      supabase
        .from('reading_questions')
        .select('*')
        .eq('test_id', testRow.id)
        .order('question_order', { ascending: true }),
    ]);

  if (pErr || qErr) {
    // eslint-disable-next-line no-console
    console.error('reading_review: passage/question error', pErr, qErr);
  }

  const passages: ReadingPassage[] =
    (passageRows ?? []).map((row: PassageRow) => ({
      id: row.id,
      testId: row.test_id,
      passageOrder: row.passage_order,
      title: row.title,
      subtitle: row.subtitle,
      content: row.content,
      wordCount: row.word_count,
      createdAt: row.created_at,
      updatedAt: row.updated_at,
    })) ?? [];

  const questions: ReadingQuestion[] =
    (questionRows ?? []).map((row: QuestionRow) => ({
      id: row.id,
      testId: row.test_id,
      passageId: row.passage_id,
      questionOrder: row.question_order,
      questionTypeId: row.question_type_id as any,
      prompt: row.prompt,
      instruction: row.instruction,
      correctAnswer: row.correct_answer as any,
      constraintsJson: (row.constraints_json ?? {}) as Record<string, unknown>,
      tags: row.tags ?? [],
      createdAt: row.created_at,
      updatedAt: row.updated_at,
    })) ?? [];

  // 4) answers from attempt.meta.answers
  const meta = (attemptRow.meta as any) || {};
  const answersMap: Record<string, any> = meta.answers ?? {};

  const reviewAnswers: ReviewAnswer[] = questions.map((q) => {
    const selected = answersMap[q.id] ?? null;
    const correct = (q as any).correctAnswer;

    let isCorrect = false;

    if (correct == null) {
      isCorrect = false;
    } else if (typeof correct === 'string') {
      isCorrect = selected != null && selected === correct;
    } else if (Array.isArray(correct)) {
      if (Array.isArray(selected)) {
        const givenSet = new Set(selected as any[]);
        isCorrect = (correct as any[]).every((v) => givenSet.has(v));
      }
    } else if (
      typeof correct === 'object' &&
      selected &&
      typeof selected === 'object'
    ) {
      const cObj = correct as Record<string, any>;
      const gObj = selected as Record<string, any>;
      const keys = Object.keys(cObj);
      isCorrect = keys.every((k) => gObj[k] === cObj[k]);
    }

    let selectedAnswer: string | string[] | null = null;
    if (selected == null) {
      selectedAnswer = null;
    } else if (typeof selected === 'string') {
      selectedAnswer = selected;
    } else if (Array.isArray(selected)) {
      selectedAnswer = selected as string[];
    } else {
      selectedAnswer = String(selected);
    }

    return {
      questionId: q.id,
      isCorrect,
      selectedAnswer,
    };
  });

  const sectionStats = (attemptRow.section_stats as any) || {};
  const attempt: AttemptForReview = {
    id: attemptRow.id,
    rawScore: attemptRow.raw_score,
    bandScore: attemptRow.band_score,
    questionCount: sectionStats.totalQuestions ?? null,
    durationSeconds: attemptRow.duration_seconds,
    createdAt: attemptRow.started_at ?? attemptRow.created_at,
  };

  return {
    props: {
      test,
      passages,
      questions,
      attempt,
      answers: reviewAnswers,
    },
  };
};

export default ReadingReviewPage;

===== File #15: pages/mock/reading/history/index.tsx =====
// pages/mock/reading/history/index.tsx
import * as React from 'react';
import type { GetServerSideProps, NextPage } from 'next';
import Head from 'next/head';
import Link from 'next/link';

import { Container } from '@/components/design-system/Container';
import { Button } from '@/components/design-system/Button';
import { Icon } from '@/components/design-system/Icon';

import {
  ReadingHistoryTable,
  type ReadingHistoryRow,
} from '@/components/reading/history/ReadingHistoryTable';
import { getServerClient } from '@/lib/supabaseServer';

type PageProps = {
  rows: ReadingHistoryRow[];
  filterSlug?: string | null;
  filterTitle?: string | null;
};

const ReadingHistoryPage: NextPage<PageProps> = ({
  rows,
  filterSlug,
  filterTitle,
}) => {
  const hasFilter = !!filterSlug;

  return (
    <>
      <Head>
        <title>Reading History · GramorX</title>
      </Head>
      <section className="py-10 bg-background">
        <Container className="max-w-4xl space-y-6">
          <div className="flex items-center justify-between gap-3">
            <div>
              <h1 className="text-xl font-semibold tracking-tight">
                Reading history
                {hasFilter && filterTitle
                  ? ` – ${filterTitle}`
                  : hasFilter && filterSlug
                  ? ` – ${filterSlug}`
                  : ''}
              </h1>
              <p className="text-xs text-muted-foreground">
                {hasFilter
                  ? 'Only attempts for this specific Reading test.'
                  : 'All your IELTS-style Reading attempts in one place.'}
              </p>
            </div>

            <div className="flex gap-2">
              {hasFilter && (
                <Button asChild size="sm" variant="ghost">
                  <Link href="/mock/reading/history">
                    <Icon name="x" className="h-4 w-4 mr-1" />
                    Clear filter
                  </Link>
                </Button>
              )}
              <Button asChild size="sm" variant="outline">
                <Link href="/mock/reading">
                  <Icon name="arrow-left" className="h-4 w-4 mr-1" />
                  Back to Reading mocks
                </Link>
              </Button>
            </div>
          </div>

          <ReadingHistoryTable rows={rows} />
        </Container>
      </section>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  const supabase = getServerClient(ctx.req, ctx.res);

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return {
      redirect: { destination: '/login?role=student', permanent: false },
    };
  }

  // ✅ read test filter from query (?test=slug)
  const testSlugParam = ctx.query.test;
  const testSlug =
    typeof testSlugParam === 'string' ? testSlugParam.trim() : null;

  // base query
  let query = supabase
    .from('attempts_reading')
    .select(
      `
        id,
        test_id,
        created_at,
        raw_score,
        band_score,
        question_count,
        reading_tests!inner (
          slug,
          title
        )
      `,
    )
    .eq('user_id', user.id)
    .order('created_at', { ascending: false })
    .limit(100);

  // ✅ if testSlug is present, filter only that paper
  if (testSlug) {
    query = query.eq('reading_tests.slug', testSlug);
  }

  const { data, error } = await query;

  if (error) {
    // eslint-disable-next-line no-console
    console.error('reading history error', error);
  }

  const rows: ReadingHistoryRow[] =
    (data ?? []).map((row: any) => ({
      attemptId: row.id,
      testSlug: row.reading_tests.slug,
      testTitle: row.reading_tests.title,
      bandScore: row.band_score,
      rawScore: row.raw_score,
      totalQuestions: row.question_count,
      createdAt: row.created_at,
    })) ?? [];

  // figure out title for header if filtered
  let filterTitle: string | null = null;
  if (testSlug && rows.length > 0) {
    filterTitle = rows[0].testTitle;
  }

  return {
    props: {
      rows,
      filterSlug: testSlug ?? null,
      filterTitle,
    },
  };
};

export default ReadingHistoryPage;

===== File #16: pages/mock/reading/techniques.tsx =====
// pages/mock/reading/techniques.tsx
import * as React from 'react';
import Head from 'next/head';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import Icon from '@/components/design-system/Icon';

import { techniqueLessons, type TechniqueLesson } from '@/data/reading/techniqueLessons';

const categories: { id: TechniqueLesson['category']; label: string }[] = [
  { id: 'skimming', label: 'Skimming' },
  { id: 'scanning', label: 'Scanning' },
  { id: 'paraphrasing', label: 'Paraphrasing' },
  { id: 'keyword', label: 'Keyword focus' },
  { id: 'distraction', label: 'Distraction traps' },
];

const ReadingTechniquesPage: React.FC = () => {
  const [activeCategory, setActiveCategory] = React.useState<TechniqueLesson['category']>('skimming');
  const [activeLessonId, setActiveLessonId] = React.useState<string | null>(null);

  const filtered = techniqueLessons.filter((l) => l.category === activeCategory);
  const activeLesson =
    filtered.find((l) => l.id === activeLessonId) ?? filtered[0] ?? techniqueLessons[0] ?? null;

  React.useEffect(() => {
    if (!activeLessonId && filtered[0]) {
      setActiveLessonId(filtered[0].id);
    }
  }, [activeLessonId, filtered]);

  return (
    <>
      <Head>
        <title>Reading Techniques Trainer · GramorX</title>
      </Head>

      <section className="py-10 bg-background">
        <Container className="max-w-5xl space-y-6">
          <div className="flex items-center justify-between gap-3">
            <div className="space-y-1">
              <Badge size="xs" variant="outline">
                Technique trainer
              </Badge>
              <h1 className="text-xl font-semibold tracking-tight">
                Fix the way you read, not just your score.
              </h1>
              <p className="text-xs text-muted-foreground">
                Short, repeatable drills to sharpen skimming, scanning, and paraphrase recognition.
              </p>
            </div>
            <Button asChild size="sm" variant="outline">
              <a href="/mock/reading">
                <Icon name="arrow-left" className="h-4 w-4 mr-1" />
                Back to Reading
              </a>
            </Button>
          </div>

          {/* Category tabs */}
          <div className="flex flex-wrap gap-1">
            {categories.map((c) => (
              <Button
                key={c.id}
                size="xs"
                variant={activeCategory === c.id ? 'default' : 'outline'}
                onClick={() => {
                  setActiveCategory(c.id);
                  setActiveLessonId(null);
                }}
              >
                {c.label}
              </Button>
            ))}
          </div>

          <div className="grid gap-4 lg:grid-cols-[minmax(0,1.4fr)_minmax(0,2fr)]">
            {/* Lesson list */}
            <Card className="p-3 space-y-2">
              <p className="text-xs font-medium text-muted-foreground mb-1">
                Drills in this category
              </p>
              <div className="space-y-1 max-h-[60vh] overflow-auto">
                {filtered.map((l) => (
                  <button
                    key={l.id}
                    type="button"
                    onClick={() => setActiveLessonId(l.id)}
                    className={
                      'w-full text-left text-xs rounded-md border px-2 py-1.5 transition-colors ' +
                      (activeLesson?.id === l.id
                        ? 'border-primary bg-primary/5'
                        : 'border-transparent hover:bg-muted')
                    }
                  >
                    <div className="flex items-center justify-between">
                      <span className="font-medium">{l.title}</span>
                      <span className="text-[10px] text-muted-foreground capitalize">
                        {l.level}
                      </span>
                    </div>
                    <p className="text-[11px] text-muted-foreground line-clamp-2">
                      {l.summary}
                    </p>
                  </button>
                ))}
                {!filtered.length && (
                  <p className="text-[11px] text-muted-foreground">
                    No drills for this category yet.
                  </p>
                )}
              </div>
            </Card>

            {/* Lesson details */}
            <Card className="p-4 space-y-3">
              {activeLesson ? (
                <>
                  <div className="flex items-center justify-between">
                    <div className="space-y-0.5">
                      <p className="text-[11px] text-muted-foreground uppercase tracking-wide">
                        {activeLesson.category}
                      </p>
                      <h2 className="text-sm font-semibold">{activeLesson.title}</h2>
                    </div>
                    <Badge size="xs" variant="outline">
                      {activeLesson.level}
                    </Badge>
                  </div>

                  <p className="text-xs text-muted-foreground">{activeLesson.summary}</p>

                  <div className="space-y-1.5">
                    <p className="text-[11px] font-medium">Steps</p>
                    <ol className="list-decimal list-inside space-y-1 text-[11px]">
                      {activeLesson.steps.map((s, idx) => (
                        <li key={idx}>{s}</li>
                      ))}
                    </ol>
                  </div>

                  <div className="space-y-1.5">
                    <p className="text-[11px] font-medium">Tips</p>
                    <ul className="list-disc list-inside space-y-1 text-[11px]">
                      {activeLesson.tips.map((t, idx) => (
                        <li key={idx}>{t}</li>
                      ))}
                    </ul>
                  </div>
                </>
              ) : (
                <p className="text-xs text-muted-foreground">
                  Pick a drill from the left to see the steps.
                </p>
              )}
            </Card>
          </div>
        </Container>
      </section>
    </>
  );
};

export default ReadingTechniquesPage;

===== File #17: pages/mock/reading/[slug].tsx =====
// pages/mock/reading/[slug].tsx
import * as React from 'react';
import Head from 'next/head';
import Link from 'next/link';
import type { GetServerSideProps, NextPage } from 'next';

import { getServerClient } from '@/lib/supabaseServer';
import type { Database } from '@/lib/database.types';

import type {
  ReadingTest as ReadingTestType,
  ReadingPassage as ReadingPassageType,
  ReadingQuestion as ReadingQuestionType,
} from '@/lib/reading/types';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import { Icon } from '@/components/design-system/Icon';
import { ReadingExamShell } from '@/components/reading/ReadingExamShell';

type PageProps = {
  test: ReadingTestType | null;
  passages: ReadingPassageType[];
  questions: ReadingQuestionType[];
};

const ReadingMockRunPage: NextPage<PageProps> = ({ test, passages, questions }) => {
  if (!test) {
    return (
      <>
        <Head>
          <title>Reading mock not found · GramorX</title>
        </Head>
        <Container className="py-10">
          <Card className="mx-auto max-w-xl p-8 text-center space-y-4">
            <div className="flex flex-col items-center gap-2">
              <Icon name="alert-circle" className="h-8 w-8 text-destructive" />
              <h1 className="text-lg font-semibold">Reading mock not found</h1>
            </div>
            <p className="text-sm text-muted-foreground">
              This reading mock is not available anymore or the link is incorrect.
            </p>
            <div className="flex justify-center">
              <Button asChild>
                <Link href="/mock/reading">
                  <Icon name="arrow-left" className="mr-2 h-4 w-4" />
                  Back to Reading Mocks
                </Link>
              </Button>
            </div>
          </Card>
        </Container>
      </>
    );
  }

  return (
    <>
      <Head>
        <title>{test.title} · Reading Mock · GramorX</title>
      </Head>
      <Container className="py-6 lg:py-10">
        <ReadingExamShell test={test} passages={passages} questions={questions} />
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  const slugParam = ctx.params?.slug;

  if (!slugParam || typeof slugParam !== 'string') {
    return {
      props: {
        test: null,
        passages: [],
        questions: [],
      },
    };
  }

  const supabase = getServerClient(ctx.req, ctx.res);
  type TestRow = Database['public']['Tables']['reading_tests']['Row'];
  type PassageRow = Database['public']['Tables']['reading_passages']['Row'];
  type QuestionRow = Database['public']['Tables']['reading_questions']['Row'];

  const { data: testsRows, error: testsError } = await supabase
    .from('reading_tests')
    .select('*')
    .eq('slug', slugParam)
    .eq('is_active', true)
    .limit(1);

  if (testsError || !testsRows || testsRows.length === 0) {
    return {
      props: {
        test: null,
        passages: [],
        questions: [],
      },
    };
  }

  const testRow: TestRow = testsRows[0];

  const { data: passageRows } = await supabase
    .from('reading_passages')
    .select('*')
    .eq('test_id', testRow.id)
    .order('passage_order', { ascending: true });

  const { data: questionRows } = await supabase
    .from('reading_questions')
    .select('*')
    .eq('test_id', testRow.id)
    .order('question_order', { ascending: true });

  const test: ReadingTestType = {
    id: testRow.id,
    slug: testRow.slug,
    title: testRow.title,
    description: testRow.description,
    examType: testRow.exam_type,
    durationSeconds: testRow.duration_seconds ?? 3600,
    createdAt: testRow.created_at,
    updatedAt: testRow.updated_at,
  };

  const passages: ReadingPassageType[] =
    (passageRows ?? []).map((row: PassageRow) => ({
      id: row.id,
      testId: row.test_id,
      passageOrder: row.passage_order,
      title: row.title,
      subtitle: row.subtitle,
      content: row.content,
      wordCount: row.word_count,
      createdAt: row.created_at,
      updatedAt: row.updated_at,
    })) ?? [];

  const questions: ReadingQuestionType[] =
    (questionRows ?? []).map((row: QuestionRow) => ({
      id: row.id,
      testId: row.test_id,
      passageId: row.passage_id,
      questionOrder: row.question_order,
      questionTypeId: row.question_type_id as any,
      prompt: row.prompt,
      instruction: row.instruction,
      correctAnswer: row.correct_answer as any,
      constraintsJson: (row.constraints_json ?? {}) as Record<string, unknown>,
      tags: row.tags ?? [],
      createdAt: row.created_at,
      updatedAt: row.updated_at,
    })) ?? [];

  return {
    props: {
      test,
      passages,
      questions,
    },
  };
};

export default ReadingMockRunPage;

===== File #18: pages/mock/reading/[slug]/result.tsx =====
// pages/mock/reading/[slug]/result.tsx
import * as React from 'react';
import Head from 'next/head';
import Link from 'next/link';
import type { GetServerSideProps, NextPage } from 'next';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import { Badge } from '@/components/design-system/Badge';
import Icon from '@/components/design-system/Icon';

import { getServerClient } from '@/lib/supabaseServer';
import type { Database } from '@/lib/database.types';
import type { ReadingTest } from '@/lib/reading/types';
import { ReadingAnswerSheetGrid } from '@/components/reading/answer-sheet/ReadingAnswerSheetGrid';
import { ReadingReviewSummaryBar } from '@/components/reading/review/ReadingReviewSummaryBar';
import { BandPredictorCard } from '@/components/reading/analytics/BandPredictorCard';
import type { ReadingAttemptSummary } from '@/lib/reading/bandPredictor';

type AttemptForResult = {
  id: string;
  rawScore: number;
  bandScore: number;
  questionCount: number;
  createdAt: string;
  durationSeconds: number | null;
};

type PageProps = {
  test: ReadingTest | null;
  attempt: AttemptForResult | null;
  answerSheet: Record<number, string | string[] | null>;
  attemptSummaries: ReadingAttemptSummary[];
};

const ReadingResultPage: NextPage<PageProps> = ({
  test,
  attempt,
  answerSheet,
  attemptSummaries,
}) => {
  if (!test || !attempt) {
    return (
      <>
        <Head>
          <title>Reading Result · GramorX</title>
        </Head>
        <section className="py-16 bg-background">
          <Container className="max-w-3xl">
            <Card className="p-6 space-y-3 text-sm text-muted-foreground">
              <p>No completed Reading attempt found for this test.</p>
              <div className="flex gap-2">
                <Button asChild size="sm">
                  <Link href="/mock/reading">
                    <Icon name="arrow-left" className="h-4 w-4 mr-1" />
                    Back to Reading mocks
                  </Link>
                </Button>
              </div>
            </Card>
          </Container>
        </section>
      </>
    );
  }

  const totalQuestions = attempt.questionCount || 40;

  return (
    <>
      <Head>
        <title>
          Result – {test.title} · Reading Mock · GramorX
        </title>
      </Head>

      <section className="py-10 bg-background">
        <Container className="max-w-5xl space-y-6">
          <ReadingReviewSummaryBar
            testTitle={test.title}
            bandScore={attempt.bandScore}
            rawScore={attempt.rawScore}
            totalQuestions={totalQuestions}
            createdAt={attempt.createdAt}
            durationSeconds={attempt.durationSeconds ?? undefined}
          />

          <div className="grid gap-4 lg:grid-cols-[minmax(0,2.1fr)_minmax(0,1.4fr)]">
            {/* Answer sheet */}
            <div className="space-y-3">
              <ReadingAnswerSheetGrid
                totalQuestions={totalQuestions}
                answers={answerSheet}
              />

              <Card className="p-3 text-xs text-muted-foreground space-y-1.5">
                <p className="font-medium">
                  Next steps
                </p>
                <ul className="list-disc list-inside space-y-1">
                  <li>
                    Review every mistake with AI explanations to fix logic, not just memorize
                    answers.
                  </li>
                  <li>
                    Do a question-type drill for your weakest area (TFNG / headings / matching).
                  </li>
                  <li>
                    Track your progress in the Reading analytics page.
                  </li>
                </ul>
              </Card>
            </div>

            {/* Right side: band predictor + actions */}
            <div className="space-y-3">
              <BandPredictorCard attempts={attemptSummaries} />

              <Card className="p-3 space-y-2 text-xs">
                <p className="text-[11px] font-medium text-muted-foreground uppercase tracking-wide">
                  Actions
                </p>
                <div className="flex flex-col gap-2">
                  <Button asChild size="sm">
                    <Link href={`/mock/reading/review/${attempt.id}`}>
                      <Icon name="eye" className="h-4 w-4 mr-1" />
                      Review this attempt
                    </Link>
                  </Button>
                  <Button asChild size="sm" variant="outline">
                    <Link href="/mock/reading/analytics">
                      <Icon name="activity" className="h-4 w-4 mr-1" />
                      Open Reading analytics
                    </Link>
                  </Button>
                  <Button asChild size="sm" variant="outline">
                    <Link href="/mock/reading">
                      <Icon name="arrow-left" className="h-4 w-4 mr-1" />
                      Back to Reading mocks
                    </Link>
                  </Button>
                </div>

                <div className="pt-2 border-t mt-2 flex items-center gap-2">
                  <Badge size="xs" variant="outline">
                    Tip
                  </Badge>
                  <p className="text-[11px] text-muted-foreground">
                    Don’t spam tests. One full mock + deep review beats three rushed attempts.
                  </p>
                </div>
              </Card>
            </div>
          </div>
        </Container>
      </section>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  const supabase = getServerClient<Database>(ctx);

  const slugParam = ctx.params?.slug;
  if (typeof slugParam !== 'string') {
    return { notFound: true };
  }

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return {
      redirect: {
        destination: '/login',
        permanent: false,
      },
    };
  }

  const { data: testRow } = await supabase
    .from('reading_tests')
    .select('*')
    .eq('slug', slugParam)
    .maybeSingle();

  if (!testRow) {
    return {
      props: {
        test: null,
        attempt: null,
        answerSheet: {},
        attemptSummaries: [],
      },
    };
  }

  const test: ReadingTest = {
    id: testRow.id,
    slug: testRow.slug,
    title: testRow.title,
    description: testRow.description,
    examType: testRow.exam_type,
    durationSeconds: testRow.duration_seconds ?? 3600,
    createdAt: testRow.created_at,
    updatedAt: testRow.updated_at,
  };

  // Latest attempt for this test
  const { data: attemptRow } = await supabase
    .from('attempts_reading')
    .select('*')
    .eq('user_id', user.id)
    .eq('test_id', test.id)
    .order('created_at', { ascending: false })
    .limit(1)
    .maybeSingle();

  if (!attemptRow) {
    return {
      props: {
        test,
        attempt: null,
        answerSheet: {},
        attemptSummaries: [],
      },
    };
  }

  const attempt: AttemptForResult = {
    id: attemptRow.id,
    rawScore: attemptRow.raw_score ?? 0,
    bandScore: attemptRow.band_score ?? 0,
    questionCount: attemptRow.question_count ?? 40,
    createdAt: attemptRow.created_at,
    durationSeconds: attemptRow.duration_seconds ?? null,
  };

  // Build answer sheet overview – map question_order -> selected answer
  const [{ data: questionRows }, { data: answerRows }] = await Promise.all([
    supabase
      .from('reading_questions')
      .select('id, question_order')
      .eq('test_id', test.id),
    supabase
      .from('attempts_reading_answers')
      .select('question_id, selected_answer')
      .eq('attempt_id', attempt.id),
  ]);

  const orderByQuestionId = new Map<string, number>();
  (questionRows ?? []).forEach((q) => {
    orderByQuestionId.set(q.id, q.question_order ?? 0);
  });

  const answerSheet: Record<number, string | string[] | null> = {};
  (answerRows ?? []).forEach((a) => {
    const order = orderByQuestionId.get(a.question_id);
    if (!order) return;
    const val = a.selected_answer as any;
    answerSheet[order] = val;
  });

  // Build attempt summaries for band predictor (all reading attempts for this user)
  const { data: allAttemptsRows } = await supabase
    .from('attempts_reading')
    .select('raw_score, band_score, question_count, created_at')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false })
    .limit(30);

  const attemptSummaries: ReadingAttemptSummary[] =
    (allAttemptsRows ?? []).map((a) => ({
      rawScore: a.raw_score ?? 0,
      totalQuestions: a.question_count ?? 40,
      bandScore: a.band_score,
      createdAt: a.created_at,
    })) ?? [];

  return {
    props: {
      test,
      attempt,
      answerSheet,
      attemptSummaries,
    },
  };
};

export default ReadingResultPage;

===== File #19: pages/mock/reading/weekly/index.tsx =====
// pages/mock/reading/weekly/index.tsx
import * as React from 'react';
import Head from 'next/head';
import Link from 'next/link';
import type { GetServerSideProps, NextPage } from 'next';
import { useRouter } from 'next/router';

import { getServerClient } from '@/lib/supabaseServer';
import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import { Badge } from '@/components/design-system/Badge';
import { Icon } from '@/components/design-system/Icon';

type WeeklyTest = {
  id: string;
  slug: string;
  title: string;
  description: string | null;
  difficulty: string | null;
  examType: string;
  totalQuestions: number;
  totalPassages: number;
  durationSeconds: number;
  tags: string[];
};

type PageProps = {
  test: WeeklyTest | null;
  hasAttempted: boolean;
  error?: string;
};

const WeeklyChallengePage: NextPage<PageProps> = ({ test, hasAttempted, error }) => {
  const router = useRouter();

  if (error) {
    return (
      <>
        <Head>
          <title>Weekly Challenge · Error</title>
        </Head>
        <Container className="py-10 max-w-4xl">
          <Card className="p-6 text-center space-y-4">
            <Icon name="alert-triangle" className="w-8 h-8 text-destructive mx-auto" />
            <h2 className="text-lg font-semibold">Unable to load weekly challenge</h2>
            <p className="text-sm text-muted-foreground">{error}</p>

            <Button asChild>
              <Link href="/mock/reading">
                <Icon name="arrow-left" className="h-4 w-4 mr-2" /> Back to Reading
              </Link>
            </Button>
          </Card>
        </Container>
      </>
    );
  }

  const handleStart = () => {
    if (!test) return;
    router.push(`/mock/reading/${test.slug}?weekly=1`);
  };

  return (
    <>
      <Head>
        <title>Weekly Reading Challenge · GramorX</title>
      </Head>

      <Container className="py-10 max-w-5xl space-y-8">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-semibold tracking-tight">Weekly Reading Challenge</h1>
            <p className="text-sm text-muted-foreground">
              One premium challenge every Sunday. 20 questions. Strict mode. Improve faster.
            </p>
          </div>

          <Badge variant="outline" className="rounded-ds-xl">
            <Icon name="calendar" className="h-4 w-4 mr-1" />
            Week {new Date().toLocaleDateString('en-US', { week: 'numeric', })}
          </Badge>
        </div>

        {/* Main */}
        {test ? (
          <Card className="p-6 space-y-6">
            <div className="space-y-3">
              <Badge variant="soft" className="rounded-ds text-xs uppercase">
                {test.examType === 'gt' ? 'General Training' : 'Academic'}
              </Badge>

              {test.difficulty && (
                <Badge variant="outline" className="rounded-ds text-xs">
                  {test.difficulty}
                </Badge>
              )}

              <h2 className="text-xl font-semibold">{test.title}</h2>
              {test.description && (
                <p className="text-sm text-muted-foreground">{test.description}</p>
              )}
            </div>

            {/* Stats */}
            <div className="grid grid-cols-3 gap-4 border-y py-4 text-center">
              <div>
                <p className="text-lg font-semibold">{test.totalQuestions}</p>
                <p className="text-xs text-muted-foreground">Questions</p>
              </div>
              <div>
                <p className="text-lg font-semibold">{test.totalPassages}</p>
                <p className="text-xs text-muted-foreground">Passages</p>
              </div>
              <div>
                <p className="text-lg font-semibold">{Math.round(test.durationSeconds / 60)}</p>
                <p className="text-xs text-muted-foreground">Minutes</p>
              </div>
            </div>

            {/* Tags */}
            {test.tags.length > 0 && (
              <div className="flex flex-wrap gap-2 pt-2">
                {test.tags.map((t) => (
                  <Badge key={t} variant="outline" className="rounded-ds text-xs px-2 py-1">
                    #{t}
                  </Badge>
                ))}
              </div>
            )}

            <div className="pt-5">
              {hasAttempted ? (
                <Button asChild variant="secondary" className="w-full">
                  <Link href={`/mock/reading/${test.slug}/review?weekly=1`}>
                    <Icon name="eye" className="mr-2 h-4 w-4" />
                    Review Your Attempt
                  </Link>
                </Button>
              ) : (
                <Button onClick={handleStart} className="w-full" size="lg">
                  <Icon name="play-circle" className="mr-2 h-5 w-5" />
                  Start Weekly Challenge
                </Button>
              )}
            </div>
          </Card>
        ) : (
          <Card className="p-10 text-center space-y-4">
            <Icon name="calendar-off" className="h-10 w-10 text-muted-foreground mx-auto" />
            <h3 className="text-lg font-semibold">No Weekly Challenge Available</h3>
            <p className="text-sm text-muted-foreground">
              This week’s challenge hasn’t been scheduled yet. Check again later.
            </p>

            <Button asChild>
              <Link href="/mock/reading">
                <Icon name="book-open" className="mr-2 h-4 w-4" />
                Go Back
              </Link>
            </Button>
          </Card>
        )}
      </Container>
    </>
  );
};

export const getServerSideProps: GetServerSideProps<PageProps> = async (ctx) => {
  try {
    const supabase = getServerClient(ctx.req, ctx.res);

    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return {
        redirect: {
          destination: '/login?redirect=' + encodeURIComponent(ctx.resolvedUrl),
          permanent: false,
        },
      };
    }

    const now = new Date();
    const week = Number(
      new Intl.DateTimeFormat('en-US', { week: 'numeric' }).format(now)
    );
    const year = now.getFullYear();

    // Try to load weekly challenge row
    const { data: row, error: weeklyError } = await supabase
      .from('reading_weekly_challenges')
      .select(
        `
        id,
        week_number,
        year,
        test_id,
        reading_tests (
          id, slug, title, description, exam_type, difficulty,
          total_questions, total_passages, duration_seconds, tags
        )
      `
      )
      .eq('week_number', week)
      .eq('year', year)
      .single();

    let test = null;

    if (row?.reading_tests) {
      const t = row.reading_tests as any;
      test = {
        id: t.id,
        slug: t.slug,
        title: t.title,
        description: t.description,
        examType: t.exam_type,
        difficulty: t.difficulty,
        totalQuestions: t.total_questions,
        totalPassages: t.total_passages,
        durationSeconds: t.duration_seconds,
        tags: t.tags ?? [],
      };
    } else {
      // fallback random
      const { data: random, error: randomError } = await supabase
        .from('reading_tests')
        .select('*')
        .eq('is_active', true)
        .order('created_at', { ascending: false })
        .limit(1)
        .single();

      if (!randomError && random) {
        test = {
          id: random.id,
          slug: random.slug,
          title: random.title,
          description: random.description,
          examType: random.exam_type,
          difficulty: random.difficulty,
          totalQuestions: random.total_questions ?? 40,
          totalPassages: random.total_passages ?? 3,
          durationSeconds: random.duration_seconds ?? 3600,
          tags: random.tags ?? [],
        };
      }
    }

    // Check if user attempted this challenge already
    let hasAttempted = false;
    if (test) {
      const { data: attempts } = await supabase
        .from('reading_attempts')
        .select('id')
        .eq('user_id', user.id)
        .eq('test_id', test.id)
        .gte('created_at', `${year}-01-01`) // safe filter to avoid heavy scan
        .limit(1);

      hasAttempted = attempts && attempts.length > 0;
    }

    return {
      props: {
        test,
        hasAttempted,
      },
    };
  } catch (e) {
    return {
      props: {
        test: null,
        hasAttempted: false,
        error: 'Failed to load weekly challenge.',
      },
    };
  }
};

export default WeeklyChallengePage;

===== File #20: components/reading/AISummaryCard.tsx =====
// components/reading/AISummaryCard.tsx
import React, { useEffect, useState } from 'react';
import { Card } from '@/components/design-system/Card';
import { Skeleton } from '@/components/design-system/Skeleton';
import { Icon } from '@/components/design-system/Icon';

export const AISummaryCard: React.FC = () => {
  const [text, setText] = useState<string>('');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        setLoading(true);
        const r = await fetch('/api/ai/summary');
        const j = await r.json();
        if (!cancelled) setText(j.summary || '');
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => { cancelled = true; };
  }, []);

  return (
    <Card className="p-5 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
      <div className="text-sm font-semibold inline-flex items-center gap-2">
        <Icon name="Lightbulb" /> Recent Activity — AI Summary
      </div>
      {loading ? (
        <div className="mt-3 space-y-2">
          <Skeleton className="h-4 w-4/5" />
          <Skeleton className="h-4 w-3/5" />
        </div>
      ) : (
        <p className="mt-2 text-sm text-muted-foreground">{text || 'No sessions yet.'}</p>
      )}
    </Card>
  );
};

===== File #21: components/reading/drill/QuestionTypeDrillShell.tsx =====

===== File #22: components/reading/QuestionRenderer.tsx =====
import React, { useEffect, useMemo, useState } from 'react';
import { Input } from '@/components/design-system/Input';
import { Button } from '@/components/design-system/Button';
import type { AnswerValue, ReadingAnswersStore } from '@/components/reading/useReadingAnswers';

export type TFNGQuestion = {
  kind: 'tfng';
  id: string;
  prompt: string;
};

export type MCQQuestion = {
  kind: 'mcq';
  id: string;
  prompt: string;
  options: string[];
};

export type MatchingQuestion = {
  kind: 'matching';
  id: string;
  prompt: string;
  pairs: { left: string; right: string[] }[];
};

export type ShortQuestion = {
  kind: 'short';
  id: string;
  prompt: string;
};

export type Question =
  | TFNGQuestion
  | MCQQuestion
  | MatchingQuestion
  | ShortQuestion;

type Props = {
  index?: number;
  question: Question;
  store: ReadingAnswersStore;
  /** optional: external change handler if you ever need it */
  onChange?: (id: string, value: AnswerValue) => void;
};

/**
 * DS-compliant question renderer:
 * - TF/NG & MCQ use button groups (toggle, aria-pressed)
 * - Matching uses one <select> per left-item
 * - Short uses a text input
 * - Persists answer via useReadingAnswers(slug)
 * - Keyboard accessible (Enter/Space toggles; Tab order natural)
 */
export const QuestionRenderer: React.FC<Props> = ({
  index,
  question,
  store,
  onChange,
}) => {
  const [value, setValue] = useState<AnswerValue | undefined>(
    store.answers?.[question.id],
  );

  useEffect(() => {
    setValue(store.answers?.[question.id]);
  }, [store.answers, question.id]);

  const commit = (v: AnswerValue) => {
    setValue(v);
    store.setAnswer(question.id, v);
    onChange?.(question.id, v);
  };

  // ---------- Renderers ----------
  function renderTFNG(_q: TFNGQuestion) {
    // ^ rename param to _q to satisfy unused-args lint
    const choices = ['True', 'False', 'Not Given'] as const;
    const active = value ?? null;

    return (
      <div
        className="flex flex-wrap gap-2"
        role="group"
        aria-label="True False Not Given"
      >
        {choices.map((c) => {
          const pressed = active === c;
          return (
            <Button
              key={c}
              type="button"
              variant={pressed ? 'primary' : 'secondary'}
              className="rounded-ds-xl"
              aria-pressed={pressed}
              onClick={() => commit(c)}
              onKeyDown={(e: React.KeyboardEvent<HTMLButtonElement>) => {
                if (e.key === 'Enter' || e.key === ' ') {
                  e.preventDefault();
                  commit(c);
                }
              }}
            >
              {c}
            </Button>
          );
        })}
      </div>
    );
  }

  function renderMCQ(q: MCQQuestion) {
    const active = value ?? null;
    const opts = Array.isArray(q.options) ? q.options : [];

    return (
      <div
        className="flex flex-wrap gap-2"
        role="radiogroup"
        aria-label="Multiple choice options"
      >
        {opts.map((opt, i) => {
          const pressed = active === opt;
          return (
            <Button
              key={`${q.id}:${i}`}
              type="button"
              variant={pressed ? 'primary' : 'secondary'}
              className="rounded-ds-xl"
              aria-pressed={pressed}
              onClick={() => commit(opt)}
              onKeyDown={(e: React.KeyboardEvent<HTMLButtonElement>) => {
                if (e.key === 'Enter' || e.key === ' ') {
                  e.preventDefault();
                  commit(opt);
                }
              }}
            >
              {opt}
            </Button>
          );
        })}
      </div>
    );
  }

  const RenderMatching: React.FC<{
    q: MatchingQuestion;
    value: AnswerValue | undefined;
    commit: (v: AnswerValue) => void;
  }> = ({ q, value, commit }) => {
    const pairsLength = q.pairs.length;
    const current: string[] = useMemo(() => {
      if (Array.isArray(value)) return value as string[];
      if (value == null) return Array(pairsLength).fill('');
      return Array(pairsLength).fill('');
    }, [value, pairsLength]);

    const setAt = (idx: number, v: string) => {
      const arr = [...current];
      arr[idx] = v;
      commit(arr);
    };

    return (
      <div className="grid gap-3">
        {q.pairs.map((p, idx) => {
          const options = Array.isArray(p.right) ? p.right : [];
          const selected = current[idx] ?? '';
          const selectId = `${q.id}-match-${idx}`;

          return (
            <div
              key={idx}
              className="grid items-center gap-2 sm:grid-cols-[1fr_minmax(180px,_240px)]"
            >
              <label htmlFor={selectId} className="text-small opacity-80">
                {p.left}
              </label>
              <select
                id={selectId}
                className="rounded-ds border border-lightBorder dark:border-white/10 p-2 bg-white dark:bg-dark"
                value={selected}
                onChange={(e) => setAt(idx, e.target.value)}
                aria-label={`Select match for ${p.left}`}
              >
                <option value="" disabled>
                  Select…
                </option>
                {options.map((opt, i) => (
                  <option key={`${q.id}:${idx}:${i}`} value={opt}>
                    {opt}
                  </option>
                ))}
              </select>
            </div>
          );
        })}
      </div>
    );
  };

  function renderShort(_q: ShortQuestion) {
    // ^ rename param to _q to satisfy unused-args lint
    return (
      <div className="max-w-md">
        <Input
          aria-label="Answer"
          placeholder="Type your answer…"
          value={typeof value === 'boolean' ? (value ? 'true' : 'false') : value ?? ''}
          onChange={(e: React.ChangeEvent<HTMLInputElement>) =>
            commit(e.target.value)
          }
        />
        <p className="text-small opacity-70 mt-2">
          Tip: one word only unless specified.
        </p>
      </div>
    );
  }

  return (
    <div>
      {index != null && (
        <div className="text-small text-muted-foreground mb-1">Question {index}</div>
      )}
      <div className="tight-block mb-4">{question.prompt}</div>

      {question.kind === 'tfng' && renderTFNG(question)}
      {question.kind === 'mcq' && renderMCQ(question)}
      {question.kind === 'matching' && (
        <RenderMatching q={question as MatchingQuestion} value={value} commit={commit} />
      )}
      {question.kind === 'short' && renderShort(question)}
    </div>
  );
};

export default QuestionRenderer;

===== File #23: components/reading/OfflineOnlyBanner.tsx =====
import { Alert } from '@/components/design-system/Alert';

export function OfflineOnlyBanner() {
  return (
    <Alert variant="warning" title="Saved on this device">
      Your submission couldn’t reach our servers. It will sync automatically when you’re back online.
    </Alert>
  );
}

===== File #24: components/reading/types/ReadingQuestionMCQMultiple.tsx =====

===== File #25: components/reading/types/ReadingQuestionMatchingFeatures.tsx =====

===== File #26: components/reading/types/ReadingQuestionMatchingInformation.tsx =====

===== File #27: components/reading/types/ReadingQuestionSentenceEndings.tsx =====

===== File #28: components/reading/types/ReadingQuestionDiagramLabel.tsx =====

===== File #29: components/reading/types/ReadingQuestionMCQSingle.tsx =====

===== File #30: components/reading/types/ReadingQuestionSentenceCompletion.tsx =====

===== File #31: components/reading/types/ReadingQuestionTableCompletion.tsx =====

===== File #32: components/reading/types/ReadingQuestionShortAnswer.tsx =====

===== File #33: components/reading/types/ReadingQuestionFlowchartCompletion.tsx =====

===== File #34: components/reading/types/ReadingQuestionSummaryCompletion.tsx =====

===== File #35: components/reading/types/ReadingQuestionTFNG.tsx =====

===== File #36: components/reading/types/ReadingQuestionMatchingHeadings.tsx =====

===== File #37: components/reading/.DS_Store =====
   Bud1                                                                      comp                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  @                                              @                                                @                                                @                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   a ilg1Scomp            a imoDDblob      g!mA    a imodDblob      g!mA    a iph1Scomp           	 a n a l y t i c slg1Scomp      M   	 a n a l y t i c smoDDblob      g!mA   	 a n a l y t i c smodDblob      g!mA   	 a n a l y t i c sph1Scomp           a n s w e r - s h e e tlg1Scomp           a n s w e r - s h e e tmoDDblob      g!mA    a n s w e r - s h e e tmodDblob      g!mA    a n s w e r - s h e e tph1Scomp           d a i l ylg1Scomp      	5    d a i l ymoDDblob      g!mA    d a i l ymodDblob      g!mA    d a i l yph1Scomp            d r i l llg1Scomp            d r i l lmoDDblob      g!mA    d r i l lmodDblob      g!mA    d r i l lph1Scomp            h i s t o r ylg1Scomp            h i s t o r ymoDDblob      g!mA    h i s t o r ymodDblob      g!mA    h i s t o r yph1Scomp            r e v i e wlg1Scomp          r e v i e wmoDDblob      g!mA    r e v i e wmodDblob      g!mA    r e v i e wph1Scomp      0     t y p e slg1Scomp            t y p e smoDDblob      g!mA    t y p e smodDblob      g!mA    t y p e sph1Scomp                 @                                                @                                                @                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   E                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         DSDB                                 `                                                  @                                                @                                                @                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
===== File #38: components/reading/ReadingPassagePane.tsx =====
// components/reading/ReadingPassagePane.tsx
import * as React from 'react';

import { Card } from '@/components/design-system/Card';
import type { ReadingPassage } from '@/lib/reading/types';

type PassagePaneProps = {
  passage: ReadingPassage;
  totalPassages: number;
  highlights?: { start: number; end: number }[];
};

/**
 * Displays a single reading passage with title, subtitle and content.
 * Designed to work inside a fixed-height column: content scrolls independently.
 */
export const ReadingPassagePane: React.FC<PassagePaneProps> = ({
  passage,
  totalPassages,
}) => {
  return (
    <Card className="p-4 space-y-2 h-full flex flex-col">
      <div className="flex items-baseline justify-between gap-3">
        <h2 className="text-sm font-semibold">
          Passage {passage.passageOrder}
          {passage.title ? `: ${passage.title}` : ''}
        </h2>
        <p className="text-[11px] text-muted-foreground">
          Passage {passage.passageOrder} of {totalPassages}
        </p>
      </div>

      {passage.subtitle && (
        <p className="text-xs text-muted-foreground">{passage.subtitle}</p>
      )}

      <article className="text-sm whitespace-pre-line leading-relaxed flex-1 overflow-y-auto pr-1">
        {passage.content}
      </article>
    </Card>
  );
};

export default ReadingPassagePane;

===== File #39: components/reading/ReadingQuestionItem.tsx =====
import * as React from 'react';

import type { ReadingQuestion } from '@/lib/reading/types';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import { cn } from '@/lib/utils';

type ReadingQuestionItemProps = {
  question: ReadingQuestion;
  value: string | string[] | null;
  onChange: (val: string | string[] | null) => void;
};

const isSelected = (current: string | string[] | null, option: string) => {
  if (current == null) return false;
  if (Array.isArray(current)) return current.includes(option);
  return current === option;
};

export const ReadingQuestionItem: React.FC<ReadingQuestionItemProps> = ({
  question,
  value,
  onChange,
}) => {
  const type = (question as any).questionTypeId as string | undefined;
  const constraints = ((question as any).constraintsJson ?? {}) as {
    options?: string[];
    multiline?: boolean;
  };

  const handleTextChange: React.ChangeEventHandler<
    HTMLInputElement | HTMLTextAreaElement
  > = (e) => {
    onChange(e.target.value);
  };

  const handleSingleChoice = (choice: string) => {
    if (isSelected(value, choice)) {
      // unselect
      onChange(null);
    } else {
      onChange(choice);
    }
  };

  const tfngOptions = ['TRUE', 'FALSE', 'NOT GIVEN'];
  const ynngOptions = ['YES', 'NO', 'NOT GIVEN'];

  const mcqOptions =
    Array.isArray(constraints.options) && constraints.options.length > 0
      ? constraints.options
      : null;

  const renderAnswerControl = () => {
    if (type === 'tfng') {
      return (
        <div className="flex flex-wrap gap-2">
          {tfngOptions.map((opt) => (
            <Button
              key={opt}
              type="button"
              size="sm"
              variant={isSelected(value, opt) ? 'primary' : 'outline'}
              onClick={() => handleSingleChoice(opt)}
            >
              {opt}
            </Button>
          ))}
        </div>
      );
    }

    if (type === 'ynng') {
      return (
        <div className="flex flex-wrap gap-2">
          {ynngOptions.map((opt) => (
            <Button
              key={opt}
              type="button"
              size="sm"
              variant={isSelected(value, opt) ? 'primary' : 'outline'}
              onClick={() => handleSingleChoice(opt)}
            >
              {opt}
            </Button>
          ))}
        </div>
      );
    }

    if (type === 'mcq' || type === 'mcq_single') {
      if (mcqOptions) {
        return (
          <div className="space-y-1">
            {mcqOptions.map((opt, idx) => {
              const label = String(opt);
              const active = isSelected(value, label);
              return (
                <button
                  key={`${idx}-${label}`}
                  type="button"
                  onClick={() => handleSingleChoice(label)}
                  className={cn(
                    'w-full text-left text-xs px-2 py-1.5 rounded-ds border transition-colors',
                    active
                      ? 'border-primary bg-primary/10 text-primary'
                      : 'border-lightBorder hover:border-primary/60',
                  )}
                >
                  {label}
                </button>
              );
            })}
          </div>
        );
      }
    }

    // fallback: text / textarea
    if (constraints.multiline) {
      return (
        <textarea
          value={typeof value === 'string' ? value : ''}
          onChange={handleTextChange}
          className="w-full min-h-[72px] text-sm rounded-ds border border-lightBorder bg-surface px-2 py-1.5 outline-none focus-visible:border-primary focus-visible:ring-1 focus-visible:ring-primary/40"
        />
      );
    }

    return (
      <input
        type="text"
        value={typeof value === 'string' ? value : ''}
        onChange={handleTextChange}
        className="w-full text-sm rounded-ds border border-lightBorder bg-surface px-2 py-1.5 outline-none focus-visible:border-primary focus-visible:ring-1 focus-visible:ring-primary/40"
      />
    );
  };

  return (
    <Card className="p-3 space-y-2 text-sm">
      <div>
        <span className="font-medium mr-1">{(question as any).questionOrder}.</span>
        {question.prompt}
      </div>
      {question.instruction && (
        <p className="text-xs text-muted-foreground">{question.instruction}</p>
      )}
      {renderAnswerControl()}
    </Card>
  );
};

export default ReadingQuestionItem;

===== File #40: components/reading/ReadingDashboard.tsx =====
// components/reading/ReadingDashboard.tsx
import React, { useEffect, useMemo, useState } from 'react';
import Link from 'next/link';

import { Container } from '@/components/design-system/Container';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import { Alert } from '@/components/design-system/Alert';
import { Skeleton } from '@/components/design-system/Skeleton';
import { Icon } from '@/components/design-system/Icon';

type WeakArea = { label: string; reason: string; href: string; secondary?: string };
type TrendPoint = { date: string; score: number }; // 0..1
type TypeBreak = { type: 'tfng' | 'mcq' | 'matching' | 'short'; accuracy: number; attempts: number };
type TimeScore = { id: string; minutes: number; score: number };
type Recent = { slug: string; title: string; date: string; score: number; minutes: number; types: string[]; hrefReview: string };
type SavedItem = { slug: string; title: string; href: string };
type QueuedItem = { label: string; href: string };
type Quota = { dayUsed: number; dayLimit: number | null; monthUsed: number; monthLimit: number | null };

type DashboardPayload = {
  kpis?: {
    bandEstimate?: number;
    bandStd?: number;
    accuracy10?: number;       // 0..1
    accuracyDelta10?: number;  // -1..1
    avgSecPerQ?: number;
    streakDays?: number;
    totalPractices?: number;
  };
  trend?: TrendPoint[];
  byType?: TypeBreak[];
  timeVsScore?: TimeScore[];
  weakAreas?: WeakArea[];
  recent?: Recent[];
  saved?: SavedItem[];
  queued?: QueuedItem[];
  quota?: Quota;
};

type AIRecommend = {
  forecast?: { targetBand: number; etaDays: number; confidence: 'low'|'med'|'high'; rationale: string };
  actions: Array<{ label: string; reason: string; href: string; secondary?: string }>;
  tips?: string[];
};

type ForecastPayload = {
  bandNow: number;
  currentPct: number;
  targetBand: number;
  etaDays: number | null;
  confidence: 'low' | 'med' | 'high';
  rationale: string;
};

function pct(n?: number, digits = 0) {
  if (typeof n !== 'number' || !isFinite(n)) return '—';
  return `${(n * 100).toFixed(digits)}%`;
}
function band(b?: number, std?: number) {
  if (typeof b !== 'number' || !isFinite(b)) return '—';
  return typeof std === 'number' && isFinite(std) && std > 0 ? `${b.toFixed(1)} (±${std.toFixed(1)})` : b.toFixed(1);
}
function clamp01(n: number) {
  return Math.max(0, Math.min(1, Number.isFinite(n) ? n : 0));
}

export const ReadingDashboard: React.FC = () => {
  // Base dashboard
  const [data, setData] = useState<DashboardPayload | null>(null);
  const [err, setErr] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);

  // AI Coach
  const [coach, setCoach] = useState<AIRecommend | null>(null);
  const [coachErr, setCoachErr] = useState<string | null>(null);
  const [coachLoading, setCoachLoading] = useState(true);

  // Forecast
  const [fc, setFc] = useState<ForecastPayload | null>(null);
  const [fcLoading, setFcLoading] = useState(true);

  // AI Summary
  const [summary, setSummary] = useState<string>('');
  const [summaryLoading, setSummaryLoading] = useState(true);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        setLoading(true);
        const r = await fetch('/api/reading/dashboard');
        if (!r.ok) throw new Error(`Failed (${r.status})`);
        const j = (await r.json()) as DashboardPayload;
        if (!cancelled) { setData(j); setErr(null); }
      } catch (e: any) {
        if (!cancelled) { setErr(e?.message || 'Failed to load dashboard'); setData(null); }
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => { cancelled = true; };
  }, []);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        setCoachLoading(true);
        const r = await fetch('/api/ai/recommend');
        if (!r.ok) throw new Error(`Failed (${r.status})`);
        const j = (await r.json()) as AIRecommend;
        if (!cancelled) { setCoach(j); setCoachErr(null); }
      } catch (e: any) {
        if (!cancelled) { setCoachErr(e?.message || 'AI coach unavailable'); setCoach(null); }
      } finally {
        if (!cancelled) setCoachLoading(false);
      }
    })();
    return () => { cancelled = true; };
  }, []);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        setFcLoading(true);
        const r = await fetch('/api/reading/forecast?target=7.0');
        if (!r.ok) throw new Error(`Failed (${r.status})`);
        const j = (await r.json()) as ForecastPayload;
        if (!cancelled) setFc(j);
      } catch {
        if (!cancelled) setFc(null);
      } finally {
        if (!cancelled) setFcLoading(false);
      }
    })();
    return () => { cancelled = true; };
  }, []);

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        setSummaryLoading(true);
        const r = await fetch('/api/ai/summary');
        const j = await r.json();
        if (!cancelled) setSummary(j.summary || '');
      } catch {
        if (!cancelled) setSummary('');
      } finally {
        if (!cancelled) setSummaryLoading(false);
      }
    })();
    return () => { cancelled = true; };
  }, []);

  const k = data?.kpis ?? {};
  const acc10 = typeof k.accuracy10 === 'number' ? clamp01(k.accuracy10) : undefined;
  const accDelta = typeof k.accuracyDelta10 === 'number' ? k.accuracyDelta10 : undefined;

  const minutesRange = useMemo(() => {
    const xs = data?.timeVsScore?.map(d => d.minutes) ?? [];
    if (!xs.length) return { min: 0, max: 1 };
    const min = Math.min(...xs);
    const max = Math.max(...xs);
    return { min, max: Math.max(max, min + 1) };
  }, [data]);

  if (err) return <Alert variant="warning" title="Couldn’t load dashboard">{err}</Alert>;

  if (loading || !data) {
    return (
      <div className="space-y-4">
        <Card className="p-4">
          <div className="grid grid-cols-2 gap-3 md:grid-cols-5">
            {Array.from({ length: 5 }).map((_, i) => (
              <div key={i} className="space-y-2">
                <Skeleton className="h-3 w-16" />
                <Skeleton className="h-6 w-20" />
              </div>
            ))}
          </div>
        </Card>
        <div className="grid gap-4 md:grid-cols-3">
          {Array.from({ length: 4 }).map((_, i) => (
            <Card key={i} className="p-5">
              <Skeleton className="h-5 w-1/2" />
              <Skeleton className="mt-3 h-24 w-full" />
            </Card>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* KPI STRIP */}
      <Card className="p-4 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
        <div className="grid grid-cols-2 gap-3 md:grid-cols-5">
          <div className="space-y-0.5">
            <div className="text-xs text-muted-foreground">Band (Reading)</div>
            <div className="text-lg font-semibold">{band(k.bandEstimate, k.bandStd)}</div>
          </div>
          <div className="space-y-0.5">
            <div className="text-xs text-muted-foreground">Accuracy (last 10)</div>
            <div className="flex items-center gap-2">
              <span className="text-lg font-semibold">{pct(acc10)}</span>
              {typeof accDelta === 'number' && (
                <Badge variant={accDelta >= 0 ? 'success' : 'danger'} size="xs">
                  {accDelta >= 0 ? '+' : ''}{(accDelta * 100).toFixed(0)}%
                </Badge>
              )}
            </div>
          </div>
          <div className="space-y-0.5">
            <div className="text-xs text-muted-foreground">Speed</div>
            <div className="text-lg font-semibold">
              {k.avgSecPerQ ? `${(k.avgSecPerQ / 60).toFixed(2)} min/Q` : '—'}
            </div>
          </div>
          <div className="space-y-0.5">
            <div className="text-xs text-muted-foreground">Streak</div>
            <div className="text-lg font-semibold">{k.streakDays ?? '—'}d</div>
          </div>
          <div className="space-y-0.5">
            <div className="text-xs text-muted-foreground">Completed</div>
            <div className="text-lg font-semibold">{k.totalPractices ?? '—'}</div>
          </div>
        </div>
      </Card>

      {/* AI COACH */}
      <Card className="p-5 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
        <div className="mb-2 flex items-center justify-between">
          <h3 className="text-sm font-semibold inline-flex items-center gap-2">
            <Icon name="Sparkles" /> AI Coach
          </h3>
          <div className="text-xs text-muted-foreground">
            {coachLoading ? 'Generating…' : coachErr ? 'Unavailable' : 'Personalized tips'}
          </div>
        </div>

        {coachLoading && (
          <div className="grid gap-3 md:grid-cols-3">
            {Array.from({ length: 3 }).map((_, i) => (
              <div key={i} className="space-y-2">
                <Skeleton className="h-4 w-3/4" />
                <Skeleton className="h-8 w-28" />
              </div>
            ))}
          </div>
        )}

        {!coachLoading && coach && (
          <div className="space-y-4">
            {coach.forecast && (
              <div className="flex items-center gap-3 text-sm">
                <Badge variant="info" size="sm">Forecast</Badge>
                <span>
                  {`→ Band ${coach.forecast.targetBand.toFixed(1)} in ~${coach.forecast.etaDays} days `}
                  <span className="text-muted-foreground">({coach.forecast.confidence} conf.)</span>
                </span>
                <span className="text-muted-foreground">— {coach.forecast.rationale}</span>
              </div>
            )}

            <div className="grid gap-3 md:grid-cols-3">
              {coach.actions.slice(0, 3).map(a => (
                <div key={a.label} className="flex items-center justify-between gap-3 rounded-lg border border-border/60 px-3 py-2">
                  <div className="min-w-0">
                    <div className="truncate text-sm font-medium">{a.label}</div>
                    <div className="truncate text-xs text-muted-foreground">{a.reason}</div>
                  </div>
                  <div className="shrink-0 flex gap-2">
                    <Link href={a.href}><Button variant="primary" size="sm" className="rounded-ds-xl">Start</Button></Link>
                    {a.secondary && <Link href={a.secondary}><Button variant="surface" size="sm" className="rounded-ds-xl">Review</Button></Link>}
                  </div>
                </div>
              ))}
            </div>

            {coach.tips?.length ? (
              <ul className="grid gap-2 md:grid-cols-3 text-xs text-muted-foreground">
                {coach.tips.slice(0, 3).map(t => (
                  <li key={t} className="rounded-md bg-muted px-2 py-1">{t}</li>
                ))}
              </ul>
            ) : null}
          </div>
        )}

        {!coachLoading && !coach && !coachErr && (
          <div className="text-xs text-muted-foreground">No suggestions yet.</div>
        )}

        {!coachLoading && coachErr && (
          <div className="text-xs text-muted-foreground">AI coach unavailable — try again later.</div>
        )}
      </Card>

      {/* FORECAST • HEATMAP • AI SUMMARY */}
      <div className="grid gap-4 md:grid-cols-3">
        {/* Forecast */}
        <Card className="p-5 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
          <div className="flex items-center justify-between">
            <h3 className="text-sm font-semibold inline-flex items-center gap-2">
              <Icon name="TrendingUp" /> Forecast
            </h3>
            {fc && (
              <Badge variant={fc.confidence === 'high' ? 'success' : fc.confidence === 'med' ? 'info' : 'warning'} size="xs">
                {fc.confidence} conf.
              </Badge>
            )}
          </div>
          {fcLoading ? (
            <div className="mt-2">
              <Skeleton className="h-4 w-1/3" />
              <Skeleton className="mt-2 h-3 w-2/3" />
            </div>
          ) : fc ? (
            <>
              <div className="mt-2 text-sm">
                Current: <span className="font-semibold">Band {fc.bandNow.toFixed(1)}</span>
                {` → Target ${fc.targetBand.toFixed(1)} `}
                {fc.etaDays === null ? (
                  <span className="text-muted-foreground">• improve slope to reach target</span>
                ) : (
                  <span className="font-semibold">in ~{fc.etaDays} days</span>
                )}
              </div>
              <div className="mt-1 text-xs text-muted-foreground">{fc.rationale}</div>
              <div className="mt-3">
                <Link href="/reading?type=tfng" className="inline-flex">
                  <Button variant="surface" size="sm" className="rounded-ds-xl">Boost slope: weakest type</Button>
                </Link>
              </div>
            </>
          ) : (
            <div className="mt-2 text-xs text-muted-foreground">No history yet</div>
          )}
        </Card>

        {/* Heatmap */}
        <Card className="p-5 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
          <div className="mb-2 text-sm font-medium">Weak spot heatmap</div>
          <div className="grid grid-cols-2 gap-2 sm:grid-cols-4">
            {(data.byType ?? []).map((r) => {
              const acc = clamp01(r.accuracy);
              const intensity = Math.round(acc * 100);
              const bg = `hsla(260, 90%, ${95 - intensity * 0.4}%, 1)`;
              return (
                <div key={r.type} className="rounded-lg p-3" style={{ background: bg }}>
                  <div className="flex items-center justify-between">
                    <span className="text-xs font-medium capitalize">{r.type}</span>
                    <Badge size="xs" variant={acc >= 0.75 ? 'success' : acc >= 0.6 ? 'warning' : 'danger'}>
                      {(acc * 100).toFixed(0)}%
                    </Badge>
                  </div>
                  <div className="mt-1 text-[11px]">{r.attempts} attempts</div>
                </div>
              );
            })}
            {!data.byType?.length && <div className="col-span-4 text-xs text-muted-foreground">No data yet</div>}
          </div>
        </Card>

        {/* AI Summary */}
        <Card className="p-5 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
          <div className="text-sm font-semibold inline-flex items-center gap-2">
            <Icon name="Lightbulb" /> Recent Activity — AI Summary
          </div>
          {summaryLoading ? (
            <div className="mt-3 space-y-2">
              <Skeleton className="h-4 w-4/5" />
              <Skeleton className="h-4 w-3/5" />
            </div>
          ) : (
            <p className="mt-2 text-sm text-muted-foreground">{summary || 'No sessions yet.'}</p>
          )}
        </Card>
      </div>

      {/* PROGRESS (trend + time vs score) */}
      <Card className="p-5 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
        <div className="grid gap-4 md:grid-cols-2">
          {/* Trend sparkbars */}
          <div>
            <div className="mb-2 text-sm font-medium">Trend (last 20)</div>
            <div className="flex h-24 items-end gap-1">
              {(data.trend?.slice(-20) ?? []).map((p, i) => {
                const h = Math.max(6, Math.round(clamp01(p.score) * 88));
                return <div key={i} className="w-2 rounded-t bg-electricBlue/40" style={{ height: `${h}px` }} />;
              })}
              {!data.trend?.length && <div className="text-xs text-muted-foreground">No attempts yet</div>}
            </div>
          </div>

          {/* Time vs score */}
          <div>
            <div className="mb-2 text-sm font-medium">Time vs score</div>
            {data.timeVsScore?.length ? (
              <div className="relative h-28 w-full rounded border border-border/60">
                <div className="absolute left-1 top-1 text-[10px] text-muted-foreground">High score</div>
                <div className="absolute right-1 bottom-1 text-[10px] text-muted-foreground">More time</div>
                {(data.timeVsScore ?? []).slice(-40).map((pt) => {
                  const xPct = minutesRange.max === minutesRange.min
                    ? 50
                    : ((pt.minutes - minutesRange.min) / (minutesRange.max - minutesRange.min)) * 100;
                  const yPct = (1 - clamp01(pt.score)) * 100;
                  return (
                    <div
                      key={pt.id}
                      className="absolute h-2 w-2 rounded-full bg-purpleVibe/70"
                      style={{ left: `${xPct}%`, top: `${yPct}%`, transform: 'translate(-50%,-50%)' }}
                      title={`${pt.minutes}m • ${pct(pt.score)}`}
                    />
                  );
                })}
              </div>
            ) : (
              <div className="text-xs text-muted-foreground">No sessions yet</div>
            )}
          </div>
        </div>
      </Card>

      {/* RECENT */}
      <Card className="p-5 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
        <div className="flex items-center justify-between">
          <h3 className="text-sm font-semibold">Recent sessions</h3>
          <Link href="/reading/dashboard">
            <Button variant="surface" size="sm" className="rounded-ds-xl">Open full page</Button>
          </Link>
        </div>
        <div className="mt-3 overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="text-xs text-muted-foreground">
              <tr className="text-left">
                <th className="py-2 pr-4">Date</th>
                <th className="py-2 pr-4">Title</th>
                <th className="py-2 pr-4">Score</th>
                <th className="py-2 pr-4">Time</th>
                <th className="py-2 pr-4">Types</th>
                <th className="py-2 pr-0 text-right">Review</th>
              </tr>
            </thead>
            <tbody>
              {(data.recent ?? []).slice(0, 7).map((r) => (
                <tr key={r.slug} className="border-top border-border/40">
                  <td className="py-2 pr-4 whitespace-nowrap">
                    {new Date(r.date).toLocaleDateString(undefined, { month: 'short', day: '2-digit' })}
                  </td>
                  <td className="py-2 pr-4 truncate">{r.title}</td>
                  <td className="py-2 pr-4">{pct(r.score)}</td>
                  <td className="py-2 pr-4">{r.minutes}m</td>
                  <td className="py-2 pr-4 capitalize">{r.types.join(', ')}</td>
                  <td className="py-2 pr-0 text-right">
                    <Link href={r.hrefReview} className="inline-flex items-center gap-1 text-electricBlue hover:text-electricBlue/80">
                      Review <Icon name="ArrowRight" size={16} />
                    </Link>
                  </td>
                </tr>
              ))}
              {!data.recent?.length && (
                <tr><td className="py-4 text-xs text-muted-foreground" colSpan={6}>No sessions yet</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </Card>

      {/* SAVED & QUEUED */}
      <div className="grid gap-4 md:grid-cols-2">
        <Card className="p-5 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
          <h3 className="text-sm font-semibold">Saved passages</h3>
          <ul className="mt-2 space-y-2">
            {(data.saved ?? []).slice(0, 3).map((s) => (
              <li key={s.slug} className="flex items-center justify-between gap-3">
                <span className="truncate">{s.title}</span>
                <Link href={s.href}><Button variant="surface" size="sm" className="rounded-ds-xl">Continue</Button></Link>
              </li>
            ))}
            {!data.saved?.length && <li className="text-xs text-muted-foreground">Nothing saved yet</li>}
          </ul>
        </Card>

        <Card className="p-5 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
          <h3 className="text-sm font-semibold">Queued drills</h3>
          <ul className="mt-2 space-y-2">
            {(data.queued ?? []).slice(0, 3).map((q, idx) => (
              <li key={`${q.href}-${idx}`} className="flex items-center justify-between gap-3">
                <span className="truncate">{q.label}</span>
                <Link href={q.href}><Button variant="primary" size="sm" className="rounded-ds-xl">Start</Button></Link>
              </li>
            ))}
            {!data.queued?.length && <li className="text-xs text-muted-foreground">No queued drills</li>}
          </ul>
        </Card>
      </div>
    </div>
  );
};

export default ReadingDashboard;

===== File #41: components/reading/StickyNotePopover.tsx =====

===== File #42: components/reading/QuestionBlock.tsx =====
import React from 'react';
import { Badge } from '@/components/design-system/Badge';
import { Input } from '@/components/design-system/Input';
import { Button } from '@/components/design-system/Button';

type BaseQ = { id: string; qNo: number; type: string; prompt: string };
type MCQ = BaseQ & { type: 'mcq'; options: string[] };
type TFNG = BaseQ & { type: 'tfng' };
type YNNG = BaseQ & { type: 'ynng' };
type GAP = BaseQ & { type: 'gap' };
type MATCH = BaseQ & { type: 'match'; options: string[]; pairs: { left: string; right: string }[] };
type Question = MCQ | TFNG | YNNG | GAP | MATCH;

export const QuestionBlock: React.FC<{
  q: Question;
  value: any;
  flagged?: boolean;
  onFlag?: () => void;
  onChange: (val: any) => void;
}> = ({ q, value, flagged = false, onFlag, onChange }) => {
  const answered = !(value == null || value === '');

  return (
    <div
      data-qid={q.id}
      className={`p-4 rounded-ds border ${
        flagged ? 'border-goldenYellow/60' : 'border-lightBorder dark:border-white/10'
      }`}
    >
      <div className="flex items-start justify-between gap-3">
        <div className="text-small text-muted-foreground">
          Q{q.qNo} — {q.type.toUpperCase()}
        </div>
        <div className="flex items-center gap-2">
          {flagged && <Badge variant="warning" size="sm">Flagged</Badge>}
          <Badge variant={answered ? 'success' : 'neutral'} size="sm">
            {answered ? 'Answered' : 'Unanswered'}
          </Badge>
          <Button
            variant="secondary"
            className="rounded-ds px-3 py-1"
            onClick={onFlag}
            aria-pressed={flagged}
            aria-label="Flag question (F)"
          >
            {flagged ? 'Unflag' : 'Flag'} (F)
          </Button>
        </div>
      </div>

      <p className="mt-2 font-medium">{q.prompt}</p>

      {/* Render by type */}
      <div className="mt-3">
        {q.type === 'mcq' && (
          <div className="grid gap-2" role="radiogroup" aria-label={`Question ${q.qNo} options`}>
            {(q as MCQ).options.map((opt, i) => {
              const id = `${q.id}:${opt}`;
              return (
                <label
                  key={id}
                  className="flex items-center gap-2 p-3 rounded-ds border border-lightBorder dark:border-white/10 cursor-pointer"
                >
                  <input
                    type="radio"
                    name={q.id}
                    checked={value === opt}
                    onChange={() => onChange(opt)}
                    aria-label={`Option ${i + 1}: ${opt}`}
                  />
                  <span>
                    <kbd className="px-1.5 py-0.5 rounded-ds bg-muted/60 dark:bg-white/10 mr-2">
                      {i + 1}
                    </kbd>
                    {opt}
                  </span>
                </label>
              );
            })}
          </div>
        )}

        {q.type === 'tfng' && (
          <div className="flex flex-wrap gap-2" aria-label={`Question ${q.qNo} TFNG`}>
            {(['True', 'False', 'Not Given'] as const).map((opt) => (
              <Button
                key={opt}
                variant={value === opt ? 'primary' : 'secondary'}
                className="rounded-ds"
                onClick={() => onChange(opt)}
              >
                {opt}{' '}
                {opt === 'True' && <span className="opacity-70 ml-1">(T)</span>}
                {opt === 'False' && <span className="opacity-70 ml-1">(F)</span>}
                {opt === 'Not Given' && <span className="opacity-70 ml-1">(N)</span>}
              </Button>
            ))}
          </div>
        )}

        {q.type === 'ynng' && (
          <div className="flex flex-wrap gap-2" aria-label={`Question ${q.qNo} Y/NNG`}>
            {(['Yes', 'No', 'Not Given'] as const).map((opt) => (
              <Button
                key={opt}
                variant={value === opt ? 'primary' : 'secondary'}
                className="rounded-ds"
                onClick={() => onChange(opt)}
              >
                {opt}{' '}
                {opt === 'Yes' && <span className="opacity-70 ml-1">(Y)</span>}
                {opt === 'No' && <span className="opacity-70 ml-1">(N)</span>}
                {opt === 'Not Given' && <span className="opacity-70 ml-1">(G)</span>}
              </Button>
            ))}
          </div>
        )}

        {q.type === 'gap' && (
          <div className="max-w-md">
            <Input
              aria-label={`Answer for question ${q.qNo}`}
              placeholder="Type your answer"
              value={value ?? ''}
              onChange={(e) => onChange(e.currentTarget.value)}
            />
            <p className="text-small text-muted-foreground mt-1">
              Press{' '}
              <kbd className="px-1 rounded-ds bg-muted/60 dark:bg-white/10">
                Enter
              </kbd>{' '}
              to jump to next unanswered.
            </p>
          </div>
        )}

        {q.type === 'match' && (
          <div className="grid sm:grid-cols-2 gap-3" aria-label={`Matching for question ${q.qNo}`}>
            {(q as MATCH).pairs.map((p, idx) => (
              <div
                key={`${q.id}:${idx}`}
                className="p-3 rounded-ds border border-lightBorder dark:border-white/10"
              >
                <div className="text-small text-muted-foreground mb-1">{p.left}</div>
                <select
                  className="w-full bg-white dark:bg-dark/50 border border-lightBorder dark:border-white/10 rounded-ds p-2"
                  value={(value && value[p.left]) || ''}
                  onChange={(e) => onChange({ ...(value || {}), [p.left]: e.currentTarget.value })}
                  aria-label={`Select match for ${p.left}`}
                >
                  <option value="">— Select —</option>
                  {(q as MATCH).options.map((o) => (
                    <option key={o} value={o}>
                      {o}
                    </option>
                  ))}
                </select>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

===== File #43: components/reading/ReadingAttemptsTable.tsx =====

===== File #44: components/reading/ReadingHeatmap.tsx =====
// components/reading/ReadingHeatmap.tsx
import React from 'react';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';

type Row = { type: 'tfng' | 'mcq' | 'matching' | 'short'; accuracy: number; attempts: number };

const LABELS = { tfng: 'TFNG', mcq: 'MCQ', matching: 'Matching', short: 'Short' } as const;

export const ReadingHeatmap: React.FC<{ data: Row[] }> = ({ data }) => {
  const rows = (data ?? []).map(d => ({ ...d, acc: Math.max(0, Math.min(1, d.accuracy)) }));
  return (
    <Card className="p-5 border-border/60 bg-white/70 backdrop-blur dark:bg-dark/70">
      <div className="mb-2 text-sm font-medium">Weak spot heatmap</div>
      <div className="grid grid-cols-4 gap-2">
        {rows.map((r) => {
          const intensity = Math.round(r.acc * 100);
          const bg = `hsla(260, 90%, ${95 - intensity * 0.4}%, 1)`; // lighter when lower acc
          const text = r.acc >= 0.7 ? 'text-foreground' : 'text-foreground';
          return (
            <div key={r.type} className="rounded-lg p-3" style={{ background: bg }}>
              <div className="flex items-center justify-between">
                <span className="text-xs font-medium">{LABELS[r.type]}</span>
                <Badge size="xs" variant={r.acc >= 0.75 ? 'success' : r.acc >= 0.6 ? 'warning' : 'danger'}>
                  {(r.acc * 100).toFixed(0)}%
                </Badge>
              </div>
              <div className={`mt-1 text-[11px] ${text}`}>{r.attempts} attempts</div>
            </div>
          );
        })}
        {!rows.length && <div className="col-span-4 text-xs text-muted-foreground">No data yet</div>}
      </div>
    </Card>
  );
};

===== File #45: components/reading/answer-sheet/ReadingAnswerSheetGrid.tsx =====
import * as React from 'react';

import { Card } from '@/components/design-system/Card';

// Props for the ReadingAnswerSheetGrid. It takes the number of
// questions and a map of answers keyed by question order (1-indexed).
type ReadingAnswerSheetGridProps = {
  totalQuestions: number;
  answers: Record<number, string | string[] | null>;
};

/**
 * Displays a simple grid representing the user's answers to each
 * question. Answered questions are highlighted differently to provide
 * a quick overview of which questions were attempted.
 */
export const ReadingAnswerSheetGrid: React.FC<ReadingAnswerSheetGridProps> = ({
  totalQuestions,
  answers,
}) => {
  const cells = [];
  for (let i = 1; i <= totalQuestions; i++) {
    const hasAnswer = answers[i] != null;
    cells.push(
      <div
        key={i}
        className={
          'p-2 text-center border text-xs ' +
          (hasAnswer
            ? 'bg-emerald-50 text-emerald-700'
            : 'bg-muted/20 text-muted-foreground')
        }
      >
        {i}
      </div>,
    );
  }
  return (
    <Card className="p-3 space-y-2">
      <p className="text-xs font-medium">Answer sheet</p>
      <div className="grid grid-cols-10 gap-1">{cells}</div>
    </Card>
  );
};

export default ReadingAnswerSheetGrid;

===== File #46: components/reading/ReadingFilterBar.tsx =====
import React from 'react';
import { useRouter } from 'next/router';
import { Button } from '@/components/design-system/Button';

const TYPES = [
  { key: 'all', label: 'All' },
  { key: 'tfng', label: 'True/False/Not Given' },
  { key: 'mcq', label: 'MCQ' },
  { key: 'matching', label: 'Matching' },
  { key: 'short', label: 'Short Answer' },
];

export const ReadingFilterBar: React.FC<{ className?: string }> = ({ className = '' }) => {
  const router = useRouter();
  const active = (router.query.type as string) || 'all';

  const setType = (t: string) => {
    router.push({ pathname: router.pathname, query: { ...router.query, type: t } }, undefined, { shallow: true });
  };

  return (
    <div className={`flex flex-wrap gap-2 ${className}`}>
      {TYPES.map((t) => (
        <Button
          key={t.key}
          onClick={() => setType(t.key)}
          variant={active === t.key ? 'primary' : 'secondary'}
          className="rounded-ds"
        >
          {t.label}
        </Button>
      ))}
    </div>
  );
};

===== File #47: components/reading/ReadingResultSummary.tsx =====
// components/reading/ReadingResultSummary.tsx
import * as React from 'react';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Icon } from '@/components/design-system/Icon';

type AttemptSummary = {
  id: string;
  rawScore: number | null;
  bandScore: number | null;
  questionCount: number | null;
  durationSeconds: number | null;
  createdAt: string;
};

type TestSummary = {
  id: string;
  slug: string;
  title: string;
  examType: string;
  totalQuestions: number | null;
  durationSeconds: number | null;
};

type Props = {
  attempt: AttemptSummary;
  test: TestSummary;
};

export const ReadingResultSummary: React.FC<Props> = ({ attempt, test }) => {
  const totalQs = attempt.questionCount ?? test.totalQuestions ?? 40;
  const raw = attempt.rawScore ?? 0;
  const band = attempt.bandScore ?? null;

  const accuracy = totalQs > 0 ? Math.round((raw / totalQs) * 100) : 0;

  const mins = attempt.durationSeconds
    ? Math.floor(attempt.durationSeconds / 60)
    : Math.round((test.durationSeconds ?? 3600) / 60);

  let bandTone: 'good' | 'ok' | 'low' = 'ok';
  if (band != null) {
    if (band >= 7) bandTone = 'good';
    else if (band < 6) bandTone = 'low';
  }

  const bandBadgeClass =
    bandTone === 'good'
      ? 'bg-emerald-500/10 text-emerald-600 border-emerald-500/40'
      : bandTone === 'low'
      ? 'bg-destructive/10 text-destructive border-destructive/40'
      : 'bg-amber-500/10 text-amber-700 border-amber-500/40';

  return (
    <Card className="p-6 space-y-4">
      <div className="flex flex-wrap items-center justify-between gap-4">
        <div className="space-y-2">
          <div className="flex items-center gap-2">
            <Badge
              variant="outline"
              className={bandBadgeClass + ' border text-xs font-semibold'}
            >
              Band{' '}
              {band != null ? band.toFixed(1) : '—'}
            </Badge>
            <span className="text-xs text-muted-foreground">
              Accuracy {accuracy}% ({raw}/{totalQs})
            </span>
          </div>
          <p className="text-xs text-muted-foreground max-w-md">
            This band is an estimate based on your raw score out of {totalQs} questions. Use it
            as a signal, then dig into your detailed review to fix weaknesses.
          </p>
        </div>
        <div className="flex flex-col items-end gap-1 text-xs text-muted-foreground">
          <span className="inline-flex items-center gap-1">
            <Icon name="clock" className="h-3.5 w-3.5" />
            Time used: {mins} min
          </span>
          <span className="inline-flex items-center gap-1">
            <Icon name="book-open" className="h-3.5 w-3.5" />
            {test.examType === 'gt' ? 'General Training' : 'Academic'} Reading
          </span>
        </div>
      </div>

      <div className="grid gap-3 sm:grid-cols-3 text-xs">
        <div className="rounded-ds border border-lightBorder/70 p-3">
          <p className="text-[11px] text-muted-foreground uppercase tracking-[0.16em] mb-1">
            Raw score
          </p>
          <p className="text-sm font-semibold">
            {raw}/{totalQs}
          </p>
        </div>
        <div className="rounded-ds border border-lightBorder/70 p-3">
          <p className="text-[11px] text-muted-foreground uppercase tracking-[0.16em] mb-1">
            Estimated band
          </p>
          <p className="text-sm font-semibold">
            {band != null ? band.toFixed(1) : '—'}
          </p>
        </div>
        <div className="rounded-ds border border-lightBorder/70 p-3">
          <p className="text-[11px] text-muted-foreground uppercase tracking-[0.16em] mb-1">
            Speed
          </p>
          <p className="text-sm font-semibold">
            {mins} min · {totalQs > 0 ? Math.round(totalQs / (mins || 1)) : 0} Q/min (approx)
          </p>
        </div>
      </div>
    </Card>
  );
};

export default ReadingResultSummary;

===== File #48: components/reading/templates.ts =====
import { AnswerValue } from './useReadingAnswers';

export type TFNGTemplate = {
  kind: 'tfng';
  id: string;
  prompt: string;
  correct: 'True' | 'False' | 'Not Given';
};

export type MCQTemplate = {
  kind: 'mcq';
  id: string;
  prompt: string;
  options: string[];
  correct: string;
};

export type MatchingTemplate = {
  kind: 'matching';
  id: string;
  prompt: string;
  pairs: { left: string; right: string[] }[];
  correct: string[];
};

export type ShortTemplate = {
  kind: 'short';
  id: string;
  prompt: string;
  acceptable: string[];
};

export type QuestionTemplate =
  | TFNGTemplate
  | MCQTemplate
  | MatchingTemplate
  | ShortTemplate;

function norm(val: any) {
  return String(val).trim().replace(/\s+/g, ' ').toLowerCase();
}

export function scoreQuestion(
  tmpl: QuestionTemplate,
  answer: AnswerValue,
): number {
  switch (tmpl.kind) {
    case 'tfng':
    case 'mcq':
      return answer != null && String(answer) === String(tmpl.correct) ? 1 : 0;
    case 'short': {
      const ans = String(answer ?? '');
      return tmpl.acceptable.some((a) => norm(a) === norm(ans)) ? 1 : 0;
    }
    case 'matching': {
      if (!Array.isArray(answer)) return 0;
      return answer.length === tmpl.correct.length &&
        answer.every((a, i) => norm(a) === norm(tmpl.correct[i]))
        ? 1
        : 0;
    }
    default:
      return 0;
  }
}

export const exampleTFNG: TFNGTemplate = {
  kind: 'tfng',
  id: 'tf1',
  prompt: 'The sky is blue.',
  correct: 'True',
};

export const exampleMatching: MatchingTemplate = {
  kind: 'matching',
  id: 'm1',
  prompt: 'Match animals to habitats',
  pairs: [
    { left: 'Camel', right: ['Desert', 'Forest'] },
    { left: 'Penguin', right: ['Antarctica', 'Jungle'] },
  ],
  correct: ['Desert', 'Antarctica'],
};

===== File #49: components/reading/ReadingStatsCard.tsx =====
import React from 'react';
import Link from 'next/link';
import { supabaseBrowser } from '@/lib/supabaseBrowser';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';

type Stat = {
  user_id: string;
  attempts: number;
  total_score: number;
  total_max: number;
  accuracy_pct: number | null;
  avg_duration_ms: number | null;
  first_attempt_at: string | null;
  last_attempt_at: string | null;
};

type Attempt = {
  id: string;
  passage_slug: string;
  score: number;
  max_score: number;
  created_at: string;
};

export function ReadingStatsCard() {
  const [loading, setLoading] = React.useState(true);
  const [stat, setStat] = React.useState<Stat | null>(null);
  const [recent, setRecent] = React.useState<Attempt[]>([]);
  const [isAuthed, setIsAuthed] = React.useState<boolean>(false);

  React.useEffect(() => {
    let active = true;
    (async () => {
      setLoading(true);
      const { data: { session } } = await supabaseBrowser.auth.getSession();
      const uid = session?.user?.id;
      setIsAuthed(!!uid);

      if (!uid) {
        setLoading(false);
        return;
      }

      const [statRes, attemptsRes] = await Promise.all([
        supabaseBrowser
          .from('reading_user_stats')
          .select('*')
          .eq('user_id', uid)
          .single(),
        supabaseBrowser
          .from('reading_attempts')
          .select('id, passage_slug, score, max_score, created_at')
          .order('created_at', { ascending: false })
          .limit(5),
      ]);

      if (!active) return;
      if (!statRes.error && statRes.data) setStat(statRes.data as Stat);
      if (!attemptsRes.error && attemptsRes.data) setRecent(attemptsRes.data as Attempt[]);
      setLoading(false);
    })();
    return () => { active = false; };
  }, []);

  if (loading) {
    return (
      <Card className="p-6">
        <div className="animate-pulse h-5 w-40 bg-muted dark:bg-white/10 rounded mb-3" />
        <div className="animate-pulse h-4 w-64 bg-muted dark:bg-white/10 rounded" />
      </Card>
    );
  }

  if (!isAuthed) {
    return (
      <Card className="p-6 flex items-center justify-between">
        <div>
          <div className="font-semibold mb-1">Reading progress</div>
          <div className="text-small text-grayish dark:text-muted-foreground">Sign in to track your attempts and accuracy.</div>
        </div>
        <Button href="/login" variant="primary" className="rounded-ds-xl">Sign in</Button>
      </Card>
    );
  }

  return (
    <Card className="p-6">
      <div className="flex items-center justify-between mb-4">
        <div className="font-semibold">Reading progress</div>
        {stat?.accuracy_pct != null && (
          <Badge>{stat.accuracy_pct}% accuracy</Badge>
        )}
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div>
          <div className="text-small text-grayish dark:text-muted-foreground">Attempts</div>
          <div className="text-h3 font-semibold">{stat?.attempts ?? 0}</div>
        </div>
        <div>
          <div className="text-small text-grayish dark:text-muted-foreground">Points</div>
          <div className="text-h3 font-semibold">{stat?.total_score ?? 0}/{stat?.total_max ?? 0}</div>
        </div>
        <div>
          <div className="text-small text-grayish dark:text-muted-foreground">Avg. duration</div>
          <div className="text-h3 font-semibold">
            {stat?.avg_duration_ms ? Math.round((stat.avg_duration_ms / 1000) / 60) + ' min' : '—'}
          </div>
        </div>
        <div>
          <div className="text-small text-grayish dark:text-muted-foreground">Last attempt</div>
          <div className="text-h3 font-semibold">
            {stat?.last_attempt_at ? new Date(stat.last_attempt_at).toLocaleDateString() : '—'}
          </div>
        </div>
      </div>

      <div className="mb-3 font-medium">Recent attempts</div>
      {recent.length === 0 ? (
        <div className="text-small text-grayish dark:text-muted-foreground">No attempts yet. Try a passage to see your stats.</div>
      ) : (
        <ul className="grid gap-2">
          {recent.map(a => (
            <li key={a.id} className="flex items-center justify-between">
              <div className="truncate">
                <Link
                  href={`/reading/${encodeURIComponent(a.passage_slug)}/review?attemptId=${a.id}`}
                  className="underline"
                >
                  {a.passage_slug}
                </Link>
                <span className="ml-2 text-small text-grayish dark:text-muted-foreground">
                  {new Date(a.created_at).toLocaleString()}
                </span>
              </div>
              <Badge>{a.score}/{a.max_score}</Badge>
            </li>
          ))}
        </ul>
      )}

      <div className="mt-6 flex gap-2">
        <Button as="a" href="/reading" variant="secondary" className="rounded-ds-xl">Browse passages</Button>
        <Button as="a" href="/reading/passage/reading-test-38" variant="primary" className="rounded-ds-xl">Start now</Button>
      </div>
    </Card>
  );
}

===== File #50: components/reading/daily/DailyChallengeBanner.tsx =====
import * as React from 'react';

import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';

// Props for the DailyChallengeBanner. It accepts the current streak
// count so that the message can encourage users to continue.
type DailyChallengeBannerProps = {
  streakCurrent: number;
};

/**
 * A small banner displayed on the Reading mocks home page to remind
 * users about the daily challenge. It shows the current streak and
 * encourages users to complete today's challenge to keep the streak
 * alive.
 */
export const DailyChallengeBanner: React.FC<DailyChallengeBannerProps> = ({ streakCurrent }) => {
  return (
    <Card className="p-4 flex items-center justify-between text-xs">
      <div className="space-y-0.5">
        <p className="font-medium">Daily challenge</p>
        <p className="text-muted-foreground">
          You have a {streakCurrent}-day streak. Complete today’s challenge to maintain it.
        </p>
      </div>
      <Badge size="xs" variant="outline">
        Day {streakCurrent}
      </Badge>
    </Card>
  );
};

export default DailyChallengeBanner;

===== File #51: components/reading/daily/DailyStreakCard.tsx =====
import * as React from 'react';

import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';

// Props for the DailyStreakCard. The streak consists of the current
// consecutive days of activity and the longest streak ever achieved.
type DailyStreakProps = {
  streak: {
    currentStreak: number;
    longestStreak: number;
  };
};

/**
 * Displays the user's current and longest Reading streaks. This
 * component provides a simple visual indicator to motivate users to
 * maintain their daily habit.
 */
export const DailyStreakCard: React.FC<DailyStreakProps> = ({ streak }) => {
  const { currentStreak, longestStreak } = streak;
  return (
    <Card className="p-4 flex items-center justify-between text-xs">
      <div className="space-y-0.5">
        <p className="font-medium">
          Current streak: {currentStreak} day{currentStreak === 1 ? '' : 's'}
        </p>
        <p className="text-muted-foreground">
          Longest streak: {longestStreak} day{longestStreak === 1 ? '' : 's'}
        </p>
      </div>
      <Badge size="xs" variant="outline">
        Keep it up!
      </Badge>
    </Card>
  );
};

export default DailyStreakCard;

===== File #52: components/reading/useReadingAnswers.ts =====
'use client';
import { useCallback, useEffect, useMemo, useState } from 'react';

/**
 * Minimal client store for Reading answers (per passage).
 * - Persists to localStorage under key `reading:<slug>:answers`
 * - API: setAnswer, clear, allAnswers
 */
export type AnswerValue = string | number | boolean | string[] | null;

export function useReadingAnswers(slug: string) {
  const storageKey = useMemo(() => `reading:${slug}:answers`, [slug]);
  const [answers, setAnswers] = useState<Record<string, AnswerValue>>({});

  useEffect(() => {
    if (typeof window === 'undefined') return;
    try {
      const merged: Record<string, AnswerValue> = {};
      const legacyKeys = [storageKey, `reading:${slug}`, `readingAnswers:${slug}`];
      legacyKeys.forEach((key) => {
        const raw = localStorage.getItem(key);
        if (!raw) return;
        try {
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
            Object.assign(merged, parsed as Record<string, AnswerValue>);
          }
        } catch {
          // ignore malformed payloads
        }
      });

      setAnswers(merged);

      if (Object.keys(merged).length) {
        try { localStorage.setItem(storageKey, JSON.stringify(merged)); } catch {}
      }

      legacyKeys
        .filter((key) => key !== storageKey)
        .forEach((key) => {
          try { localStorage.removeItem(key); } catch {}
        });
    } catch {
      // ignore hydration failures
    }
  }, [slug, storageKey]);

  const persist = useCallback((
    next: Record<string, AnswerValue> | ((prev: Record<string, AnswerValue>) => Record<string, AnswerValue>),
  ) => {
    setAnswers((prev) => {
      const computed = typeof next === 'function' ? next(prev) : next;
      try {
        if (Object.keys(computed).length) localStorage.setItem(storageKey, JSON.stringify(computed));
        else localStorage.removeItem(storageKey);
      } catch {}
      return computed;
    });
  }, [storageKey]);

  const setAnswer = useCallback((id: string, value: AnswerValue) => {
    persist((prev) => ({ ...prev, [id]: value }));
  }, [persist]);

  const clear = useCallback(() => {
    persist({});
  }, [persist]);

  const allAnswers = useCallback(() => answers, [answers]);

  return { answers, setAnswer, clear, allAnswers };
}

export type ReadingAnswersStore = ReturnType<typeof useReadingAnswers>;

===== File #53: components/reading/ai/KeywordSuggestionButton.tsx =====

===== File #54: components/reading/ai/VocabularyPanel.tsx =====

===== File #55: components/reading/review/ReadingReviewKeywordsPanel.tsx =====

===== File #56: components/reading/review/ReadingReviewSidebar.tsx =====

===== File #57: components/reading/review/ReadingReviewShell.tsx =====
import * as React from 'react';

import type {
  ReadingTest,
  ReadingPassage,
  ReadingQuestion,
} from '@/lib/reading/types';
import { ReadingReviewSummaryBar } from './ReadingReviewSummaryBar';
import { ReadingReviewQuestionItem } from './ReadingReviewQuestionItem';
import { Card } from '@/components/design-system/Card';

type ReviewAnswer = {
  questionId: string;
  isCorrect: boolean;
  selectedAnswer: string | string[] | null;
};

type AttemptSummary = {
  id: string;
  rawScore: number | null;
  bandScore: number | null;
  questionCount: number | null;
  createdAt: string;
  durationSeconds: number | null;
};

type ReadingReviewShellProps = {
  test: ReadingTest;
  passages: ReadingPassage[];
  questions: ReadingQuestion[];
  attempt: AttemptSummary;
  answers: ReviewAnswer[];
};

/**
 * Review shell: top summary + per-passage grouped questions.
 */
export const ReadingReviewShell: React.FC<ReadingReviewShellProps> = ({
  test,
  passages,
  questions,
  attempt,
  answers,
}) => {
  const answerMap = React.useMemo(() => {
    const map = new Map<string, ReviewAnswer>();
    answers.forEach((a) => map.set(a.questionId, a));
    return map;
  }, [answers]);

  const totalQuestions =
    attempt.questionCount ?? test.totalQuestions ?? questions.length;

  const correctCount = React.useMemo(
    () => answers.filter((a) => a.isCorrect).length,
    [answers],
  );

  const groupedByPassage = React.useMemo(() => {
    const byId = new Map<string | null, ReadingQuestion[]>();
    questions.forEach((q) => {
      const key = ((q as any).passageId ?? null) as string | null;
      if (!byId.has(key)) byId.set(key, []);
      byId.get(key)!.push(q);
    });
    return byId;
  }, [questions]);

  const passageById = React.useMemo(() => {
    const m = new Map<string, ReadingPassage>();
    passages.forEach((p) => m.set((p as any).id as string, p));
    return m;
  }, [passages]);

  return (
    <div className="space-y-6">
      <ReadingReviewSummaryBar
        testTitle={test.title}
        bandScore={attempt.bandScore}
        rawScore={attempt.rawScore}
        totalQuestions={totalQuestions}
        correctCount={correctCount}
        createdAt={attempt.createdAt}
        durationSeconds={attempt.durationSeconds ?? undefined}
      />

      {[...groupedByPassage.entries()]
        .sort(([aKey], [bKey]) => {
          if (!aKey && !bKey) return 0;
          if (!aKey) return -1;
          if (!bKey) return 1;
          const aPassage = passageById.get(aKey);
          const bPassage = passageById.get(bKey);
          return (aPassage?.passageOrder ?? 0) - (bPassage?.passageOrder ?? 0);
        })
        .map(([passageId, qs]) => {
          const passage = passageId ? passageById.get(passageId) : null;

          return (
            <div key={passageId ?? 'no-passage'} className="space-y-3">
              {passage && (
                <Card className="px-4 py-2 text-xs bg-surface-subtle border border-border/70">
                  <p className="font-medium">
                    Passage {passage.passageOrder}
                    {passage.title ? `: ${passage.title}` : ''}
                  </p>
                </Card>
              )}

              <div className="space-y-2">
                {qs.map((q) => {
                  const ans = answerMap.get(q.id);
                  return (
                    <ReadingReviewQuestionItem
                      key={q.id}
                      question={q}
                      userAnswer={ans?.selectedAnswer ?? null}
                      isCorrect={ans?.isCorrect ?? false}
                    />
                  );
                })}
              </div>
            </div>
          );
        })}
    </div>
  );
};

export default ReadingReviewShell;

===== File #58: components/reading/review/ReadingReviewQuestionItem.tsx =====
import * as React from 'react';

import type { ReadingQuestion } from '@/lib/reading/types';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';

type ReadingReviewQuestionItemProps = {
  question: ReadingQuestion;
  userAnswer: string | string[] | null;
  isCorrect: boolean;
};

export const ReadingReviewQuestionItem: React.FC<
  ReadingReviewQuestionItemProps
> = ({ question, userAnswer, isCorrect }) => {
  const formatAnswer = (ans: any): string => {
    if (ans == null) return '-';
    if (Array.isArray(ans)) return ans.join(', ');
    return String(ans);
  };

  const borderTone = isCorrect
    ? 'border-emerald-500/50 bg-emerald-500/5'
    : 'border-destructive/40 bg-destructive/5';

  return (
    <Card
      className={`p-3 space-y-2 text-sm border-l-4 ${
        isCorrect ? 'border-l-emerald-500' : 'border-l-destructive'
      }`}
    >
      <div className="flex items-center justify-between gap-3">
        <p className="flex-1">
          <span className="font-medium mr-1">
            {(question as any).questionOrder}.
          </span>
          {question.prompt}
        </p>
        <Badge
          size="xs"
          variant="outline"
          className={borderTone + ' text-[10px] font-semibold uppercase'}
        >
          {isCorrect ? 'Correct' : 'Incorrect'}
        </Badge>
      </div>

      {question.instruction && (
        <p className="text-xs text-muted-foreground">{question.instruction}</p>
      )}

      <div className="text-xs space-y-0.5">
        <p>
          Your answer:{' '}
          <span className="font-medium">
            {formatAnswer(userAnswer)}
          </span>
        </p>
        <p>
          Correct answer:{' '}
          <span className="font-medium">
            {formatAnswer((question as any).correctAnswer)}
          </span>
        </p>
      </div>
    </Card>
  );
};

export default ReadingReviewQuestionItem;

===== File #59: components/reading/review/ReadingReviewSummaryBar.tsx =====
import * as React from 'react';

import { Card } from '@/components/design-system/Card';

// Props describing the information required to summarise a reading
// attempt in the review view. All numeric fields may be null when
// information is unavailable.
type ReadingReviewSummaryBarProps = {
  testTitle: string;
  bandScore: number | null;
  rawScore: number | null;
  totalQuestions: number | null;
  createdAt: string;
  durationSeconds?: number;
};

/**
 * Displays a concise summary of a completed reading attempt, including
 * the test title, date completed, band score, raw/total score and
 * duration. It is typically rendered at the top of the review page.
 */
export const ReadingReviewSummaryBar: React.FC<ReadingReviewSummaryBarProps> = ({
  testTitle,
  bandScore,
  rawScore,
  totalQuestions,
  createdAt,
  durationSeconds,
}) => {
  return (
    <Card className="p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between text-xs">
      <div className="space-y-0.5">
        <p className="font-medium">{testTitle}</p>
        <p className="text-muted-foreground">
          Completed on {new Date(createdAt).toLocaleDateString()}
        </p>
      </div>
      <div className="flex gap-4 pt-2 sm:pt-0">
        <div>
          <p className="font-medium">
            {bandScore != null ? bandScore.toFixed(1) : '-'}
          </p>
          <p className="text-muted-foreground">Band</p>
        </div>
        <div>
          <p className="font-medium">
            {rawScore != null ? rawScore : '-'} / {totalQuestions != null ? totalQuestions : '-'}
          </p>
          <p className="text-muted-foreground">Correct</p>
        </div>
        {durationSeconds != null && (
          <div>
            <p className="font-medium">{Math.round(durationSeconds / 60)} min</p>
            <p className="text-muted-foreground">Duration</p>
          </div>
        )}
      </div>
    </Card>
  );
};

export default ReadingReviewSummaryBar;

===== File #60: components/reading/ReadingTimerBar.tsx =====

===== File #61: components/reading/history/ReadingHistoryTable.tsx =====
// components/reading/history/ReadingHistoryTable.tsx
import * as React from 'react';
import Link from 'next/link';

import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import { Icon } from '@/components/design-system/Icon';
import { cn } from '@/lib/utils';

export type ReadingHistoryRow = {
  attemptId: string;
  testSlug: string;
  testTitle: string;
  bandScore: number | null;
  rawScore: number | null;
  totalQuestions: number | null;
  createdAt: string;
};

type Props = {
  rows: ReadingHistoryRow[];
  className?: string;
};

export const ReadingHistoryTable: React.FC<Props> = ({ rows, className }) => {
  if (!rows.length) {
    return (
      <Card className={cn('p-6 text-center text-sm text-muted-foreground', className)}>
        No reading attempts yet. Start a strict mock and your history will appear here.
      </Card>
    );
  }

  return (
    <Card className={cn('p-0 overflow-hidden', className)}>
      <div className="min-w-full divide-y divide-border text-xs">
        <div className="grid grid-cols-[minmax(0,2.2fr)_minmax(0,0.8fr)_minmax(0,0.8fr)_minmax(0,1fr)] gap-3 bg-surface-subtle px-4 py-3 font-medium text-muted-foreground uppercase tracking-[0.14em]">
          <div>Test</div>
          <div>Band</div>
          <div>Score</div>
          <div className="text-right">Actions</div>
        </div>
        {rows.map((row) => {
          const total = row.totalQuestions ?? 40;
          const raw = row.rawScore ?? 0;
          const band = row.bandScore ?? null;
          const accuracy = total > 0 ? Math.round((raw / total) * 100) : 0;

          let bandTone: 'good' | 'ok' | 'low' = 'ok';
          if (band != null) {
            if (band >= 7) bandTone = 'good';
            else if (band < 6) bandTone = 'low';
          }

          const bandBadgeClass =
            bandTone === 'good'
              ? 'bg-emerald-500/10 text-emerald-600 border-emerald-500/40'
              : bandTone === 'low'
              ? 'bg-destructive/10 text-destructive border-destructive/40'
              : 'bg-amber-500/10 text-amber-700 border-amber-500/40';

          return (
            <div
              key={row.attemptId}
              className="grid grid-cols-[minmax(0,2.2fr)_minmax(0,0.8fr)_minmax(0,0.8fr)_minmax(0,1fr)] gap-3 px-4 py-3 items-center border-t border-border/60"
            >
              <div className="space-y-1">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-medium truncate">
                    {row.testTitle}
                  </span>
                </div>
                <div className="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                  <span>
                    Attempted on {new Date(row.createdAt).toLocaleString()}
                  </span>
                </div>
              </div>

              <div className="flex flex-col gap-1">
                <Badge
                  variant="outline"
                  className={cn('w-fit px-2 py-0.5 text-[11px]', bandBadgeClass)}
                >
                  {band != null ? `Band ${band.toFixed(1)}` : 'Band —'}
                </Badge>
                <span className="text-[11px] text-muted-foreground">
                  Accuracy {accuracy}%{' '}
                </span>
              </div>

              <div className="flex flex-col text-[11px] text-muted-foreground">
                <span>
                  {raw}/{total} correct
                </span>
              </div>

              <div className="flex items-center justify-end gap-2">
                <Button asChild size="xs" variant="outline">
                  <Link href={`/mock/reading/result/${row.attemptId}`}>
                    <Icon name="file-text" className="h-3.5 w-3.5 mr-1" />
                    Result
                  </Link>
                </Button>
                <Button asChild size="xs" variant="ghost">
                  <Link href={`/mock/reading/review/${row.attemptId}`}>
                    <Icon name="eye" className="h-3.5 w-3.5 mr-1" />
                    Review
                  </Link>
                </Button>
              </div>
            </div>
          );
        })}
      </div>
    </Card>
  );
};

export default ReadingHistoryTable;

===== File #62: components/reading/ReadingMobileToggle.tsx =====

===== File #63: components/reading/ReadingForecastPanel.tsx =====
// components/reading/ReadingForecastPanel.tsx
import React, { useEffect, useState } from 'react';
import { Card } from '@/components/design-system/Card';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import { Icon } from '@/components/design-system/Icon';
import { Skeleton } from '@/components/design-system/Skeleton';

type ForecastPayload = {
  bandNow: number;
  currentPct: number;
  targetBand: number;
  etaDays: number | null;
  confidence: 'low' | 'med' | 'high';
  rationale: string;
};

const ForecastSkeleton: React.FC = () => (
  <Card className="p-4 space-y-3">
    <div className="flex items-center justify-between">
      <Skeleton className="h-4 w-28" />
      <Skeleton className="h-5 w-16 rounded-full" />
    </div>
    <Skeleton className="h-6 w-40" />
    <Skeleton className="h-4 w-full" />
    <Skeleton className="h-4 w-2/3" />
    <div className="pt-2">
      <Skeleton className="h-8 w-40 rounded-full" />
    </div>
  </Card>
);

export const ReadingForecastPanel: React.FC<{ targetBand?: number }> = ({
  targetBand = 7.0,
}) => {
  const [data, setData] = useState<ForecastPayload | null>(null);
  const [loading, setLoading] = useState(true);
  const [hasError, setHasError] = useState(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      try {
        setLoading(true);
        setHasError(false);

        const r = await fetch(`/api/reading/forecast?target=${targetBand}`);
        if (!r.ok) {
          throw new Error(`forecast status ${r.status}`);
        }

        const j = (await r.json()) as Partial<ForecastPayload> | null;

        // Basic sanity check so we don’t blow up on weird payloads
        if (
          j &&
          typeof j.bandNow === 'number' &&
          typeof j.targetBand === 'number'
        ) {
          if (!cancelled) {
            setData({
              bandNow: j.bandNow,
              currentPct: j.currentPct ?? 0,
              targetBand: j.targetBand,
              etaDays: j.etaDays ?? null,
              confidence: (j.confidence as ForecastPayload['confidence']) ?? 'low',
              rationale: j.rationale ?? 'We need more attempts to generate a solid forecast.',
            });
          }
        } else {
          // no usable data (e.g. no attempts yet) – just leave data = null
          if (!cancelled) {
            setData(null);
          }
        }
      } catch (e) {
        // eslint-disable-next-line no-console
        console.error('Reading forecast fetch failed', e);
        if (!cancelled) {
          setHasError(true);
          setData(null);
        }
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [targetBand]);

  // If we’re still loading OR we don’t have a valid forecast → skeleton / neutral card
  if (loading) {
    return <ForecastSkeleton />;
  }

  if (!data) {
    return (
      <Card className="p-4 space-y-3">
        <div className="flex items-center justify-between">
          <span className="text-xs font-semibold text-muted-foreground uppercase">
            Reading forecast
          </span>
          <Badge variant="outline" className="rounded-ds-xl text-[10px]">
            <Icon name="Info" className="mr-1 h-3 w-3" />
            Warming up
          </Badge>
        </div>
        <p className="text-sm">
          We don&apos;t have enough completed reading attempts to forecast your band yet.
        </p>
        {hasError && (
          <p className="text-xs text-destructive">
            Couldn&apos;t reach forecast service right now. Try again after another attempt.
          </p>
        )}
        <div className="pt-2">
          <Button
            variant="surface"
            size="sm"
            className="rounded-ds-xl text-xs"
            asChild
          >
            <a href="/mock/reading/history">Finish a mock to unlock forecast</a>
          </Button>
        </div>
      </Card>
    );
  }

  // Safe to use .toFixed now – we already validated bandNow/targetBand as numbers
  const bandNow = data.bandNow;
  const target = data.targetBand;

  const confidenceLabel =
    data.confidence === 'high'
      ? 'High confidence'
      : data.confidence === 'med'
      ? 'Medium confidence'
      : 'Early estimate';

  return (
    <Card className="p-4 space-y-3">
      <div className="flex items-center justify-between">
        <span className="text-xs font-semibold text-muted-foreground uppercase">
          Reading forecast
        </span>
        <Badge
          variant={data.confidence === 'high' ? 'success' : 'outline'}
          className="rounded-ds-xl text-[10px]"
        >
          <Icon name="Sparkles" className="mr-1 h-3 w-3" />
          {confidenceLabel}
        </Badge>
      </div>
      <div className="flex items-baseline gap-2">
        <span className="text-2xl font-semibold">
          {bandNow.toFixed(1)}
        </span>
        <span className="text-xs text-muted-foreground">
          → target {target.toFixed(1)}
        </span>
      </div>
      <div className="text-xs text-muted-foreground">
        Current: <span className="font-semibold">Band {bandNow.toFixed(1)}</span>{' '}
        ({Math.round(data.currentPct)}% of target)
      </div>
      <div className="text-xs">
        {data.etaDays === null ? (
          <span className="text-muted-foreground">
            • improve slope to reach target
          </span>
        ) : (
          <span className="font-semibold">in ~{data.etaDays} days</span>
        )}
      </div>
      <div className="mt-1 text-xs text-muted-foreground">{data.rationale}</div>
      <div className="mt-3">
        <a href="/reading?type=tfng" className="inline-flex">
          <Button variant="surface" size="sm" className="rounded-ds-xl">
            Boost slope: weakest type drill
          </Button>
        </a>
      </div>
    </Card>
  );
};

===== File #64: components/reading/ReadingExamShell.tsx =====
import * as React from 'react';

import type {
  ReadingTest,
  ReadingPassage,
  ReadingQuestion,
} from '@/lib/reading/types';
import { ReadingPassagePane } from './ReadingPassagePane';
import { ReadingQuestionItem } from './ReadingQuestionItem';
import { Card } from '@/components/design-system/Card';
import { Button } from '@/components/design-system/Button';
import TimerProgress from '@/components/reading/TimerProgress';
import { QuestionNav } from '@/components/reading/QuestionNav';
import { supabase } from '@/lib/supabaseClient';
import { readingBandFromRaw } from '@/lib/reading/band';

type Props = {
  test: ReadingTest;
  passages: ReadingPassage[];
  questions: ReadingQuestion[];
};

type AnswerValue = string | string[] | Record<string, any> | null;

type LayoutMode = 'split' | 'scroll';
type StatusFilter = 'all' | 'flagged' | 'unanswered';
type TypeFilter = 'all' | 'tfng' | 'ynng' | 'mcq' | 'gap' | 'match';

const LAYOUT_PREF_KEY = 'mock:reading:layout-mode';
const FOCUS_MODE_PREF_KEY = 'mock:reading:focus-mode';

const isAnswered = (val: AnswerValue): boolean => {
  if (val == null) return false;
  if (typeof val === 'string') return val.trim().length > 0;
  if (Array.isArray(val)) return val.length > 0;
  if (typeof val === 'object') {
    return Object.values(val).some(
      (v) => v != null && String(v).trim().length > 0,
    );
  }
  return false;
};

const ReadingExamShellInner: React.FC<Props> = ({ test, passages, questions }) => {
  if (!questions.length || !passages.length) {
    return (
      <Card className="p-6 text-sm text-muted-foreground">
        This Reading test does not have passages or questions configured yet.
      </Card>
    );
  }

  // answers + flags
  const [answers, setAnswers] = React.useState<Record<string, AnswerValue>>({});
  const [flags, setFlags] = React.useState<Record<string, boolean>>({});
  const [submitting, setSubmitting] = React.useState(false);

  // layout + focus
  const [layoutMode, setLayoutMode] = React.useState<LayoutMode>('split');
  const [focusMode, setFocusMode] = React.useState(false);

  // passage + question nav
  const [currentPassageIdx, setCurrentPassageIdx] = React.useState(0);
  const [statusFilter, setStatusFilter] = React.useState<StatusFilter>('all');
  const [typeFilter, setTypeFilter] = React.useState<TypeFilter>('all');
  const [currentQuestionId, setCurrentQuestionId] = React.useState<string | null>(
    questions[0]?.id ?? null,
  );

  const startTimeRef = React.useRef<number>(Date.now());
  const questionRefs = React.useRef<Record<string, HTMLDivElement | null>>({});

  // hydrate layout + focus prefs
  React.useEffect(() => {
    if (typeof window === 'undefined') return;

    const layoutRaw = window.localStorage.getItem(LAYOUT_PREF_KEY) as LayoutMode | null;
    const focusRaw = window.localStorage.getItem(FOCUS_MODE_PREF_KEY);

    if (layoutRaw === 'split' || layoutRaw === 'scroll') {
      setLayoutMode(layoutRaw);
    }
    if (focusRaw === '1') {
      setFocusMode(true);
    }
  }, []);

  const handleToggleLayout = React.useCallback((mode: LayoutMode) => {
    setLayoutMode(mode);
    if (typeof window !== 'undefined') {
      window.localStorage.setItem(LAYOUT_PREF_KEY, mode);
    }
  }, []);

  const handleToggleFocus = React.useCallback(() => {
    setFocusMode((prev) => {
      const next = !prev;
      if (typeof window !== 'undefined') {
        window.localStorage.setItem(FOCUS_MODE_PREF_KEY, next ? '1' : '0');
      }
      return next;
    });
  }, []);

  // group helpers
  const questionsById = React.useMemo(() => {
    const map: Record<string, ReadingQuestion> = {};
    questions.forEach((q) => {
      map[q.id] = q;
    });
    return map;
  }, [questions]);

  const passageIndexById = React.useMemo(() => {
    const map: Record<string, number> = {};
    passages.forEach((p, idx) => {
      // @ts-expect-error reading type shape
      map[p.id as string] = idx;
    });
    return map;
  }, [passages]);

  const currentPassage = passages[currentPassageIdx] ?? passages[0];

  const totalQuestions = questions.length;

  const answeredCount = React.useMemo(
    () =>
      questions.reduce(
        (acc, q) => (isAnswered(answers[q.id]) ? acc + 1 : acc),
        0,
      ),
    [questions, answers],
  );

  const flaggedCount = React.useMemo(
    () => Object.values(flags).filter(Boolean).length,
    [flags],
  );

  const unansweredCount = totalQuestions - answeredCount;

  const handleAnswerChange = React.useCallback((questionId: string, value: AnswerValue) => {
    setAnswers((prev) => ({ ...prev, [questionId]: value }));
  }, []);

  const handleToggleFlagQuestion = React.useCallback((questionId: string) => {
    setFlags((prev) => ({
      ...prev,
      [questionId]: !prev[questionId],
    }));
  }, []);

  const handleNextPassage = React.useCallback(() => {
    setCurrentPassageIdx((idx) =>
      idx + 1 < passages.length ? idx + 1 : idx,
    );
  }, [passages.length]);

  const handlePrevPassage = React.useCallback(() => {
    setCurrentPassageIdx((idx) => (idx - 1 >= 0 ? idx - 1 : idx));
  }, []);

  const handleJumpQuestion = React.useCallback(
    (questionId: string) => {
      setCurrentQuestionId(questionId);

      const q = questionsById[questionId];
      // @ts-expect-error reading type shape
      if (q && q.passageId) {
        // @ts-expect-error reading type shape
        const idx = passageIndexById[q.passageId as string];
        if (typeof idx === 'number') {
          setCurrentPassageIdx(idx);
        }
      }

      if (typeof window !== 'undefined') {
        const el = questionRefs.current[questionId];
        if (el) {
          el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
    },
    [questionsById, passageIndexById],
  );

  // visible questions for current passage + filters
  const visibleQuestions = React.useMemo(() => {
    return questions.filter((q) => {
      // passage filter: only current passage
      // @ts-expect-error reading type shape
      if (currentPassage && q.passageId && q.passageId !== currentPassage.id) {
        return false;
      }

      // type filter
      // @ts-expect-error reading type shape
      const type = (q.questionTypeId ?? 'all') as TypeFilter;
      if (typeFilter !== 'all' && type !== typeFilter) return false;

      // status filter
      const val = answers[q.id];
      const answered = isAnswered(val);
      const flagged = !!flags[q.id];

      if (statusFilter === 'flagged' && !flagged) return false;
      if (statusFilter === 'unanswered' && answered) return false;

      return true;
    });
  }, [questions, currentPassage, answers, flags, statusFilter, typeFilter]);

  // data for QuestionNav
  const navQuestions = React.useMemo(
    () =>
      questions.map((q) => ({
        id: q.id,
        // @ts-expect-error reading type shape
        qNo: q.questionOrder ?? 0,
        // @ts-expect-error reading type shape
        type: (q.questionTypeId ?? 'all') as string,
      })),
    [questions],
  );

  const navAnswers = React.useMemo(() => {
    const out: Record<string, { type: string; value: any }> = {};
    navQuestions.forEach((q) => {
      out[q.id] = {
        type: q.type,
        value: answers[q.id] ?? null,
      };
    });
    return out;
  }, [navQuestions, answers]);

  const durationSeconds = (test as any).durationSeconds ?? 3600;
  const durationMinutes = Math.round(durationSeconds / 60);

  const handleSubmit = React.useCallback(async () => {
    if (submitting) return;
    setSubmitting(true);

    try {
      const durationSec = Math.floor(
        (Date.now() - startTimeRef.current) / 1000,
      );

      // basic guard
      if (answeredCount === 0) {
        alert('Answer at least one question before submitting.');
        setSubmitting(false);
        return;
      }

      if (unansweredCount > 0 && typeof window !== 'undefined') {
        const ok = window.confirm(
          `You still have ${unansweredCount} unanswered question${
            unansweredCount > 1 ? 's' : ''
          }. Submit anyway?`,
        );
        if (!ok) {
          setSubmitting(false);
          return;
        }
      }

      // 1) user must be logged in
      const {
        data: { user },
        error: userError,
      } = await supabase.auth.getUser();

      if (userError) {
        // eslint-disable-next-line no-console
        console.error('Failed to fetch user', userError);
      }
      if (!user) {
        alert('You must be logged in to submit this mock.');
        setSubmitting(false);
        return;
      }

      // 2) compute score + meta
      let correctCount = 0;
      const answersById: Record<string, any> = {};
      const passageStats: Record<
        string,
        { passageId: string | null; correct: number; total: number }
      > = {};

      for (const q of questions) {
        const given = answers[q.id] ?? null;
        // @ts-expect-error reading type shape
        const correct = q.correctAnswer;
        answersById[q.id] = given;

        let isCorrect = false;

        if (correct == null) {
          isCorrect = false;
        } else if (typeof correct === 'string') {
          isCorrect = given != null && given === correct;
        } else if (Array.isArray(correct)) {
          if (Array.isArray(given)) {
            const givenSet = new Set(given as any[]);
            isCorrect = (correct as any[]).every((v) => givenSet.has(v));
          }
        } else if (
          typeof correct === 'object' &&
          given &&
          typeof given === 'object'
        ) {
          const cObj = correct as Record<string, any>;
          const gObj = given as Record<string, any>;
          const keys = Object.keys(cObj);
          isCorrect = keys.every((k) => gObj[k] === cObj[k]);
        }

        if (isCorrect) correctCount += 1;

        // passage stats
        // @ts-expect-error reading type shape
        const pKey = (q.passageId ?? 'none') as string;
        if (!passageStats[pKey]) {
          passageStats[pKey] = {
            // @ts-expect-error reading type shape
            passageId: (q.passageId ?? null) as string | null,
            correct: 0,
            total: 0,
          };
        }
        passageStats[pKey].total += 1;
        if (isCorrect) passageStats[pKey].correct += 1;
      }

      const bandScore = readingBandFromRaw(correctCount, totalQuestions);

      const sectionStats = {
        totalQuestions,
        correctCount,
        passages: passageStats,
      };

      const meta = {
        answers: answersById,
        flags,
      };

      // 3) insert attempt
      const { data: attemptRow, error: attemptError } = await supabase
        .from('reading_attempts')
        .insert({
          user_id: user.id,
          // @ts-expect-error reading type shape
          test_id: test.id,
          status: 'completed',
          duration_seconds: durationSec,
          raw_score: correctCount,
          band_score: bandScore,
          section_stats: sectionStats,
          meta,
        })
        .select()
        .maybeSingle();

      if (attemptError || !attemptRow) {
        // eslint-disable-next-line no-console
        console.error('Failed to insert reading_attempt', attemptError);
        alert('Failed to submit your attempt. Please try again.');
        setSubmitting(false);
        return;
      }

      const attemptId: string = (attemptRow as any).id;

      if (typeof window !== 'undefined') {
        window.location.href = `/mock/reading/result/${attemptId}`;
      }
    } catch (err) {
      // eslint-disable-next-line no-console
      console.error('Unexpected error during reading submit', err);
      alert('Unexpected error while submitting.');
    } finally {
      setSubmitting(false);
    }
  }, [
    answeredCount,
    unansweredCount,
    answers,
    flags,
    questions,
    test,
    submitting,
    totalQuestions,
  ]);

  return (
    <div className="space-y-6">
      {/* Header */}
      <Card className="p-4 space-y-3">
        <div className="flex items-start justify-between gap-4">
          <div>
            <h1 className="text-lg font-semibold">{test.title}</h1>
            {/* @ts-expect-error reading type shape */}
            {test.description && !focusMode && (
              <p className="mt-1 text-sm text-muted-foreground">
                {/* @ts-expect-error reading type shape */}
                {test.description}
              </p>
            )}
            <p className="mt-2 text-xs text-muted-foreground">
              {totalQuestions} questions · {durationMinutes} minutes ·{' '}
              {/* @ts-expect-error reading type shape */}
              {(test.examType ?? 'IELTS').toString().toUpperCase()}
            </p>
            <p className="mt-1 text-xs text-muted-foreground">
              Answered: {answeredCount} · Unanswered: {unansweredCount} · Flagged:{' '}
              {flaggedCount}
            </p>
          </div>

          <div className="flex flex-col items-end gap-2 min-w-[200px]">
            <TimerProgress total={totalQuestions} />
            <div className="flex items-center gap-2">
              <Button
                size="xs"
                variant={layoutMode === 'split' ? 'primary' : 'outline'}
                onClick={() => handleToggleLayout('split')}
              >
                Split
              </Button>
              <Button
                size="xs"
                variant={layoutMode === 'scroll' ? 'primary' : 'outline'}
                onClick={() => handleToggleLayout('scroll')}
              >
                Scroll
              </Button>
              <Button
                size="xs"
                variant={focusMode ? 'primary' : 'outline'}
                onClick={handleToggleFocus}
              >
                {focusMode ? 'Focus on' : 'Focus off'}
              </Button>
            </div>
          </div>
        </div>
      </Card>

      {/* Main layout */}
      {layoutMode === 'split' ? (
        // SPLIT: each side has its own scroll
        <div className="grid gap-4 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)] lg:h-[calc(100vh-260px)]">
          {/* Passage side */}
          <div className="flex flex-col h-full">
            <ReadingPassagePane
              passage={currentPassage}
              totalPassages={passages.length}
            />

            {passages.length > 1 && (
              <div className="mt-3 flex justify-between gap-2 text-xs">
                <Button
                  size="xs"
                  variant="outline"
                  onClick={handlePrevPassage}
                  disabled={currentPassageIdx === 0}
                >
                  Previous passage
                </Button>
                <span className="flex-1 text-center text-muted-foreground">
                  Passage {currentPassageIdx + 1} of {passages.length}
                </span>
                <Button
                  size="xs"
                  variant="outline"
                  onClick={handleNextPassage}
                  disabled={currentPassageIdx === passages.length - 1}
                >
                  Next passage
                </Button>
              </div>
            )}
          </div>

          {/* Questions side */}
          <div className="flex flex-col h-full overflow-hidden">
            <QuestionNav
              questions={navQuestions}
              answers={navAnswers}
              flags={flags}
              statusFilter={statusFilter}
              onStatusFilter={setStatusFilter}
              typeFilter={typeFilter}
              onTypeFilter={setTypeFilter}
              onJump={handleJumpQuestion}
              className="mb-2 flex-shrink-0"
            />

            <div className="flex-1 overflow-y-auto space-y-2">
              {visibleQuestions.length === 0 ? (
                <Card className="p-4 text-sm text-muted-foreground">
                  No questions match the current filters for this passage. Try
                  switching back to “All questions”.
                </Card>
              ) : (
                visibleQuestions.map((q) => {
                  const val = answers[q.id] ?? null;
                  const isFlagged = !!flags[q.id];
                  const isCurrent = currentQuestionId === q.id;

                  return (
                    <div
                      key={q.id}
                      ref={(el) => {
                        questionRefs.current[q.id] = el;
                      }}
                      className={
                        isCurrent ? 'ring-1 ring-primary rounded-ds' : undefined
                      }
                    >
                      <div className="space-y-1 p-1">
                        <ReadingQuestionItem
                          question={q}
                          value={
                            typeof val === 'string' || Array.isArray(val)
                              ? (val as any)
                              : null
                          }
                          onChange={(v) => handleAnswerChange(q.id, v)}
                        />
                        <div className="flex justify-between items-center text-[11px] px-1 pb-1">
                          {/* @ts-expect-error reading type shape */}
                          <span className="text-muted-foreground">
                            Question {q.questionOrder}
                          </span>
                          <Button
                            size="xs"
                            variant={isFlagged ? 'primary' : 'outline'}
                            onClick={() => handleToggleFlagQuestion(q.id)}
                          >
                            {isFlagged ? 'Unflag' : 'Flag'}
                          </Button>
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </div>
        </div>
      ) : (
        // SCROLL layout (mobile / simple)
        <div className="space-y-4">
          <div>
            <ReadingPassagePane
              passage={currentPassage}
              totalPassages={passages.length}
            />

            {passages.length > 1 && (
              <div className="mt-3 flex justify-between gap-2 text-xs">
                <Button
                  size="xs"
                  variant="outline"
                  onClick={handlePrevPassage}
                  disabled={currentPassageIdx === 0}
                >
                  Previous passage
                </Button>
                <span className="flex-1 text-center text-muted-foreground">
                  Passage {currentPassageIdx + 1} of {passages.length}
                </span>
                <Button
                  size="xs"
                  variant="outline"
                  onClick={handleNextPassage}
                  disabled={currentPassageIdx === passages.length - 1}
                >
                  Next passage
                </Button>
              </div>
            )}
          </div>

          <div className="space-y-3">
            <QuestionNav
              questions={navQuestions}
              answers={navAnswers}
              flags={flags}
              statusFilter={statusFilter}
              onStatusFilter={setStatusFilter}
              typeFilter={typeFilter}
              onTypeFilter={setTypeFilter}
              onJump={handleJumpQuestion}
              className="mb-2"
            />

            {visibleQuestions.length === 0 ? (
              <Card className="p-4 text-sm text-muted-foreground">
                No questions match the current filters for this passage.
              </Card>
            ) : (
              <div className="space-y-2">
                {visibleQuestions.map((q) => {
                  const val = answers[q.id] ?? null;
                  const isFlagged = !!flags[q.id];
                  const isCurrent = currentQuestionId === q.id;

                  return (
                    <div
                      key={q.id}
                      ref={(el) => {
                        questionRefs.current[q.id] = el;
                      }}
                      className={
                        isCurrent ? 'ring-1 ring-primary rounded-ds' : undefined
                      }
                    >
                      <div className="space-y-1 p-1">
                        <ReadingQuestionItem
                          question={q}
                          value={
                            typeof val === 'string' || Array.isArray(val)
                              ? (val as any)
                              : null
                          }
                          onChange={(v) => handleAnswerChange(q.id, v)}
                        />
                        <div className="flex justify-between items-center text-[11px] px-1 pb-1">
                          {/* @ts-expect-error reading type shape */}
                          <span className="text-muted-foreground">
                            Question {q.questionOrder}
                          </span>
                          <Button
                            size="xs"
                            variant={isFlagged ? 'primary' : 'outline'}
                            onClick={() => handleToggleFlagQuestion(q.id)}
                          >
                            {isFlagged ? 'Unflag' : 'Flag'}
                          </Button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      )}

      {/* Submit */}
      <Card className="p-4 text-center">
        <Button onClick={handleSubmit} disabled={submitting}>
          {submitting ? 'Submitting…' : 'Submit'}
        </Button>
      </Card>
    </div>
  );
};

export const ReadingExamShell = ReadingExamShellInner;
export default ReadingExamShellInner;

===== File #65: components/reading/TimerProgress.tsx =====
import * as React from 'react';
import { ProgressBar } from '@/components/design-system/ProgressBar';

type TimerProgressProps = {
  /** Total questions (for display only) */
  total?: number;
  /** How many answered (optional – shell can wire later) */
  answered?: number;
  /** Total duration (seconds). Default 60 min. */
  durationSeconds?: number;
  /** Initial elapsed seconds if resuming from checkpoint */
  initialElapsedSec?: number;
};

const TimerProgress: React.FC<TimerProgressProps> = ({
  total = 40,
  answered,
  durationSeconds = 3600,
  initialElapsedSec = 0,
}) => {
  const [sec, setSec] = React.useState(initialElapsedSec);

  React.useEffect(() => {
    const id = window.setInterval(() => {
      setSec((s) => s + 1);
    }, 1000);
    return () => window.clearInterval(id);
  }, []);

  const clampedDuration = durationSeconds > 0 ? durationSeconds : 3600;
  const mins = Math.floor(sec / 60);
  const rem = sec % 60;
  const pct = Math.min(100, Math.round((sec / clampedDuration) * 100));

  return (
    <div className="sticky top-0 z-10 mb-2">
      <ProgressBar value={pct} />
      <div className="mt-1 text-[11px] text-muted-foreground flex items-center justify-between">
        <span>
          Time: {mins}:{String(rem).padStart(2, '0')}
        </span>
        {answered != null && (
          <span>
            Answered: {answered}/{total}
          </span>
        )}
      </div>
    </div>
  );
};

export default TimerProgress;

===== File #66: components/reading/QuestionNav.tsx =====
'use client';

import * as React from 'react';
import { Badge } from '@/components/design-system/Badge';
import { Button } from '@/components/design-system/Button';
import { cn } from '@/lib/utils';

export type QuestionNavTypeFilter = 'all' | 'tfng' | 'ynng' | 'mcq' | 'gap' | 'match';
export type QuestionNavFilter = 'all' | 'flagged' | 'unanswered';

export type QuestionNavQuestion = {
  id: string;
  qNo: number;
  type: QuestionNavTypeFilter | string;
};

type QuestionNavProps = {
  questions: QuestionNavQuestion[];
  answers: Record<string, { type: string; value: any }>;
  flags: Record<string, boolean>;
  statusFilter: QuestionNavFilter;
  onStatusFilter: (f: QuestionNavFilter) => void;
  typeFilter: QuestionNavTypeFilter;
  onTypeFilter: (f: QuestionNavTypeFilter) => void;
  onJump: (id: string) => void;
  className?: string;
};

const isUnanswered = (val: any): boolean => {
  if (val == null) return true;
  if (typeof val === 'string') return val.trim().length === 0;
  if (Array.isArray(val)) return val.length === 0;
  if (typeof val === 'object') {
    return !Object.values(val).some(
      (v) => v != null && String(v).trim().length > 0,
    );
  }
  return false;
};

export const QuestionNav: React.FC<QuestionNavProps> = ({
  questions,
  answers,
  flags,
  statusFilter,
  onStatusFilter,
  typeFilter,
  onTypeFilter,
  onJump,
  className,
}) => {
  const total = questions.length;

  const answeredCount = React.useMemo(
    () =>
      questions.reduce((acc, q) => {
        const val = answers[q.id]?.value;
        return isUnanswered(val) ? acc : acc + 1;
      }, 0),
    [questions, answers],
  );

  const flaggedCount = React.useMemo(
    () => Object.values(flags).filter(Boolean).length,
    [flags],
  );

  const unansweredCount = total - answeredCount;

  const visible = React.useMemo(
    () =>
      questions
        .filter((q) => {
          const a = answers[q.id]?.value;
          const flagged = !!flags[q.id];
          const unanswered = isUnanswered(a);
          const type = (q.type ?? 'all') as QuestionNavTypeFilter;

          if (typeFilter !== 'all' && type !== typeFilter) return false;
          if (statusFilter === 'flagged' && !flagged) return false;
          if (statusFilter === 'unanswered' && !unanswered) return false;

          return true;
        })
        .sort((a, b) => a.qNo - b.qNo),
    [questions, answers, flags, statusFilter, typeFilter],
  );

  const statusFilters: QuestionNavFilter[] = ['all', 'flagged', 'unanswered'];
  const typeFilters: QuestionNavTypeFilter[] = ['all', 'tfng', 'ynng', 'mcq', 'gap', 'match'];

  return (
    <aside
      className={cn(
        'card-surface p-4 rounded-ds border border-lightBorder dark:border-white/10',
        className,
      )}
    >
      <div className="flex items-center justify-between gap-2">
        <h3 className="text-h3 font-semibold">Questions</h3>
        <Badge variant="soft" className="rounded-full text-[10px] uppercase tracking-wide">
          {answeredCount}/{total} answered
        </Badge>
      </div>

      <div className="mt-2 text-[11px] text-muted-foreground space-y-1">
        <p>Total: {total}</p>
        <p>
          Flagged: {flaggedCount} • Unanswered: {unansweredCount}
        </p>
      </div>

      {/* Status filters */}
      <div className="mt-3 flex flex-wrap gap-1">
        {statusFilters.map((s) => (
          <Button
            key={s}
            size="xs"
            variant={statusFilter === s ? 'primary' : 'ghost'}
            onClick={() => onStatusFilter(s)}
          >
            {s === 'all' ? 'All' : s === 'flagged' ? 'Flagged' : 'Unanswered'}
          </Button>
        ))}
      </div>

      {/* Type filters */}
      <div className="mt-2 flex flex-wrap gap-1">
        {typeFilters.map((t) => (
          <Button
            key={t}
            size="xs"
            variant={typeFilter === t ? 'outline' : 'ghost'}
            onClick={() => onTypeFilter(t)}
          >
            {t === 'all' ? 'All types' : t.toUpperCase()}
          </Button>
        ))}
      </div>

      {/* Question chips */}
      <div className="mt-3 grid grid-cols-6 sm:grid-cols-8 lg:grid-cols-4 gap-2">
        {visible.map((q) => {
          const flagged = !!flags[q.id];
          const val = answers[q.id]?.value;
          const unanswered = isUnanswered(val);

          const baseChip =
            'inline-flex items-center justify-center rounded-full border px-2 py-1 text-[11px] font-medium cursor-pointer transition-colors';
          let tone =
            'bg-surfaceSubtle text-muted-foreground border-lightBorder';

          if (!unanswered) {
            tone = 'bg-success/15 text-success border-success/40';
          } else if (flagged) {
            tone = 'bg-goldenYellow/15 text-goldenYellow border-goldenYellow/40';
          }

          return (
            <button
              key={q.id}
              type="button"
              className={cn(baseChip, tone)}
              onClick={() => onJump(q.id)}
            >
              {q.qNo}
            </button>
          );
        })}
      </div>
    </aside>
  );
};

export default QuestionNav;

===== File #67: components/reading/ReadingQuestionNavigator.tsx =====

===== File #68: components/reading/ReadingHighlightLayer.tsx =====

===== File #69: components/reading/analytics/BandPredictorCard.tsx =====
import * as React from 'react';

import { Card } from '@/components/design-system/Card';
import type { ReadingAttemptSummary } from '@/lib/reading/bandPredictor';
import { predictBand } from '@/lib/reading/bandPredictor';

// Props for the BandPredictorCard. It accepts an array of attempt
// summaries and computes a predicted band using a simple heuristic.
type BandPredictorProps = {
  attempts: ReadingAttemptSummary[];
};

/**
 * Displays a predicted IELTS Reading band based on recent attempts. If
 * no attempts exist yet it encourages the user to complete at least
 * one mock.
 */
export const BandPredictorCard: React.FC<BandPredictorProps> = ({ attempts }) => {
  const { band, confidence } = predictBand(attempts);
  return (
    <Card className="p-4 space-y-1 text-xs">
      <p className="font-medium">Predicted band</p>
      {attempts.length === 0 ? (
        <p className="text-muted-foreground">
          Do at least one mock to see your predicted band.
        </p>
      ) : (
        <>
          <p>
            Your predicted IELTS Reading band is{' '}
            <span className="font-semibold">{band.toFixed(1)}</span>
          </p>
          <p className="text-muted-foreground">
            Confidence: {(confidence * 100).toFixed(0)}%
          </p>
        </>
      )}
    </Card>
  );
};

export default BandPredictorCard;

===== File #70: components/reading/analytics/ReadingAnalyticsPanel.tsx =====

