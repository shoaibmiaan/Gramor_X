
===============================
FILE 1 : pages\login\email.tsx
===============================
'use client';

import React, { useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/router';
import type { Session } from '@supabase/supabase-js';
import { SectionLabel } from '@/components/design-system/SectionLabel';
import { Input } from '@/components/design-system/Input';
import { PasswordInput } from '@/components/design-system/PasswordInput';
import { Button } from '@/components/design-system/Button';
import { Alert } from '@/components/design-system/Alert';
import { supabaseBrowser } from '@/lib/supabaseBrowser';
import { destinationByRole } from '@/lib/routeAccess';
import { isValidEmail } from '@/utils/validation';
import { getAuthErrorMessage } from '@/lib/authErrors';
import useEmailLoginMFA from '@/hooks/useEmailLoginMFA';

export default function LoginWithEmail() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [pw, setPw] = useState('');
  const [emailErr, setEmailErr] = useState<string | null>(null);
  const [err, setErr] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const {
    otp,
    setOtp,
    otpSent,
    createChallenge,
    verifyOtp,
    verifying,
    error: mfaErr,
    setError: setMfaErr,
  } = useEmailLoginMFA();

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setErr(null);
    setMfaErr(null);

    const trimmedEmail = email.trim();

    // If no email or password is provided, show an error
    if (!trimmedEmail && !pw) {
      setErr('Email and password are required.');
      return;
    }

    // If only email is provided, show error
    if (!trimmedEmail) {
      setErr('Email is required.');
      return;
    }

    if (!pw) {
      setErr('Password is required.');
      return;
    }

    if (!isValidEmail(trimmedEmail)) {
      setEmailErr('Enter a valid email address.');
      return;
    }

    setEmailErr(null);

    setLoading(true);
    async function syncServerSession(session: Session | null) {
      try {
        const syncRes = await fetch('/api/auth/set-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ event: 'SIGNED_IN', session }),
        });

        if (!syncRes.ok) {
          console.error('Sync server session failed:', syncRes.status);
          return false;
        }

        const syncBody = await syncRes.json().catch(() => ({}));
        if (syncBody && typeof syncBody === 'object' && syncBody.ok === false) {
          console.error('Sync server session failed: response not ok');
          return false;
        }

        return true;
      } catch (error) {
        console.error('Sync server session failed:', error);
        return false;
      }
    }

    async function recordLoginEvent(session: Session | null, allowResync = true) {
      try {
        const loginEventRes = await fetch('/api/auth/login-event', {
          method: 'POST',
          credentials: 'same-origin',
        });

        if (loginEventRes.status === 401 && allowResync) {
          const resynced = await syncServerSession(session);
          if (resynced) return recordLoginEvent(session, false);
        }

        if (!loginEventRes.ok) {
          console.error('Login event failed:', loginEventRes.status);
        }
      } catch (error) {
        console.error('Error logging login event:', error);
      }
    }

    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: trimmedEmail, password: pw }),
      });
      const body = await res.json().catch(() => ({}));
      setLoading(false);

      if (!res.ok || !body.session) {
        const msg =
          typeof body.error === 'string'
            ? body.error
            : getAuthErrorMessage(body.error) ?? 'Unable to sign in. Please try again.';
        setErr(msg);
        return;
      }

      // If login is successful, set session and proceed
      await supabaseBrowser.auth
        .setSession({
          access_token: body.session.access_token,
          refresh_token: body.session.refresh_token,
        })
        .catch(err => console.error('Set session failed:', err));

      const serverSynced = await syncServerSession(body.session);

      const {
        data: { user },
        error: userError,
      } = await supabaseBrowser.auth.getUser();
      if (userError) console.error('Get user failed:', userError);

      // Skip OTP if both email and password are provided
      if (!body.mfaRequired) {
        if (!serverSynced) {
          await syncServerSession(body.session);
        }

        await recordLoginEvent(body.session);

        const rawNext = typeof router.query.next === 'string' ? router.query.next : '';
        const safeNext = rawNext && rawNext.startsWith('/') && rawNext !== '/login' ? rawNext : null;

        const fallback = user ? destinationByRole(user) : '/dashboard';
        const target = safeNext ?? fallback;

        try {
          await router.replace(target);
        } catch (err) {
          console.error('Redirect after login failed:', err);
          if (typeof window !== 'undefined') window.location.assign(target);
        }
        return;
      }

      // If MFA (OTP) is required, trigger the challenge
      const challenged = await createChallenge(user).catch(err => console.error('Create challenge failed:', err));
      if (challenged) return;

      // Rely on _app.tsx onAuthStateChange to redirect
    } catch (err) {
      console.error('Login error:', err);
      setErr('Unable to sign in. Please try again.');
      setLoading(false);
    }
  }

  return (
    <>
      <SectionLabel>Sign in with Email</SectionLabel>

      {(err || mfaErr) && (
        <Alert variant="warning" title="Error" className="mb-4" role="status" aria-live="assertive">
          {err || mfaErr}
        </Alert>
      )}

      {!otpSent ? (
        <form onSubmit={onSubmit} className="space-y-6 mt-2">
          <Input
            label="Email"
            type="email"
            placeholder="you@example.com"
            value={email}
            onChange={(e) => {
              const v = e.target.value;
              setEmail(v);
              setEmailErr(!v || isValidEmail(v.trim()) ? null : 'Enter a valid email address.');
            }}
            autoComplete="email"
            required
            error={emailErr ?? undefined}
          />
          <PasswordInput
            label="Password"
            placeholder="Your password"
            value={pw}
            onChange={(e) => setPw(e.target.value)}
            autoComplete="current-password"
            required
          />
          <Button type="submit" variant="primary" className="rounded-ds-xl" fullWidth disabled={loading}>
            {loading ? 'Signing in‚Ä¶' : 'Sign in'}
          </Button>
          <Button asChild variant="link" className="mt-2" fullWidth>
            <Link href="/forgot-password">Forgot password?</Link>
          </Button>
          <p className="mt-2 text-caption text-mutedText text-center">
            By continuing you agree to our <Link href="/legal/terms" className="underline">Terms</Link> &amp; <Link href="/legal/privacy" className="underline">Privacy</Link>.
          </p>
        </form>
      ) : (
        <form onSubmit={verifyOtp} className="space-y-6 mt-2 max-w-xs">
          <Input
            label="Enter OTP"
            value={otp}
            onChange={(e) => setOtp(e.target.value)}
            autoComplete="one-time-code"
            placeholder="6-digit code"
            required
          />
          <Button type="submit" variant="primary" className="rounded-ds-xl" fullWidth disabled={verifying}>
            {verifying ? 'Verifying‚Ä¶' : 'Verify & Sign in'}
          </Button>
        </form>
      )}

      <Button asChild variant="secondary" className="mt-6 rounded-ds-xl" fullWidth>
        <Link href="/login">Back to Login Options</Link>
      </Button>
    </>
  );
}



===============================
FILE 2 : components\Header.tsx
===============================
// components/Header.tsx
'use client';

import React, { useCallback, useEffect, useRef, useState } from 'react';
import Image from 'next/image';
import Link from 'next/link';
import { useRouter } from 'next/router';

import { Container } from '@/components/design-system/Container';
import { Badge } from '@/components/design-system/Badge';
import { Icon } from '@/components/design-system/Icon';
import DesktopNav from '@/components/navigation/DesktopNav';
import MobileNav from '@/components/navigation/MobileNav';
import { useHeaderState } from '@/components/hooks/useHeaderState';
import { useUserContext } from '@/context/UserContext';
import { PremiumRoomManager } from '@/premium-ui/access/roomUtils';
import { cn } from '@/lib/utils';
import type { SearchResult } from '@/lib/search/types';

export const Header: React.FC<{ streak?: number }> = ({ streak }) => {
  const [openDesktopModules, setOpenDesktopModules] = useState(false);
  const [mobileOpen, setMobileOpen] = useState(false);
  const [mobileModulesOpen, setMobileModulesOpen] = useState(false);
  const [scrolled, setScrolled] = useState(false);
  const [showSearch, setShowSearch] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState<SearchResult[]>([]);
  const [searchLoading, setSearchLoading] = useState(false);
  const [searchError, setSearchError] = useState<string | null>(null);

  const { user, role, loading } = useUserContext();
  const { streak: streakState, ready, signOut, subscriptionTier } = useHeaderState(streak);

  const [hasPremiumAccess, setHasPremiumAccess] = useState(false);
  const [premiumRooms, setPremiumRooms] = useState<string[]>([]);

  const headerRef = useRef<HTMLElement>(null);
  const modulesRef = useRef<HTMLLIElement>(null);
  const searchInputRef = useRef<HTMLInputElement>(null);
  const searchContainerRef = useRef<HTMLDivElement>(null);

  const router = useRouter();

  const closeSearch = useCallback(() => {
    setShowSearch(false);
    setSearchQuery('');
    setSearchResults([]);
    setSearchLoading(false);
    setSearchError(null);
  }, []);

  // Scroll ‚Üí toggle solid header
  useEffect(() => {
    const onScroll = () => setScrolled(window.scrollY > 10);
    window.addEventListener('scroll', onScroll, { passive: true });
    return () => window.removeEventListener('scroll', onScroll);
  }, []);

  // Load premium access from local storage
  useEffect(() => {
    const sync = () => {
      const list = PremiumRoomManager.getAccessList();
      setHasPremiumAccess(list.length > 0);
      setPremiumRooms(list.map((r) => r.roomName));
    };
    sync();
    const onStorage = (e: StorageEvent) => e.key === 'premiumRooms' && sync();
    window.addEventListener('storage', onStorage);
    return () => window.removeEventListener('storage', onStorage);
  }, []);

  // Global ESC + click-away
  useEffect(() => {
    const onClick = (e: MouseEvent) => {
      const t = e.target as Node;
      if (modulesRef.current && !modulesRef.current.contains(t)) setOpenDesktopModules(false);
      if (showSearch && searchContainerRef.current && !searchContainerRef.current.contains(t)) {
        closeSearch();
      }
    };
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        setOpenDesktopModules(false);
        setMobileOpen(false);
        setMobileModulesOpen(false);
        closeSearch();
      }
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        setShowSearch(true);
      }
    };
    document.addEventListener('mousedown', onClick);
    document.addEventListener('keydown', onKey);
    return () => {
      document.removeEventListener('mousedown', onClick);
      document.removeEventListener('keydown', onKey);
    };
  }, [closeSearch, showSearch]);

  // Autofocus search
  useEffect(() => {
    if (showSearch) setTimeout(() => searchInputRef.current?.focus(), 100);
  }, [showSearch]);

  // Fetch search suggestions/results when query changes
  useEffect(() => {
    if (!showSearch) return;

    const controller = new AbortController();
    const timeout = setTimeout(async () => {
      try {
        setSearchLoading(true);
        setSearchError(null);
        const query = searchQuery.trim();
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`, {
          signal: controller.signal,
        });
        if (!response.ok) {
          throw new Error('Search failed');
        }
        const data = (await response.json()) as { results?: SearchResult[] };
        setSearchResults(Array.isArray(data.results) ? data.results : []);
      } catch (err) {
        if ((err as Error).name === 'AbortError') return;
        console.error('[Header] search request failed', err);
        setSearchResults([]);
        setSearchError('Unable to search right now. Please try again.');
      } finally {
        setSearchLoading(false);
      }
    }, 220);

    return () => {
      controller.abort();
      clearTimeout(timeout);
    };
  }, [searchQuery, showSearch]);

  const clearPremium = () => {
    PremiumRoomManager.clearAllAccess();
    setHasPremiumAccess(false);
    setPremiumRooms([]);
  };

  const handleSearch = (e: React.FormEvent) => {
    e.preventDefault();
    const trimmed = searchQuery.trim();
    if (!trimmed) {
      if (searchResults[0]) {
        router.push(searchResults[0].href).catch((err) => {
          console.error('[Header] failed to navigate to search result', err);
        });
        closeSearch();
      }
      return;
    }

    const topResult = searchResults[0];
    if (topResult) {
      router.push(topResult.href).catch((err) => {
        console.error('[Header] failed to navigate to search result', err);
      });
      closeSearch();
    }
  };

  const handleResultSelect = useCallback(
    (href: string) => {
      router.push(href).catch((err) => {
        console.error('[Header] failed to navigate to search result', err);
      });
      closeSearch();
    },
    [closeSearch, router],
  );

  const typeLabels: Record<SearchResult['type'], string> = {
    module: 'Module',
    course: 'Course',
    lesson: 'Lesson',
    vocabulary: 'Vocabulary',
    resource: 'Resource',
  };

  const solidHeader = scrolled || openDesktopModules || mobileOpen;

  // Loading skeleton
  if (loading && !user) {
    return (
      <header className="sticky top-0 z-50 w-full border-b border-border bg-surface/90 backdrop-blur-lg">
        <Container>
          <div className="flex h-16 items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="h-8 w-8 animate-pulse rounded-xl bg-border" />
              <div className="space-y-1">
                <div className="h-3 w-28 animate-pulse rounded bg-border" />
                <div className="h-2.5 w-20 animate-pulse rounded bg-border" />
              </div>
            </div>
            <div className="h-8 w-20 animate-pulse rounded-full bg-border" />
          </div>
        </Container>
      </header>
    );
  }

  return (
    <>
      {/* üîé SEARCH OVERLAY */}
      {showSearch && (
        <div className="fixed inset-0 z-[70] bg-surface/95 backdrop-blur-lg">
          <Container>
            <div ref={searchContainerRef} className="flex flex-col items-center gap-6 pt-4 pb-8">
              <div className="flex w-full max-w-3xl items-center gap-3">
                <form onSubmit={handleSearch} className="flex-1">
                  <div className="relative">
                    <Icon
                      name="Search"
                      size={18}
                      className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground"
                    />
                    <input
                      ref={searchInputRef}
                      type="text"
                      placeholder="Search vocabulary, grammar, or mock tests..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="w-full rounded-2xl border border-border/70 bg-background/80 px-4 py-3 pl-10 text-base shadow-sm outline-none transition focus:border-electricBlue focus:bg-background"
                    />
                  </div>
                </form>

                <button
                  type="button"
                  onClick={closeSearch}
                  className="rounded-lg p-2 text-muted-foreground transition hover:bg-muted focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-border focus-visible:ring-offset-2 focus-visible:ring-offset-background"
                  aria-label="Close search"
                >
                  <Icon name="X" size={18} />
                </button>
              </div>

              <div className="w-full max-w-3xl overflow-hidden rounded-2xl border border-border/60 bg-background/80 shadow-xl">
                <div className="flex items-center justify-between border-b border-border/60 px-4 py-3">
                  <span className="text-sm font-medium text-muted-foreground">
                    {searchQuery.trim() ? `Results for ‚Äú${searchQuery.trim()}‚Äù` : 'Recommended destinations'}
                  </span>
                  <span className="text-xs uppercase tracking-[0.16em] text-muted-foreground/80">Press Esc to close</span>
                </div>
                <div className="max-h-[60vh] overflow-y-auto">
                  {searchLoading ? (
                    <div className="flex flex-col gap-3 px-6 py-6">
                      {Array.from({ length: 4 }).map((_, idx) => (
                        <div key={idx} className="animate-pulse rounded-xl border border-border/40 bg-muted/30 p-4">
                          <div className="h-4 w-32 rounded bg-border/80" />
                          <div className="mt-2 h-3 w-3/4 rounded bg-border/60" />
                        </div>
                      ))}
                    </div>
                  ) : searchError ? (
                    <div className="px-6 py-10 text-center text-sm text-danger">{searchError}</div>
                  ) : searchResults.length === 0 ? (
                    <div className="px-6 py-10 text-center text-sm text-muted-foreground">
                      {searchQuery.trim()
                        ? 'No results matched your search. Try a different keyword.'
                        : 'Type to discover lessons, modules, and vocabulary instantly.'}
                    </div>
                  ) : (
                    <ul className="divide-y divide-border/40" role="list">
                      {searchResults.map((result) => (
                        <li key={result.id}>
                          <button
                            type="button"
                            onClick={() => handleResultSelect(result.href)}
                            className="flex w-full items-start justify-between gap-4 px-6 py-4 text-left transition hover:bg-primary/10"
                          >
                            <div className="min-w-0 flex-1">
                              <div className="flex items-center gap-2">
                                <Badge variant="info" size="xs">
                                  {typeLabels[result.type] || 'Result'}
                                </Badge>
                                <span className="font-medium text-sm text-foreground line-clamp-1">
                                  {result.title}
                                </span>
                              </div>
                              <p className="mt-1 line-clamp-2 text-xs text-muted-foreground">
                                {result.description}
                              </p>
                              {result.snippet ? (
                                <p className="mt-2 line-clamp-1 text-[11px] text-muted-foreground/80">
                                  {result.snippet}
                                </p>
                              ) : null}
                            </div>
                            <Icon name="ArrowUpRight" size={16} className="mt-1 text-muted-foreground/70" />
                          </button>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
              </div>
            </div>
          </Container>
        </div>
      )}

      {/* üî• MAIN HEADER */}
      <header
        ref={headerRef}
        role="banner"
        className={cn(
          'sticky top-0 z-50 w-full backdrop-blur-xl transition-all duration-300 border-b',
          solidHeader
            ? 'bg-lightBg/90 dark:bg-surface/90 border-border/60 shadow-sm'
            : 'bg-transparent border-transparent'
        )}
      >
        {/* Subtle streak bar */}
        {user?.id && (
          <div className="absolute bottom-0 left-0 right-0 h-1 bg-border/40">
            <progress
              value={Math.min(streakState ?? 0, 10)}
              max={10}
              aria-label="Daily streak progress"
              className="block h-1 w-full appearance-none
                [&::-webkit-progress-bar]:bg-transparent
                [&::-webkit-progress-value]:bg-primary
                [&::-moz-progress-bar]:bg-primary"
            />
          </div>
        )}

        <Container>
          <div className="flex h-16 items-center justify-between gap-3">
            {/* Logo */}
            <Link
              href={user?.id ? '/dashboard' : '/'}
              aria-label="Go to GramorX home"
              className="group flex items-center gap-2 transition-transform hover:scale-[1.01]"
            >
              <Image
                src="/brand/logo.png"
                alt="GramorX logo"
                width={36}
                height={36}
                className="rounded-xl"
              />

              <span className="flex flex-col leading-tight">
                <span className="bg-gradient-to-r from-electricBlue to-purpleVibe bg-clip-text font-slab text-base font-bold text-transparent md:text-lg">
                  GramorX
                </span>
                <span className="text-[11px] font-medium uppercase tracking-[0.16em] text-muted-foreground">
                  IELTS Mission Control
                </span>
              </span>

              <Badge
                variant="outline"
                size="sm"
                className="ml-1 border-electricBlue/30 text-electricBlue"
              >
                BETA
              </Badge>
            </Link>

            {/* RIGHT SIDE */}
            <div className="flex items-center gap-2">
              {/* Search button (desktop) */}
              <button
                type="button"
                onClick={() => setShowSearch(true)}
                className="hidden items-center gap-2 rounded-full border border-border/60 bg-surface/80 px-3 py-1.5 text-xs text-muted-foreground shadow-sm hover:border-border focus-visible:ring-2 focus-visible:ring-border md:flex"
              >
                <Icon name="Search" size={14} />
                <span>Search...</span>
                <kbd className="hidden rounded-full border border-border bg-muted px-2 py-[1px] text-[10px] uppercase tracking-wide text-muted-foreground lg:inline-flex">
                  ‚åòK
                </kbd>
              </button>

              {/* Desktop nav */}
              <DesktopNav
                user={user}
                role={role ?? 'guest'}
                ready={ready}
                streak={streakState}
                openModules={openDesktopModules}
                setOpenModules={setOpenDesktopModules}
                modulesRef={modulesRef}
                signOut={signOut}
                className="hidden md:flex"
                showAdmin={false}
                hasPremiumAccess={hasPremiumAccess}
                premiumRooms={premiumRooms}
                onClearPremiumAccess={clearPremium}
                subscriptionTier={subscriptionTier}
              />

              {/* Mobile nav */}
              <MobileNav
                user={
                  user
                    ? {
                        id: user.id,
                        email: user.email ?? null,
                        name:
                          (user.user_metadata as any)?.full_name ??
                          (user.user_metadata as any)?.name ??
                          null,
                        avatarUrl:
                          (user.user_metadata as any)?.avatar_url ??
                          (user.user_metadata as any)?.avatar ??
                          null,
                      }
                    : null
                }
                role={role ?? 'guest'}
                ready={ready}
                streak={streakState ?? 0}
                mobileOpen={mobileOpen}
                setMobileOpen={setMobileOpen}
                mobileModulesOpen={mobileModulesOpen}
                setMobileModulesOpen={setMobileModulesOpen}
                signOut={signOut}
                showAdmin={false}
                className="md:hidden"
                hasPremiumAccess={hasPremiumAccess}
                premiumRooms={premiumRooms}
                onClearPremiumAccess={clearPremium}
                subscriptionTier={subscriptionTier}
              />
            </div>
          </div>
        </Container>
      </header>
    </>
  );
};

export default Header;



===============================
FILE 3 : components\layouts\AppLayoutManager.tsx
===============================
// components/layouts/AppLayoutManager.tsx
import { useCallback, useEffect, useState, useMemo, ReactNode } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/router';
import type { SubscriptionTier } from '@/lib/navigation/types';

import Layout from '@/components/Layout';
import { ImpersonationBanner } from '@/components/admin/ImpersonationBanner';
import SidebarAI from '@/components/ai/SidebarAI';
import AuthAssistant from '@/components/auth/AuthAssistant';
import { Card } from '@/components/design-system/Card';
import { Input } from '@/components/design-system/Input';
import { Textarea } from '@/components/design-system/Textarea';
import { Button } from '@/components/design-system/Button';
import UpgradeModal from '@/components/premium/UpgradeModal';
import { RouteLoadingOverlay } from '@/components/common/RouteLoadingOverlay';
import GlobalPlanGuard from '@/components/GlobalPlanGuard';

import AdminLayout from '@/components/layouts/AdminLayout';
import LearningLayout from '@/components/layouts/LearningLayout';
import CommunityLayout from '@/components/layouts/CommunityLayout';
import MarketplaceLayout from '@/components/layouts/MarketplaceLayout';
import InstitutionsLayout from '@/components/layouts/InstitutionsLayout';
import AuthLayout from '@/components/layouts/AuthLayout';
import ReportsLayout from '@/components/layouts/ReportsLayout';
import ProctoringLayout from '@/components/layouts/ProctoringLayout';
import DashboardLayout from '@/components/layouts/DashboardLayout';
import PublicMarketingLayout from '@/components/layouts/PublicMarketingLayout';
import TeacherLayout from '@/components/layouts/TeacherLayout';
import TeacherProfile from '@/components/teacher/TeacherProfile';
import ProfileLayout from '@/components/layouts/ProfileLayout';
import CommunicationLayout from '@/components/layouts/CommunicationLayout';
import BillingLayout from '@/components/layouts/BillingLayout';
import ResourcesLayout from '@/components/layouts/ResourcesLayout';
import AnalyticsLayout from '@/components/layouts/AnalyticsLayout';
import SupportLayout from '@/components/layouts/SupportLayout';

// ‚≠ê NEW ‚Äî Breadcrumb Bar V2
import { BreadcrumbBar } from '@/components/navigation/BreadcrumbBar';


// -----------------------
// Error Boundary
// -----------------------
const LayoutErrorBoundary: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [hasError, setHasError] = useState(false);

  useEffect(() => {
    const handleError = () => setHasError(true);
    window.addEventListener('error', handleError);
    return () => window.removeEventListener('error', handleError);
  }, []);

  if (hasError) {
    return (
      <Card className="mx-auto max-w-md mt-8">
        <div className="p-4 text-center">
          <h3 className="text-lg font-semibold mb-2">Layout Error</h3>
          <p className="text-sm text-muted-foreground mb-4">
            There was a problem loading this page layout.
          </p>
          <Button onClick={() => window.location.reload()}>
            Reload Page
          </Button>
        </div>
      </Card>
    );
  }

  return <>{children}</>;
};


// -----------------------
// Props
// -----------------------
type AppLayoutManagerProps = {
  children: ReactNode;
  isAuthPage: boolean;
  isProctoringRoute: boolean;
  showLayout: boolean;
  forceLayoutOnAuthPage: boolean;
  isAdminRoute: boolean;
  isInstitutionsRoute: boolean;
  isDashboardRoute: boolean;
  isMarketplaceRoute: boolean;
  isLearningRoute: boolean;
  isCommunityRoute: boolean;
  isReportsRoute: boolean;
  isMarketingRoute: boolean;
  subscriptionTier: SubscriptionTier;
  isRouteLoading: boolean;
  role?: string | null;
  isTeacherApproved?: boolean | null;
  guardFallback: () => ReactNode;

  // ‚≠ê NEW ‚Äî passed from _app.tsx
  showBreadcrumbs?: boolean;
};


// -----------------------
// Teacher Onboarding Gate
// -----------------------
function TeacherOnboardingGate() {
  const router = useRouter();

  const handleSubmit = useCallback(
    (event: React.FormEvent<HTMLFormElement>) => {
      event.preventDefault();
      void router.push('/teacher/register');
    },
    [router]
  );

  return (
    <Card className="mx-auto max-w-2xl" padding="lg" insetBorder>
      <form className="space-y-5" onSubmit={handleSubmit}>
        <div className="space-y-2">
          <p className="text-caption uppercase tracking-[0.12em] text-muted-foreground">
            Teacher onboarding
          </p>
          <h2 className="text-h3 font-semibold text-foreground">Complete your profile</h2>
          <p className="text-small text-muted-foreground">
            Your account is created but not approved yet. Share a quick profile so our team can unlock the teacher workspace for you.
          </p>
        </div>

        <div className="grid gap-4 sm:grid-cols-2">
          <Input name="full-name" label="Full name" placeholder="Your name" autoComplete="name" />
          <Input name="subject" label="Subject / expertise" placeholder="e.g., IELTS Writing" />
        </div>

        <Textarea
          name="experience"
          label="Experience"
          placeholder="Tell us about your IELTS teaching experience"
          rows={4}
        />

        <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <Button type="submit" size="lg">
            Open onboarding form
          </Button>
          <Button asChild variant="link" size="sm">
            <Link href="/teacher/register">Fill it later</Link>
          </Button>
        </div>
      </form>
    </Card>
  );
}


// -----------------------
// Teacher Access Helper
// -----------------------
const useTeacherAccess = (role?: string | null, isTeacherApproved?: boolean | null) => {
  const router = useRouter();
  const isTeacherRoute = router.pathname.startsWith('/teacher');

  const teacherAccess = useMemo(() => {
    const canAccessTeacher = role === 'teacher' || role === 'admin';
    const isApproved = Boolean(isTeacherApproved);

    return {
      canAccessTeacher,
      isApproved,
      shouldRedirect: isTeacherRoute && role && !canAccessTeacher,
      showOnboarding: role === 'teacher' && !isApproved
    };
  }, [role, isTeacherApproved, isTeacherRoute]);

  useEffect(() => {
    if (teacherAccess.shouldRedirect) {
      void router.push('/restricted');
    }
  }, [teacherAccess.shouldRedirect, router]);

  return teacherAccess;
};


// -----------------------
// Layout Config Type
// -----------------------
type LayoutConfig = {
  type: string;
  component: React.ComponentType<{ children: ReactNode; userRole?: string }>;
  guard?: (role?: string | null, isTeacherApproved?: boolean | null) => boolean;
  getContent?: (
    role?: string | null,
    isTeacherApproved?: boolean | null,
    children?: ReactNode,
    guardFallback?: () => ReactNode
  ) => ReactNode;
};


// -----------------------
// MAIN COMPONENT
// -----------------------
export function AppLayoutManager({
  children,
  isAuthPage,
  isProctoringRoute,
  showLayout,
  forceLayoutOnAuthPage,
  isAdminRoute,
  isInstitutionsRoute,
  isDashboardRoute,
  isMarketplaceRoute,
  isLearningRoute,
  isCommunityRoute,
  isReportsRoute,
  isMarketingRoute,
  subscriptionTier,
  isRouteLoading,
  role,
  isTeacherApproved,
  guardFallback,
  showBreadcrumbs,
}: AppLayoutManagerProps) {

  const router = useRouter();
  const pathname = router.pathname;
  const teacherAccess = useTeacherAccess(role, isTeacherApproved);
  const isTeacherRoute = pathname.startsWith('/teacher');
  const teacherAccessRole = role ?? 'guest';


  // -----------------------
  // Teacher Content Switch
  // -----------------------
  const getTeacherContent = useCallback(() => {
    if (role === 'admin') {
      return (
        <TeacherLayout userRole={teacherAccessRole}>
          <TeacherProfile />
        </TeacherLayout>
      );
    }

    if (role === 'teacher') {
      return (
        <TeacherLayout userRole={teacherAccessRole}>
          {teacherAccess.isApproved ? children : <TeacherOnboardingGate />}
        </TeacherLayout>
      );
    }

    return guardFallback();
  }, [role, teacherAccessRole, teacherAccess.isApproved, children, guardFallback]);


  // -----------------------
  // Layout Mapping
  // -----------------------
  const layoutConfigs: LayoutConfig[] = useMemo(
    () => [
      { type: 'admin', component: AdminLayout, guard: () => isAdminRoute },
      { type: 'teacher', component: TeacherLayout, guard: () => isTeacherRoute, getContent: () => getTeacherContent() },
      { type: 'institutions', component: InstitutionsLayout, guard: () => isInstitutionsRoute },
      { type: 'dashboard', component: DashboardLayout, guard: () => isDashboardRoute },
      { type: 'marketplace', component: MarketplaceLayout, guard: () => isMarketplaceRoute },
      { type: 'learning', component: LearningLayout, guard: () => isLearningRoute },
      { type: 'community', component: CommunityLayout, guard: () => isCommunityRoute },
      { type: 'reports', component: ReportsLayout, guard: () => isReportsRoute },
      { type: 'marketing', component: PublicMarketingLayout, guard: () => isMarketingRoute },
      { type: 'profile', component: ProfileLayout, guard: () => pathname.startsWith('/profile') || pathname.startsWith('/user') },
      { type: 'communication', component: CommunicationLayout, guard: () => pathname.startsWith('/messages') || pathname.startsWith('/chat') || pathname.startsWith('/inbox') },
      { type: 'billing', component: BillingLayout, guard: () => pathname.startsWith('/billing') || pathname.startsWith('/payment') || pathname.startsWith('/subscription') },
      { type: 'resources', component: ResourcesLayout, guard: () => pathname.startsWith('/resources') || pathname.startsWith('/library') },
      { type: 'analytics', component: AnalyticsLayout, guard: () => pathname.startsWith('/analytics') || pathname.startsWith('/stats') },
      { type: 'support', component: SupportLayout, guard: () => pathname.startsWith('/support') || pathname.startsWith('/help') },
    ],
    [
      isAdminRoute,
      isTeacherRoute,
      isInstitutionsRoute,
      isDashboardRoute,
      isMarketplaceRoute,
      isLearningRoute,
      isCommunityRoute,
      isReportsRoute,
      isMarketingRoute,
      pathname,
      getTeacherContent,
    ]
  );


  // -----------------------
  // Which Layout Active?
  // -----------------------
  const activeLayout = useMemo(
    () => layoutConfigs.find((config) => config.guard?.(role, isTeacherApproved)) || null,
    [layoutConfigs, role, isTeacherApproved]
  );


  // -----------------------
  // Apply Wrappers
  // -----------------------
  const getNakedContent = (
    auth: boolean,
    proctoring: boolean,
    content: ReactNode
  ) => {
    // For specific auth pages that should be truly naked (no AuthLayout)
    const nakedAuthRoutes = ['/forgot-password', '/update-password'];
    if (nakedAuthRoutes.includes(router.pathname)) {
      return content;
    }
    if (auth) return <AuthLayout>{content}</AuthLayout>;
    if (proctoring) return <ProctoringLayout>{content}</ProctoringLayout>;
    return content;
  };

  const content = useMemo(() => {
    if (!showLayout) {
      return getNakedContent(isAuthPage, isProctoringRoute, children);
    }

    if (activeLayout) {
      if (activeLayout.getContent) {
        return activeLayout.getContent(role, isTeacherApproved, children, guardFallback);
      }

      const LayoutComponent = activeLayout.component;
      return <LayoutComponent userRole={role}>{children}</LayoutComponent>;
    }

    return children;
  }, [
    showLayout,
    isAuthPage,
    isProctoringRoute,
    activeLayout,
    role,
    isTeacherApproved,
    children,
    guardFallback,
  ]);


  // -----------------------
  // Final Layout Wrap
  // -----------------------
  const shouldWrapInMainLayout = forceLayoutOnAuthPage || showLayout;

  return (
    <LayoutErrorBoundary>
      <GlobalPlanGuard />

      {shouldWrapInMainLayout ? (
        <Layout>
          <ImpersonationBanner />
          {showBreadcrumbs && <BreadcrumbBar />}
          {content}
        </Layout>
      ) : (
        <>
          {/* Hide banner on auth pages to prevent extra height */}
          {!isAuthPage && <ImpersonationBanner />}
          {content}
        </>
      )}

      <AuthAssistant />
      <SidebarAI />
      <UpgradeModal />
      <RouteLoadingOverlay active={isRouteLoading} tier={subscriptionTier} />
    </LayoutErrorBoundary>
  );
}

export default AppLayoutManager;



===============================
FILE 4 : pages\_app.tsx
===============================
// pages/_app.tsx
import type { AppProps } from 'next/app';
import { useEffect, useMemo, useState, useCallback } from 'react';
import dynamic from 'next/dynamic';
import { useRouter } from 'next/router';
import { ThemeProvider } from 'next-themes';
import type { AuthChangeEvent, Session, User as SupabaseUser } from '@supabase/supabase-js';
import { Poppins, Roboto_Slab } from 'next/font/google';

import '@/styles/tokens.css';
import '@/styles/semantic.css';
import '@/styles/globals.css';
import '@/styles/themes/index.css';

import 'aos/dist/aos.css';
import { AnimationProvider } from '@/components/providers/AnimationProvider';

import { ToastProvider } from '@/components/design-system/Toaster';
import { NotificationProvider } from '@/components/notifications/NotificationProvider';
import { supabaseBrowser as supabaseClientSource } from '@/lib/supabaseBrowser';
import { env } from '@/lib/env';
import { LocaleProvider, useLocale } from '@/lib/locale';
import { initIdleTimeout } from '@/utils/idleTimeout';
import useRouteGuard from '@/hooks/useRouteGuard';
import { destinationByRole } from '@/lib/routeAccess';
import { refreshClientFlags, flagsHydratedRef } from '@/lib/flags/refresh';
import { InstalledAppProvider } from '@/hooks/useInstalledApp';

import { PremiumThemeProvider } from '@/premium-ui/theme/PremiumThemeProvider';
import AppLayoutManager from '@/components/layouts/AppLayoutManager';

import { UserProvider, useUserContext } from '@/context/UserContext';
import { OrgProvider } from '@/lib/orgs/context';
import { HighContrastProvider } from '@/context/HighContrastContext';

import { loadTranslations } from '@/lib/i18n';
import type { SupportedLocale } from '@/lib/i18n/config';
import type { SubscriptionTier } from '@/lib/navigation/types';
import { getRouteConfig, isAttemptPath } from '@/lib/routes/routeLayoutMap';

// ‚≠ê NEW BreadcrumbBar V2
import { BreadcrumbBar } from '@/components/navigation/BreadcrumbBar';

const PricingReasonBanner = dynamic(
  () => import('@/components/paywall/PricingReasonBanner'),
  { ssr: false }
);

// ---- Safe Supabase getter (works for both factory or instance exports)
function getSupa() {
  const v: any = supabaseClientSource as any;
  return typeof v === 'function' ? v() : v;
}

const poppins = Poppins({
  subsets: ['latin'],
  weight: ['400', '500', '600', '700'],
  display: 'swap',
  variable: '--font-sans',
});
const slab = Roboto_Slab({
  subsets: ['latin'],
  weight: ['400', '600', '700'],
  display: 'swap',
  variable: '--font-display',
});

const IS_CI = process.env.NEXT_PUBLIC_CI === 'true';

// ---------- Skeleton loader ----------
function GuardSkeleton() {
  return (
    <div className="grid min-h-[100dvh] place-items-center">
      <div className="h-6 w-40 animate-pulse rounded bg-border" />
    </div>
  );
}

// ---------- Route type helpers ----------
const isAuthPage = (pathname: string) =>
  /^\/(login|signup|register)(\/|$)/.test(pathname) ||
  /^\/auth\/(login|signup|register|mfa|verify)(\/|$)/.test(pathname) ||
  pathname === '/forgot-password';

const isPremiumRoomRoute = (pathname: string) =>
  pathname.startsWith('/premium/') && !pathname.startsWith('/premium-pin');

// Strict mock/exam attempt runner
const isMockTestsFlowRoute = (pathname: string) => {
  const isMockAttempt = /^\/mock\/[^/]+\/(run|review)(\/|$)/.test(pathname);
  const isWritingAttempt = /^\/writing\/mock\/[^/]+\/(run|review)(\/|$)/.test(pathname);
  return isMockAttempt || isWritingAttempt;
};

// ---------- Auth bridge ----------
function useAuthBridge() {
  const router = useRouter();

  const bridgeSession = useCallback(
    async (event: AuthChangeEvent, sessionNow: Session | null) => {
      const shouldPost =
        event === 'SIGNED_IN' || event === 'SIGNED_OUT' || event === 'TOKEN_REFRESHED';
      if (!shouldPost) return;

      if (event !== 'SIGNED_OUT' && !sessionNow?.access_token) return;

      try {
        await fetch('/api/auth/set-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ event, session: sessionNow }),
        });
      } catch (err) {
        console.error('Failed to bridge auth session:', err);
      }
    },
    []
  );

  useEffect(() => {
    if (IS_CI) return;

    if (typeof window !== 'undefined') {
      if ((window as any).__GX_AUTH_BRIDGE_ACTIVE) return;
      (window as any).__GX_AUTH_BRIDGE_ACTIVE = true;
    }

    let cancelled = false;
    const supa = getSupa();

    // Initial sync
    (async () => {
      const {
        data: { session },
      } = await supa.auth.getSession();
      if (cancelled) return;

      if (session) {
        await bridgeSession('SIGNED_IN', session);
      } else {
        await bridgeSession('SIGNED_OUT', null);
      }

      if (!flagsHydratedRef.current) {
        void refreshClientFlags();
      }

      // Prevent logged-in user from seeing dashboard login/signup
      if (session?.user && isAuthPage(router.pathname)) {
        const url = new URL(window.location.href);
        const next = url.searchParams.get('next');
        const target =
          next && next.startsWith('/')
            ? next
            : destinationByRole(session.user) ?? '/';
        router.replace(target);
      }
    })();

    // Subscribe to auth changes
    const {
      data: { subscription },
    } = supa.auth.onAuthStateChange((event, sessionNow) => {
      (async () => {
        if (cancelled) return;
        await bridgeSession(event, sessionNow);

        if (event === 'SIGNED_IN' && sessionNow?.user) {
          const url = new URL(window.location.href);
          const next = url.searchParams.get('next');
          if (next && next.startsWith('/')) {
            router.replace(next);
          } else if (isAuthPage(router.pathname)) {
            router.replace(destinationByRole(sessionNow.user));
          }
        }

        if (event === 'SIGNED_OUT') {
          if (!['/login', '/signup', '/forgot-password'].includes(router.pathname)) {
            router.replace('/login');
          }
        }
      })();
    });

    return () => {
      cancelled = true;
      subscription?.unsubscribe?.();
      if (typeof window !== 'undefined') {
        (window as any).__GX_AUTH_BRIDGE_ACTIVE = false;
      }
    };
  }, [router, bridgeSession]);
}

// ---------- Route config ----------
function useRouteConfiguration(pathname: string) {
  const { user } = useUserContext();

  return useMemo(() => {
    const routeConfig = getRouteConfig(pathname);

    const derivedIsAuth = routeConfig.layout === 'auth' || isAuthPage(pathname);
    const isAttempt = isAttemptPath(pathname);

    const isNoChromeRoute =
      derivedIsAuth ||
      routeConfig.layout === 'proctoring' ||
      pathname.startsWith('/premium') ||
      /\/focus-mode(\/|$)/.test(pathname) ||
      routeConfig.showChrome === false ||
      isAttempt ||
      isMockTestsFlowRoute(pathname);

    const showLayout = !pathname.startsWith('/premium') && !isNoChromeRoute;

    return {
      isAuthPage: derivedIsAuth,
      isProctoringRoute: routeConfig.layout === 'proctoring',
      showLayout,
      forceLayoutOnAuthPage: derivedIsAuth && !!user,
      isAdminRoute: routeConfig.layout === 'admin',
      isInstitutionsRoute: routeConfig.layout === 'institutions',
      isDashboardRoute:
        routeConfig.layout === 'dashboard' ||
        routeConfig.layout === 'profile' ||
        routeConfig.layout === 'billing' ||
        routeConfig.layout === 'analytics',
      isMarketplaceRoute: routeConfig.layout === 'marketplace',
      isLearningRoute:
        routeConfig.layout === 'learning' || routeConfig.layout === 'resources',
      isCommunityRoute:
        routeConfig.layout === 'community' || routeConfig.layout === 'communication',
      isReportsRoute: routeConfig.layout === 'reports',
      isMarketingRoute:
        routeConfig.layout === 'marketing' || routeConfig.layout === 'support',
      needPremium: pathname.startsWith('/premium'),
      isPremiumRoute: isPremiumRoomRoute(pathname),
      routeConfig,
      isNoChromeRoute,
    };
  }, [pathname, user]);
}

// ---------- Access checks ----------
function useRouteAccessCheck(pathname: string, role?: string | null) {
  const router = useRouter();

  useEffect(() => {
    const config = getRouteConfig(pathname);
    if (!config.requiresAuth) return;
    if (!role) {
      router.replace('/login');
      return;
    }
    if (config.allowedRoles && !config.allowedRoles.includes(role)) {
      router.replace('/restricted');
    }
  }, [pathname, role, router]);
}

// ---------- Inner app ----------
function InnerApp({ Component, pageProps }: AppProps) {
  const router = useRouter();
  const pathname = router.pathname;
  const { locale: activeLocale } = useLocale();

  useAuthBridge();

  // i18n
  useEffect(() => {
    void loadTranslations(activeLocale as SupportedLocale);
  }, [activeLocale]);

  // route analytics (stub)
  useEffect(() => {
    const log = (url: string) => {};
    log(router.asPath);
    router.events.on('routeChangeComplete', log);
    return () => router.events.off('routeChangeComplete', log);
  }, [router]);

  const { user, role, isTeacherApproved } = useUserContext() as {
    user: SupabaseUser | null;
    role?: string | null;
    isTeacherApproved?: boolean | null;
  };

  const [subscriptionTier, setSubscriptionTier] = useState<SubscriptionTier>('free');

  // tier detect
  useEffect(() => {
    const metadata = (user?.user_metadata ?? {}) as { tier?: SubscriptionTier | null };
    const appMeta = (user?.app_metadata ?? {}) as { tier?: SubscriptionTier | null };
    setSubscriptionTier(metadata.tier ?? appMeta.tier ?? 'free');
  }, [user]);

  useEffect(() => {
    const handler = (event: Event) => {
      const detail = (event as CustomEvent<{ tier?: SubscriptionTier }>).detail;
      if (detail?.tier) setSubscriptionTier(detail.tier);
    };
    window.addEventListener('subscription:tier-updated', handler);
    return () => window.removeEventListener('subscription:tier-updated', handler);
  }, []);

  // route config
  const routeConfiguration = useRouteConfiguration(pathname);
  const forceLayoutOnAuthPage = routeConfiguration.isAuthPage && !!user;

  // access guard
  useRouteAccessCheck(pathname, role);

  // teacher redirect
  useEffect(() => {
    if (!role) return;
    if (role === 'teacher') {
      const onTeacherArea =
        pathname.startsWith('/teacher') || routeConfiguration.isAuthPage;
      if (!onTeacherArea) router.replace('/teacher');
    }
  }, [role, pathname, routeConfiguration.isAuthPage, router]);

  // idle timeout
  const idleMinutes = useMemo(() => {
    try {
      const val =
        env?.NEXT_PUBLIC_IDLE_TIMEOUT_MINUTES ??
        process.env.NEXT_PUBLIC_IDLE_TIMEOUT_MINUTES ??
        '30';
      return Number(val) || 30;
    } catch {
      return 30;
    }
  }, []);

  useEffect(() => {
    if (IS_CI) return;
    const cleanup = initIdleTimeout(idleMinutes);
    return cleanup;
  }, [idleMinutes]);

  const { isChecking } = useRouteGuard();
  if (isChecking) return <GuardSkeleton />;

  // base page
  const basePage =
    routeConfiguration.needPremium || routeConfiguration.isPremiumRoute ? (
      <PremiumThemeProvider>
        <Component {...pageProps} key={router.asPath} />
      </PremiumThemeProvider>
    ) : (
      <Component {...pageProps} key={router.asPath} />
    );

  // ‚≠ê Decide when to show breadcrumb bar
  const showBreadcrumbs =
    !routeConfiguration.isAuthPage &&
    !routeConfiguration.isProctoringRoute &&
    !routeConfiguration.isPremiumRoute &&
    !isMockTestsFlowRoute(pathname) &&
    !pathname.includes('/run') &&
    !pathname.includes('/review') &&
    !routeConfiguration.isNoChromeRoute;

  return (
    <ThemeProvider attribute="class" defaultTheme="light" enableSystem={false}>
      <HighContrastProvider>
        <div
          className={`${poppins.className} ${slab.className}
          min-h-screen min-h-[100dvh] bg-background text-foreground antialiased`}
        >
          <AnimationProvider>
            <AppLayoutManager
              isAuthPage={routeConfiguration.isAuthPage}
              isProctoringRoute={routeConfiguration.isProctoringRoute}
              showLayout={routeConfiguration.showLayout}
              forceLayoutOnAuthPage={forceLayoutOnAuthPage}
              isAdminRoute={routeConfiguration.isAdminRoute}
              isInstitutionsRoute={routeConfiguration.isInstitutionsRoute}
              isDashboardRoute={routeConfiguration.isDashboardRoute}
              isMarketplaceRoute={routeConfiguration.isMarketplaceRoute}
              isLearningRoute={routeConfiguration.isLearningRoute}
              isCommunityRoute={routeConfiguration.isCommunityRoute}
              isReportsRoute={routeConfiguration.isReportsRoute}
              isMarketingRoute={routeConfiguration.isMarketingRoute}
              subscriptionTier={subscriptionTier}
              role={role}
              isTeacherApproved={isTeacherApproved}
              guardFallback={() => <GuardSkeleton />}

              // ‚≠ê SEND TO LAYOUT MANAGER
              showBreadcrumbs={showBreadcrumbs}
            >
              {(router.pathname === '/pricing' ||
                router.pathname === '/pricing/overview') && (
                <PricingReasonBanner />
              )}

              {basePage}
            </AppLayoutManager>
          </AnimationProvider>
        </div>
      </HighContrastProvider>
    </ThemeProvider>
  );
}

// ---------- outer wrapper ----------
export default function App(props: AppProps) {
  return (
    <LocaleProvider initialLocale="en">
      <ToastProvider>
        <NotificationProvider>
          <UserProvider>
            <OrgProvider>
              <InstalledAppProvider>
                <InnerApp {...props} />
              </InstalledAppProvider>
            </OrgProvider>
          </UserProvider>
        </NotificationProvider>
      </ToastProvider>
    </LocaleProvider>
  );
}



===============================
FILE 5 : lib\auth\session.ts
===============================
import { supabaseBrowser } from '@/lib/supabaseBrowser';
import type { SubscriptionTier } from '@/lib/navigation/types';
import type { PlanId } from '@/types/pricing';

type WaitOptions = {
  attempts?: number;
  intervalMs?: number;
};

type UpgradeResult = {
  tier: SubscriptionTier;
  role: string | null;
  planId: PlanId;
};

const tierToPlan: Record<SubscriptionTier, PlanId> = {
  free: 'free',
  seedling: 'starter',
  rocket: 'booster',
  owl: 'master',
};

function delay(ms: number) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

async function syncSessionCookie(session?: {
  access_token: string;
  refresh_token?: string | null;
  expires_in?: number | null;
  expires_at?: number | null;
}) {
  if (!session) return;

  try {
    await fetch('/api/auth/set-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({
        event: 'TOKEN_REFRESHED',
        session: {
          access_token: session.access_token,
          refresh_token: session.refresh_token ?? undefined,
          expires_in: session.expires_in ?? undefined,
          expires_at: session.expires_at ?? undefined,
        },
      }),
    });
  } catch (error) {
    console.warn('Failed to sync session cookie after refresh:', error);
  }
}

export async function waitForSubscriptionUpgrade({
  attempts = 4,
  intervalMs = 2000,
}: WaitOptions = {}): Promise<UpgradeResult | null> {
  if (typeof window === 'undefined') return null;

  const supabase = supabaseBrowser;
  const {
    data: { session },
  } = await supabase.auth.getSession();

  const userId = session?.user?.id;
  if (!userId) {
    console.warn('Cannot refresh subscription tier without an authenticated user.');
    return null;
  }

  for (let attempt = 0; attempt < attempts; attempt += 1) {
    if (attempt > 0) await delay(intervalMs);

    try {
      const { data, error } = await supabase.auth.refreshSession();
      if (!error && data?.session?.access_token) {
        await syncSessionCookie(data.session);
      }
    } catch (error) {
      console.warn('Supabase refreshSession failed while checking upgrade status:', error);
    }

    try {
      const { data, error } = await supabase
        .from('profiles')
        .select('tier, role')
        .eq('id', userId)
        .maybeSingle();

      if (error) {
        console.warn('Failed to load profile while checking upgrade status:', error);
        continue;
      }

      const tier = (data?.tier as SubscriptionTier | undefined) ?? 'free';
      const role = typeof data?.role === 'string' ? data.role : null;

      if (tier !== 'free') {
        const planId = tierToPlan[tier];
        const detail: UpgradeResult = { tier, role, planId };
        window.dispatchEvent(new CustomEvent('subscription:tier-updated', { detail }));
        return detail;
      }
    } catch (error) {
      console.warn('Error while polling for subscription upgrade:', error);
    }
  }

  return null;
}




===============================
FILE 6 : lib\supabaseBrowser.ts
===============================
// lib/supabaseBrowser.ts
import { createClient, type SupabaseClient } from '@supabase/supabase-js';

import type { Database } from '@/types/supabase';

const url = process.env.NEXT_PUBLIC_SUPABASE_URL;
const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
const isConfigured = Boolean(url && anon);

if (!isConfigured) {
  const message =
    'Supabase environment variables are not configured. Falling back to a disabled client.';
  if (typeof console !== 'undefined') {
    // eslint-disable-next-line no-console -- surfaced once to aid debugging in non-configured envs
    console.warn(message);
  }
}

type GlobalWithSupabase = typeof globalThis & {
  __supabaseBrowser?: SupabaseClient<Database>;
};

const globalScope = globalThis as GlobalWithSupabase;
const isTestEnv =
  typeof process !== 'undefined' &&
  (process.env.NODE_ENV === 'test' || process.env.VITEST || process.env.JEST_WORKER_ID);

const shouldCacheClient = typeof window !== 'undefined' && !isTestEnv;

const FALLBACK_URL = 'https://app.supabase.invalid';
const FALLBACK_ANON_KEY = 'public-anon-key-placeholder';

const noopFetch: typeof fetch = async () =>
  new Response(
    JSON.stringify({ error: 'Supabase client disabled: missing environment variables.' }),
    {
      status: 503,
      headers: { 'Content-Type': 'application/json' },
    }
  );

const createSupabaseBrowserClient = () =>
  createClient<Database>(isConfigured ? url! : FALLBACK_URL, isConfigured ? anon! : FALLBACK_ANON_KEY, {
    auth: {
      flowType: 'pkce',
      autoRefreshToken: false,      // ‚úÖ disable auto-refresh ‚Äì errors will stop
      detectSessionInUrl: true,
      persistSession: true,
    },
    ...(isConfigured ? {} : { global: { fetch: noopFetch } }),
  });

export const supabaseBrowser: SupabaseClient<Database> =
  shouldCacheClient && globalScope.__supabaseBrowser
    ? globalScope.__supabaseBrowser
    : createSupabaseBrowserClient();

if (shouldCacheClient) {
  globalScope.__supabaseBrowser = supabaseBrowser;
}

export const authHeaders = async (extra: Record<string, string> = {}) => {
  const {
    data: { session },
  } = await supabaseBrowser.auth.getSession();

  const token = session?.access_token;
  if (!token) return { ...extra };

  return { ...extra, Authorization: `Bearer ${token}` };
};



===============================
FILE 7 : hooks\useUser.ts
===============================
// hooks/useUser.ts
import { useEffect, useState } from 'react';
import type { User } from '@supabase/supabase-js';
import { supabaseBrowser } from '@/lib/supabaseBrowser';

/**
 * Client-only: reads the current user once on mount.
 * (Auth event bridging is handled in _app.tsx per your rules.)
 */
export function useUser() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const supabase = supabaseBrowser; // ‚úÖ fixed: no parentheses
    let cancelled = false;

    supabase.auth.getUser().then(({ data: { user } }) => {
      if (!cancelled) {
        setUser(user ?? null);
        setLoading(false);
      }
    });

    return () => {
      cancelled = true;
    };
  }, []);

  return { user, loading, isAuthed: !!user, userId: user?.id ?? null };
}



===============================
FILE 8 : pages\dashboard\index.tsx
===============================
import { useMemo, useState } from 'react';
import type { GetServerSideProps } from 'next';
import { useRouter } from 'next/router';
import DashboardLayout from '@/components/layouts/DashboardLayout';
import { getServerClient } from '@/lib/supabaseServer';
import { Button } from '@/components/design-system/Button';
import { type OnboardingPayload, type StudyPlan, onboardingPayloadSchema } from '@/lib/onboarding/aiStudyPlan';

type OnboardingRecord = {
  target_band: number;
  exam_date: string;
  reading_level: number;
  writing_level: number;
  listening_level: number;
  speaking_level: number;
  learning_style: OnboardingPayload['learningStyle'];
  generated_plan: StudyPlan | null;
};

interface DashboardProps {
  userEmail: string;
  onboarding: OnboardingRecord;
}

export default function Dashboard({ userEmail, onboarding }: DashboardProps) {
  const router = useRouter();
  const [isReplanning, setIsReplanning] = useState(false);
  const studyPlan = onboarding.generated_plan;

  const firstTask = useMemo(() => studyPlan?.weekly_plan?.[0]?.tasks?.[0] ?? 'Complete your first diagnostic task.', [studyPlan]);

  const skillMeters = [
    { label: 'Reading', value: onboarding.reading_level },
    { label: 'Writing', value: onboarding.writing_level },
    { label: 'Listening', value: onboarding.listening_level },
    { label: 'Speaking', value: onboarding.speaking_level },
  ];

  const handleReadjust = async () => {
    setIsReplanning(true);
    try {
      const payload: OnboardingPayload = {
        targetBand: onboarding.target_band,
        examDate: onboarding.exam_date,
        readingLevel: onboarding.reading_level,
        writingLevel: onboarding.writing_level,
        listeningLevel: onboarding.listening_level,
        speakingLevel: onboarding.speaking_level,
        learningStyle: onboarding.learning_style,
      };

      const validation = onboardingPayloadSchema.safeParse(payload);
      if (!validation.success) {
        throw new Error('Invalid saved onboarding data.');
      }

      const response = await fetch('/api/ai/generate-plan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        throw new Error('Unable to re-adjust plan right now.');
      }

      await router.replace('/dashboard');
    } catch (error) {
      console.error(error);
      alert(error instanceof Error ? error.message : 'Failed to re-adjust plan.');
    } finally {
      setIsReplanning(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="mx-auto max-w-6xl space-y-6 px-4 py-8">
        <header className="rounded-xl border bg-white p-6">
          <p className="text-sm text-gray-500">{userEmail}</p>
          <h1 className="text-3xl font-bold">Your AI Study Plan is Ready</h1>
          <p className="mt-2 text-gray-600">Priority skill: {studyPlan?.priority_skill ?? 'N/A'}</p>
        </header>

        <section className="rounded-xl border bg-white p-6">
          <h2 className="mb-3 text-xl font-semibold">Timeline Strip</h2>
          <div className="flex gap-3 overflow-x-auto pb-2">
            {studyPlan?.weekly_plan?.map((item) => (
              <article key={item.week} className="min-w-56 rounded-lg border bg-gray-50 p-3">
                <p className="text-xs text-gray-500">Week {item.week}</p>
                <p className="font-semibold">{item.focus}</p>
              </article>
            ))}
          </div>
        </section>

        <section className="grid gap-6 md:grid-cols-2">
          <article className="rounded-xl border bg-white p-6">
            <h3 className="text-lg font-semibold">Today&apos;s Task</h3>
            <p className="mt-3 text-gray-700">{firstTask}</p>
            <Button className="mt-5" onClick={() => router.push('/practice')}>
              Start First Lesson
            </Button>
          </article>

          <article className="rounded-xl border bg-white p-6">
            <h3 className="mb-4 text-lg font-semibold">Skill Progress Meters</h3>
            <div className="space-y-3">
              {skillMeters.map((skill) => (
                <div key={skill.label}>
                  <div className="mb-1 flex justify-between text-sm">
                    <span>{skill.label}</span>
                    <span>{skill.value}/5</span>
                  </div>
                  <div className="h-2 rounded-full bg-gray-200">
                    <div className="h-2 rounded-full bg-blue-600" style={{ width: `${(skill.value / 5) * 100}%` }} />
                  </div>
                </div>
              ))}
            </div>
          </article>
        </section>

        <div>
          <Button variant="outline" onClick={handleReadjust} disabled={isReplanning}>
            {isReplanning ? 'Re-adjusting‚Ä¶' : 'AI Re-adjust Plan'}
          </Button>
        </div>
      </div>
    </DashboardLayout>
  );
}

export const getServerSideProps: GetServerSideProps<DashboardProps> = async (context) => {
  const supabase = getServerClient(context);
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return { redirect: { destination: '/login?next=/dashboard', permanent: false } };
  }

  const { data: onboarding } = await supabase
    .from('user_onboarding')
    .select(
      'target_band,exam_date,reading_level,writing_level,listening_level,speaking_level,learning_style,generated_plan',
    )
    .eq('user_id', user.id)
    .maybeSingle();

  if (!onboarding) {
    return { redirect: { destination: '/onboarding', permanent: false } };
  }

  return {
    props: {
      userEmail: user.email ?? 'Learner',
      onboarding: onboarding as OnboardingRecord,
    },
  };
};


